<!DOCTYPE HTML>
<html><head>
<meta http-equiv="Cache-Control" content="max-age=7200" />

<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="wumiiVerification" content="1747c9bc-e905-45aa-88ac-f13f2b210015" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<title>关于SESSION的理解 | 皓眸IT</title>
<meta name="author" content="Chale Cao">

<meta name="description" content="SESSION简介积土成山，积水成渊。今天和同事讨论了一下这个，突然感觉概念有点模糊，特地记录一下。这个SESSION是WEB开发中常用的东东，一定要概念清晰。本文大部分内容来自网络结合自己的理解，如有雷同，不是巧合。">


<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

<meta property="og:title" content="关于SESSION的理解"/>
<meta property="og:site_name" content="皓眸IT"/>

<!--[if IE]><style>.testIE.IE{display:inline;}</style><![endif]-->
<!--[if lte IE 7]><link rel="stylesheet" href="/css/ie7.css" type="text/css">
<![endif]-->
<!--[if (lt IE 9)&(gt IE 7)]><style>.testIE.IE8{display:inline;}</style><![endif]-->
<!--[if gt IE 8]><style>.testIE.IE9{display:inline;}</style><![endif]-->


<link href="/favicon.png" rel="icon">
<link rel="alternate" href="/atom.xml" title="皓眸IT Feed" type="application/atom+xml">

<link rel="stylesheet" href="http://cdn.bootcss.com/twitter-bootstrap/3.1.0/css/bootstrap.min.css" type="text/css">
<link rel="stylesheet" href="http://libs.baidu.com/fontawesome/4.0.3/css/font-awesome.min.css" type="text/css">
<link rel="stylesheet" href="http://cdn.bootcss.com/prettify/r298/prettify.min.css" type="text/css">
<link rel="stylesheet" href="http://cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.min.css" type="text/css">

<link rel="stylesheet" href="/css/style.css" type="text/css">

<link rel="stylesheet" href="/css/nprogress.css" type="text/css">

<!--[if lt IE 9]>
   <style>article,aside,dialog,footer,header,section,footer,nav,figure,menu{display:block}</style>
   <script src="http://cdn.staticfile.org/html5shiv/r29/html5.min.js"></script>
   <script src="http://cdn.bootcss.com/respond.js/1.4.2/respond.min.js"></script>
<link href="http://cdn.bootcss.com/respond.js/1.4.2/respond-proxy.html" id="respond-proxy" rel="respond-proxy" />
<link href="/js/respond.proxy.gif" id="respond-redirect" rel="respond-redirect" />
<script src="/js/respond.proxy.js"></script>
   <script src="http://cdn.bootcss.com/selectivizr/1.0.2/selectivizr-min.js"></script>
<![endif]-->
<script type="text/javascript">var site = {BASE_URI: '/'};var _js2load = [];</script>

</head>
<body>
  
  <header id="header" class="hm-menu-left-container"><nav id="main-nav" class="navbar navbar-default hm-navbar-menu-left  " role="navigation">
    <div class="hm-navbar-header">
    <a href="http://haomou.net" ><img class="hm-logo" src="/images/haomou.png" title="皓眸IT" width="64" height="64" /></a>
    <br/>|<br/><span class="fa fa-tint hm-black shine_blue" ></span><br/>|<br/><span class="fa fa-heart hm-black shine_red" ></span><br/>|<br/>
        <i class="fa fa-bars fa-2x hm-black hm-menu shine_blue" ></i><br/><div class="hm-line"></div>
    </div>
    <div class="collapse navbar-collapse">
      <h1 style="color:black">皓眸IT</h1>
      <ul class="nav navbar-nav hm-left-nav">
  
        <li item='2014/08/07/2014_session/' class='active'><a href="/" title="首页">首页</a></li>      
      <li class='dropdown'>
        <a class='dropdown-toggle' data-toggle='dropdown' href='#'>关于我<b class='caret'></b></a>
        <ul class='dropdown-menu'>
    
          <li><a href="http://home.ustc.edu.cn/~chh1990/chero/chero.html" title="个人主页">个人主页</a></li>    
        </ul>
      </li>
    
      <li class='dropdown'>
        <a class='dropdown-toggle' data-toggle='dropdown' href='#'>创业项目<b class='caret'></b></a>
        <ul class='dropdown-menu'>
    
          <li><a href="http://pictcake.cn" title="照片蛋糕">照片蛋糕</a></li>    
        </ul>
      </li>
    
      </ul>

        
        <div id="widget_category" class="widget hm-left-widget">
            <div class="panel-heading">分类：</div>            <div data-src='category' class='ajax_widgets'>正在加载...</div>
        </div>
        
        <div id="widget_tagcloud" class="widget hm-left-widget">
            <div class="panel-heading">标签云：</div>            <div data-src='tagcloud' class='ajax_widgets'>正在加载...</div>        </div>
        


      <ul class="nav navbar-nav navbar-right">
      
        <li><a href="/atom.xml">RSS</a></li>
      
      
      
      
      
        <li><a href="https://github.com/chalecao">github</a></li>
      
      </ul>
    </div>
</nav>
<div class="clearfix"></div></header>
  <div style="" id="headflash" class="headflash hm_container"><embed pluginspage="http://www.macromedia.com/go/getflashplayer" type="application/x-shockwave-flash" src="/images/bck.swf" width="100%" height="313" style="undefined" id="headflash_f" name="headflash_f" bgcolor="#000" quality="high" allowscriptaccess="false" wmode="transparent" allowfullscreen="false"></div>
  <div id='content' class=" container">
     <div class="page-header-wrapper">
      <!--[if lt IE 9]><div class="alert alert-warning alert-dismissable"><button type="button" class="close" data-dismiss="alert" aria-hidden="true">&times;</button><strong>提示:</strong>您的浏览器版本太低了,建议升级到 <strong><a href="http://windows.microsoft.com/zh-cn/internet-explorer/download-ie" title="IE9">IE9</a></strong> 以上,本站使用<a href="https://www.google.com/intl/zh-CN/chrome/">Chrome浏览器</a>可以获得最好的显示效果.</div><![endif]-->
      <div class="page-header"><h1>皓眸IT <small>写清楚，说明白</small></h1></div>
     </div>
     <div class="row">
       <div id="main-col" class="alignleft col-sx-12 col-sm-8 col-md-9 col-lg-9">
      <section id='header_widget'></section>
          <div id="wrapper"><article class="hm-article">
<div id="post" class="post well">
  <div class="post-content">
    <header class="well-sm">
      <i class="fa icon fa-5x pull-left hm-article-w"></i>
      <h1 class="title">关于SESSION的理解</h1>
      
        <span class="hm-article-w hm-article-w-h0">发表于<br/><time datetime="2014-08-07T10:40:49.000Z"> <a href="/2014/08/07/2014_session/">Aug 7 2014</a></time></span>      
    </header>
    
    <section id='before_content_widget'></section>
    <div class="entry"  data-spy="scroll" data-target="#toc" >
      
        <h3 id="SESSION简介">SESSION简介</h3>
<p>积土成山，积水成渊。今天和同事讨论了一下这个，突然感觉概念有点模糊，特地记录一下。这个SESSION是WEB开发中常用的东东，一定要概念清晰。本文大部分内容来自网络结合自己的理解，如有雷同，不是巧合。<br><a id="more"></a></p>
<h3 id="作者">作者</h3>
<p><img alt="皓眸GEEK" src="/images/hm.jpg" width="150" height="200"><br>Chale Cao（曹欢欢），自由工程师，热爱研究学习感兴趣领域<br>毕业于中国科学技术大学，硕士研究生。单身，喜欢真诚，善良的女孩子。<br>擅长：JAVA，PHP，C#，JS，WebGL，WebRTC …<br>Mail To: chh1990@mail.ustc.edu.cn<br>WebSite：<a href="http://www.haomou.net" target="_blank" rel="external">http://www.haomou.net</a></p>
<p>转载请注明出处：<a href="http://www.haomou.net/2014/08/07/2014_session/" target="_blank" rel="external">http://www.haomou.net/2014/08/07/2014_session/</a></p>
<h3 id="Session是什么">Session是什么</h3>
<p> Session一般译作会话，牛津词典对其的解释是进行某活动连续的一段时间。从不同的层面看待session，它有着类似但不全然相同的含义。比如，在web应用的用户看来，他打开浏览器访问一个电子商务网站，登录、并完成购物直到关闭浏览器，这是一个会话。而在web应用的开发者开来，用户登录时我需要创建一个数据结构以存储用户的登录信息，这个结构也叫做session。因此在谈论session的时候要注意上下文环境。而本文谈论的是一种基于HTTP协议的用以增强web应用能力的机制或者说一种方案，它不是单指某种特定的动态页面技术，而这种能力就是保持状态，也可以称作保持会话。</p>
<h3 id="为什么需要session">为什么需要session</h3>
<p>谈及session一般是在web应用的背景之下，我们知道web应用是基于HTTP协议的，而HTTP协议恰恰是一种无状态协议。也就是说，用户从A页面跳转到B页面会重新发送一次HTTP请求，而服务端在返回响应的时候是无法获知该用户在请求B页面之前做了什么的。</p>
<pre><code>对于HTTP的无状态性的原因，相关RFC里并没有解释，但联系到HTTP的历史以及应用场景，我们可以推测出一些理由：
</code></pre><ol>
<li>设计HTTP最初的目的是为了提供一种发布和接收HTML页面的方法。那个时候没有动态页面技术，只有纯粹的静态HTML页面，因此根本不需要协议能保持状态；</li>
<li>用户在收到响应时，往往要花一些时间来阅读页面，因此如果保持客户端和服务端之间的连接，那么这个连接在大多数的时间里都将是空闲的，这是一种资源的无端浪费。所以HTTP原始的设计是默认短连接，即客户端和服务端完成一次请求和响应之后就断开TCP连接，服务器因此无法预知客户端的下一个动作，它甚至都不知道这个用户会不会再次访问，因此让HTTP协议来维护用户的访问状态也全然没有必要；</li>
<li>将一部分复杂性转嫁到以HTTP协议为基础的技术之上可以使得HTTP在协议这个层面上显得相对简单，而这种简单也赋予了HTTP更强的扩展能力。事实上，session技术从本质上来讲也是对HTTP协议的一种扩展。<br>总而言之，HTTP的无状态是由其历史使命而决定的。但随着网络技术的蓬勃发展，人们再也不满足于死板乏味的静态HTML，他们希望web应用能动起来，于是客户端出现了脚本和DOM技术，HTML里增加了表单，而服务端出现了CGI等等动态技术。</li>
</ol>
<p>而正是这种web动态化的需求，给HTTP协议提出了一个难题：一个无状态的协议怎样才能关联两次连续的请求呢？也就是说无状态的协议怎样才能满足有状态的需求呢？</p>
<p>此时有状态是必然趋势而协议的无状态性也是木已成舟，因此我们需要一些方案来解决这个矛盾，来保持HTTP连接状态，于是出现了cookie和session。</p>
<p>对于此部分内容，读者或许会有一些疑问，笔者在此先谈两点：</p>
<ol>
<li>无状态性和长连接<br>可能有人会问，现在被广泛使用的HTTP1.1默认使用长连接，它还是无状态的吗？<br>连接方式和有无状态是完全没有关系的两回事。因为状态从某种意义上来讲就是数据，而连接方式只是决定了数据的传输方式，而不能决定数据。长连接是随着计算机性能的提高和网络环境的改善所采取的一种合理的性能上的优化，一般情况下，web服务器会对长连接的数量进行限制，以免资源的过度消耗。</li>
<li><p>无状态性和session<br>   Session是有状态的，而HTTP协议是无状态的，二者是否矛盾呢？</p>
<p>Session和HTTP协议属于不同层面的事物，后者属于ISO七层模型的最高层应用层，前者不属于后者，前者是具体的动态页面技术来实现的，但同时它又是基于后者的。在下文中笔者会分析Servlet/Jsp技术中的session机制，这会使你对此有更深刻的理解。</p>
</li>
</ol>
<h3 id="Cookie和Session">Cookie和Session</h3>
<p> 上面提到解决HTTP协议自身无状态的方式有cookie和session。二者都能记录状态，前者是将状态数据保存在客户端，后者则保存在服务端。</p>
<pre><code>首先看一下cookie的工作原理，这需要有基本的HTTP协议基础。
</code></pre><p>cookie是在RFC2109（已废弃，被RFC2965取代）里初次被描述的，每个客户端最多保持三百个cookie，每个域名下最多20个Cookie（实际上一般浏览器现在都比这个多，如Firefox是50个），而每个cookie的大小为最多4K，不过不同的浏览器都有各自的实现。对于cookie的使用，最重要的就是要控制cookie的大小，不要放入无用的信息，也不要放入过多信息。</p>
<pre><code>无论使用何种服务端技术，只要发送回的HTTP响应中包含如下形式的头，则视为服务器要求设置一个cookie：
</code></pre><p>Set-cookie:name=name;expires=date;path=path;domain=domain</p>
<pre><code>支持cookie的浏览器都会对此作出反应，即创建cookie文件并保存（也可能是内存cookie），用户以后在每次发出请求时，浏览器都要判断当前所有的cookie中有没有没失效（根据expires属性判断）并且匹配了path属性的cookie信息，如果有的话，会以下面的形式加入到请求头中发回服务端：

Cookie: name=<span class="string">"zj"</span>; <span class="keyword">Path</span>=<span class="string">"/linkage"</span>

服务端的动态脚本会对其进行分析，并做出相应的处理，当然也可以选择直接忽略。

这里牵扯到一个规范（或协议）与实现的问题，简单来讲就是规范规定了做成什么样子，那么实现就必须依据规范来做，这样才能互相兼容，但是各个实现所使用的方式却不受约束，也可以在实现了规范的基础上超出规范，这就称之为扩展了。无论哪种浏览器，只要想提供cookie的功能，那就必须依照相应的RFC规范来实现。所以这里服务器只管发<span class="keyword">Set</span>-cookie头域，这也是HTTP协议无状态性的一种体现。
</code></pre><p>需要注意的是，出于安全性的考虑，cookie可以被浏览器禁用。</p>
<pre><code>再看一下session的原理：

笔者没有找到相关的RFC，因为session本就不是协议层面的事物。它的基本原理是服务端为每一个session维护一份会话信息数据，而客户端和服务端依靠一个全局唯一的标识来访问会话信息数据。用户访问web应用时，服务端程序决定何时创建session，创建session可以概括为三个步骤：
</code></pre><ol>
<li>生成全局唯一标识符（sessionid）；</li>
<li>开辟数据存储空间。一般会在内存中创建相应的数据结构，但这种情况下，系统一旦掉电，所有的会话数据就会丢失，如果是电子商务网站，这种事故会造成严重的后果。不过也可以写到文件里甚至存储在数据库中，这样虽然会增加I/O开销，但session可以实现某种程度的持久化，而且更有利于session的共享；</li>
<li><p>将session的全局唯一标示符发送给客户端。<br>问题的关键就在服务端如何发送这个session的唯一标识上。联系到HTTP协议，数据无非可以放到请求行、头域或Body里，基于此，一般来说会有两种常用的方式：cookie和URL重写。</p>
</li>
<li><p>Cookie<br>读者应该想到了，对，服务端只要设置Set-cookie头就可以将session的标识符传送到客户端，而客户端此后的每一次请求都会带上这个标识符，由于cookie可以设置失效时间，所以一般包含session信息的cookie会设置失效时间为0，即浏览器进程有效时间。至于浏览器怎么处理这个0，每个浏览器都有自己的方案，但差别都不会太大（一般体现在新建浏览器窗口的时候）；</p>
</li>
<li><p>URL重写<br>所谓URL重写，顾名思义就是重写URL。试想，在返回用户请求的页面之前，将页面内所有的URL后面全部以get参数的方式加上session标识符（或者加在path info部分等等），这样用户在收到响应之后，无论点击哪个链接或提交表单，都会在再带上session的标识符，从而就实现了会话的保持。读者可能会觉得这种做法比较麻烦，确实是这样，但是，如果客户端禁用了cookie的话，URL重写将会是首选。<br>到这里，读者应该明白我前面为什么说session也算作是对HTTP的一种扩展了吧。如下两幅图是笔者在Firefox的Firebug插件中的截图，可以看到，当我第一次访问index.jsp时，响应头里包含了Set-cookie头，而请求头中没有。当我再次刷新页面时，图二显示在响应中不在有Set-cookie头，而在请求头中却有了Cookie头。注意一下Cookie的名字：jsessionid，顾名思义，就是session的标识符，另外可以看到两幅图中的jsessionid的值是相同的，原因笔者就不再多解释了。另外读者可能在一些网站上见过在最后附加了一段形如jsessionid=xxx的URL，这就是采用URL重写来实现的session。<br><img class="floatnone" src="/images/session1.png"><br><strong><em>首次请求index.jsp</em></strong><br><img class="floatnone" src="/images/session2.png"><br><strong><em>再次请求index.jsp</em></strong></p>
<h3 id="应用场景">应用场景</h3>
<p>Cookie和session由于实现手段不同，因此也各有优缺点和各自的应用场景：</p>
</li>
<li><p>应用场景<br>Cookie的典型应用场景是Remember Me服务，即用户的账户信息通过cookie的形式保存在客户端，当用户再次请求匹配的URL的时候，账户信息会被传送到服务端，交由相应的程序完成自动登录等功能。当然也可以保存一些客户端信息，比如页面布局以及搜索历史等等。<br>Session的典型应用场景是用户登录某网站之后，将其登录信息放入session，在以后的每次请求中查询相应的登录信息以确保该用户合法。当然还是有购物车等等经典场景；</p>
</li>
<li>安全性<br>cookie将信息保存在客户端，如果不进行加密的话，无疑会暴露一些隐私信息，安全性很差，一般情况下敏感信息是经过加密后存储在cookie中，但很容易就会被窃取。而session只会将信息存储在服务端，如果存储在文件或数据库中，也有被窃取的可能，只是可能性比cookie小了太多。<br>Session安全性方面比较突出的是存在会话劫持的问题，这是一种安全威胁，这在下文会进行更详细的说明。总体来讲，session的安全性要高于cookie；</li>
<li>性能<br>Cookie存储在客户端，消耗的是客户端的I/O和内存，而session存储在服务端，消耗的是服务端的资源。但是session对服务器造成的压力比较集中，而cookie很好地分散了资源消耗，就这点来说，cookie是要优于session的；</li>
<li>时效性<br>Cookie可以通过设置有效期使其较长时间内存在于客户端，而session一般只有比较短的有效期（用户主动销毁session或关闭浏览器后引发超时）；</li>
<li>其他<br>Cookie的处理在开发中没有session方便。而且cookie在客户端是有数量和大小的限制的，而session的大小却只以硬件为限制，能存储的数据无疑大了太多。<h3 id="SESSION创建">SESSION创建</h3>
通过上述的讲解，读者应该对session有了一个大体的认识，但是具体到某种动态页面技术，又是怎么实现session的呢？下面笔者将结合session的生命周期（lifecycle），从源代码的层次来具体分析一下在servlet/jsp技术中，session是怎么实现的。代码部分以tomcat6.0.20作为参考。<br>在我问过的一些从事java web开发的人中，对于session的创建时机大都这么回答：当我请求某个页面的时候，session就被创建了。这句话其实很含糊，因为要创建session请求的发送是必不可少的，但是无论何种请求都会创建session吗？错。我们来看一个例子。<br>众所周知，jsp技术是servlet技术的反转，在开发阶段，我们看到的是jsp页面，但真正到运行时阶段，jsp页面是会被“翻译”为servlet类来执行的，例如我们有如下jsp页面：</li>
</ol>
<figure class="highlight {bash}"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="vbscript">&lt;%@ page language=<span class="string">"java"</span> pageEncoding=<span class="string">"ISO-8859-1"</span> session=<span class="string">"true"</span>%&gt;</span></div><div class="line"><span class="doctype">&lt;!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"&gt;</span></div><div class="line"><span class="tag">&lt;<span class="title">html</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="title">head</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="title">title</span>&gt;</span>index.jsp<span class="tag">&lt;/<span class="title">title</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="title">head</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="title">body</span>&gt;</span></div><div class="line">        This is index.jsp page.</div><div class="line">        <span class="tag">&lt;<span class="title">br</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="title">body</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="title">html</span>&gt;</span></div></pre></td></tr></table></figure>

<p>在我们初次请求该页面后，在对应的work目录可以找到该页面对应的java类，考虑到篇幅的原因，在此只摘录比较重要的一部分，有兴趣的读者可以亲自试一下：</p>
<figure class="highlight {bash}"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">......</div><div class="line">response.setContentType(<span class="string">"text/html;charset=ISO-8859-1"</span>);</div><div class="line">pageContext = _jspxFactory.getPageContext(this, request, response,</div><div class="line">            null, <span class="literal">true</span>, <span class="number">8192</span>, <span class="literal">true</span>);</div><div class="line">_jspx_page_context = pageContext;</div><div class="line">application = pageContext.getServletContext();</div><div class="line">config = pageContext.getServletConfig();</div><div class="line">session = pageContext.getSession();</div><div class="line"><span class="keyword">out</span> = pageContext.getOut();</div><div class="line">_jspx_out = <span class="keyword">out</span>;</div><div class="line"><span class="keyword">out</span>.write(<span class="string">"\r\n"</span>);</div><div class="line"><span class="keyword">out</span>.write(<span class="string">"&lt;!DOCTYPE HTML PUBLIC \"-//W3C//DTD HTML 4.01 Transitional//EN\"&gt;\r\n"</span>);</div><div class="line"><span class="keyword">out</span>.write(<span class="string">"&lt;html&gt;\r\n"</span>);</div><div class="line">......</div></pre></td></tr></table></figure>

<p>可以看到有一句显式创建session的语句，它是怎么来的呢？我们再看一下对应的jsp页面，在jsp的page指令中加入了session=”true”，意思是在该页面启用session，其实作为动态技术，这个参数是默认为true的，这很合理，在此显示写出来只是做一下强调。很显然二者有着必然的联系。笔者在jsp/servlet的翻译器（org.apache.jasper.compiler）的源码中找到了相关证据：</p>
<figure class="highlight {bash}"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="code">......</span></div><div class="line"></div><div class="line">if (pageInfo.isSession())</div><div class="line"></div><div class="line">    out.printil("session = pageContext.getSession();");</div><div class="line"></div><div class="line">out.printil("out = pageContext.getOut();");</div><div class="line"></div><div class="line">out.printil("_jspx_out = out;");</div><div class="line"></div><div class="line">......</div></pre></td></tr></table></figure>

<p>上面的代码片段的意思是如果页面中定义了session=”true”，就在生成的servlet源码中加入session的获取语句。这只能够说明session创建的条件，显然还不能说明session是如何创建的，本着逐本溯源的精神，我们继续往下探索。<br>有过servlet开发经验的应该记得我们是通过HttpServletRequest的getSession方法来获取当前的session对象的：</p>
<figure class="highlight {bash}"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> HttpSession <span class="title">getSession</span>(<span class="keyword">boolean</span> create);</div><div class="line"></div><div class="line"><span class="keyword">public</span> HttpSession <span class="title">getSession</span>();</div><div class="line"></div><div class="line">二者的区别只是无参的getSession将create默认设置为<span class="keyword">true</span>而已。即：</div><div class="line"></div><div class="line"><span class="keyword">public</span> HttpSession <span class="title">getSession</span>() {</div><div class="line"></div><div class="line">    <span class="keyword">return</span> (getSession(<span class="keyword">true</span>));</div><div class="line"></div><div class="line">}</div></pre></td></tr></table></figure>

<p>那么这个参数到底意味着什么呢？通过层层跟踪，笔者终于理清了其中的脉络，由于函数之间的关系比较复杂，如果想更详细地了解内部机制，建议去独立阅读tomcat相关部分的源代码。这里我将其中的大致流程叙述一下：</p>
<ol>
<li>用户请求某jsp页面，该页面设置了session=”true”；</li>
<li>Servlet/jsp容器将其翻译为servlet，并加载、执行该servlet；</li>
<li>Servlet/jsp容器在封装HttpServletRequest对象时根据cookie或者url中是否存在jsessionid来决定是绑定当前的session到HttpRequest还是创建新的session对象（在请求解析阶段发现并记录jsessionid，在Request对象创建阶段将session绑定）；</li>
<li>程序按需操作session，存取数据；</li>
<li><p>如果是新创建的session，在结果响应时，容器会加入Set-cookie头，以提醒浏览器要保持该会话（或者采用URL重写方式将新的链接呈现给用户）。<br>通过上面的叙述读者应该了解了session是何时创建的，这里再从servlet这个层面总结一下：当用户请求的servlet调用了getSession方法时，都会获取session，至于是否创建新的session取决于当前request是否已绑定session。当客户端在请求中加入了jsessionid标识而servlet容器根据此标识查找到了对应的session对象时，会将此session绑定到此次请求的request对象，客户端请求中不带jsessionid或者此jsessionid对应的session已过期失效时，session的绑定无法完成，此时必须创建新的session。同时发送Set-cookie头通知客户端开始保持新的会话。</p>
<h3 id="SESSION保持与销毁">SESSION保持与销毁</h3>
<p>理解了session的创建，就很好理解会话是如何在客户端和服务端之间保持的了。当首次创建了session后，客户端会在后续的请求中将session的标识符带到服务端，服务端程序只要在需要session的时候调用getSession，服务端就可以将对应的session绑定到当前请求，从而实现状态的保持。当然这需要客户端的支持，如果禁用了cookie而又不采用url重写的话，session是无法保持的。</p>
<p>如果几次请求之间有一个servlet未调用getSession（或者干脆请求一个静态页面）会不会使得会话中断呢？这个不会发生的，因为客户端只会将合法的cookie值传送给服务端，至于服务端拿cookie做什么事它是不会关心的，当然也无法关心。Session建立之后，客户端会一直将session的标识符传送到服务器，无论请求的页面是动态的、静态的，甚至是一副图片。</p>
</li>
</ol>
<p>此处谈到的销毁是指会话的废弃，至于存储会话信息的数据结构是回收被重用还是直接释放内存我们并不关心。Session的销毁有两种情况：超时和手动销毁。</p>
<pre><code>由于HTTP协议的无状态性，服务端无法得知一个session对象何时将再次被使用，可能用户开启了一个session之后再也没有后续的访问，而且session的保持是需要消耗一定的服务端开销的，因此不可能一味地创建session而不去回收无用的session。这里就引入了一个超时机制。Tomcat中的超时在web<span class="built_in">.</span><span class="built_in">xml</span>里做如下配置：
</code></pre><figure class="highlight {bash}"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="title">session-config</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="title">session-timeout</span>&gt;</span>30<span class="tag">&lt;/<span class="title">session-timeout</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="title">session-config</span>&gt;</span></div></pre></td></tr></table></figure>

<p>上述配置是指session在30分钟没有被再次使用就将其销毁。Tomcat是怎么计算这个30分钟的呢？原来在getSession之后，都要调用它的access方法，修改lastAccessedTime，在销毁session的时候就是判断当前时间和这个lastAccessedTime的差值。<br>手动销毁是指直接调用其invalidate方法，此方法实际上是调用expire方法来手动将其设置为超时。<br>    当用户手动请求了session的销毁时，客户端是无法知道服务端的session已经被销毁的，它依然会发送先前的session标识符到服务端。而此时如果再次请求了某个调用了getSession的servlet，服务端是无法根据先前的session标识符找到相应的session对象的，这是又要重新创建新的session，分配新的标识符，并告知服务端更新session标识符开始保持新的会话。</p>
<h3 id="SESSION数据结构">SESSION数据结构</h3>
<p>在servlet/jsp中，容器是用何种数据结构来存储session相关的变量的呢？我们猜测一下，首先它必须被同步操作，因为在多线程环境下session是线程间共享的，而web服务器一般情况下都是多线程的（为了提高性能还会用到池技术）；其次，这个数据结构必须容易操作，最好是传统的键值对的存取方式。</p>
<pre><code>那么我们先具体到单个session对象，它除了存储自身的相关信息，比如<span class="keyword">id</span>之外，tomcat的session还提供给程序员一个用以存储其他信息的接口（在类org<span class="variable">.apache</span><span class="variable">.catalina</span><span class="variable">.session</span>. StandardSession里）：
</code></pre><figure class="highlight {bash}"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="built_in">void</span> setAttribute(<span class="built_in">String</span> name, <span class="built_in">Object</span> value, <span class="built_in">boolean</span> notify)</div></pre></td></tr></table></figure>

<pre><code>在这里可以追踪到它到底使用了何种数据：
</code></pre><figure class="highlight {bash}"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">protected</span> Map attributes = <span class="keyword">new</span> ConcurrentHashMap();</div></pre></td></tr></table></figure>

<pre><code>这就很明确了，原来tomcat使用了一个ConcurrentHashMap对象存储数据，这是java的concurrent包里的一个类。它刚好满足了我们所猜测的两点需求：同步与易操作性。

那么tomcat又是用什么数据结构来存储所有的session对象呢？果然还是ConcurrentHashMap（在管理session的org.apache.catalina.session. ManagerBase类里）：
</code></pre><figure class="highlight {bash}"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">protected</span> <span class="keyword">Map</span>&lt;<span class="typename">String</span>, Session&gt; sessions = <span class="keyword">new</span> ConcurrentHashMap&lt;<span class="typename">String</span>, Session&gt;();</div></pre></td></tr></table></figure>

<pre><code>具体原因就不必多说了。至于其他web服务器的具体实现也应该考虑到这两点。
</code></pre><h3 id="SESSION劫持">SESSION劫持</h3>
<p> Session hijack即会话劫持是一种比较严重的安全威胁，也是一种广泛存在的威胁，在session技术中，客户端和服务端通过传送session的标识符来维护会话，但这个标识符很容易就能被嗅探到，从而被其他人利用，这属于一种中间人攻击。<br>本部分通过一个实例来说明何为会话劫持，通过这个实例，读者其实更能理解session的本质。<br>首先，我编写了如下页面：</p>
<figure class="highlight {bash}"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div></pre></td><td class="code"><pre><div class="line"><span class="vbscript">&lt;%@ page language=<span class="string">"java"</span> pageEncoding=<span class="string">"ISO-8859-1"</span> session=<span class="string">"true"</span>%&gt;</span></div><div class="line"></div><div class="line"><span class="doctype">&lt;!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"&gt;</span></div><div class="line"></div><div class="line"><span class="tag">&lt;<span class="title">html</span>&gt;</span></div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="title">head</span>&gt;</span></div><div class="line"></div><div class="line">       <span class="tag">&lt;<span class="title">title</span>&gt;</span>index.jsp<span class="tag">&lt;/<span class="title">title</span>&gt;</span></div><div class="line"></div><div class="line">    <span class="tag">&lt;/<span class="title">head</span>&gt;</span></div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="title">body</span>&gt;</span></div><div class="line"></div><div class="line">       This is index.jsp page.</div><div class="line"></div><div class="line">       <span class="tag">&lt;<span class="title">br</span>&gt;</span></div><div class="line"></div><div class="line">       <span class="vbscript">&lt;%</span></div><div class="line"></div><div class="line">           Object o = session.getAttribute(<span class="string">"counter"</span>);</div><div class="line"></div><div class="line">           <span class="keyword">if</span> (o == <span class="literal">null</span>) {</div><div class="line"></div><div class="line">              session.setAttribute(<span class="string">"counter"</span>, <span class="number">1</span>);</div><div class="line"></div><div class="line">           } <span class="keyword">else</span> {</div><div class="line"></div><div class="line">              Integer i = Integer.parseInt(o.toString());</div><div class="line"></div><div class="line">              session.setAttribute(<span class="string">"counter"</span>, i + <span class="number">1</span>);</div><div class="line"></div><div class="line">           }</div><div class="line"></div><div class="line">           out.println(session.getAttribute(<span class="string">"counter"</span>));</div><div class="line"></div><div class="line">       %&gt;</div><div class="line"></div><div class="line">       <span class="tag">&lt;<span class="title">a</span> <span class="attribute">href</span>=<span class="value">"&lt;%=response.encodeRedirectURL("</span><span class="value">index.jsp")%</span>&gt;</span>"&gt;index<span class="tag">&lt;/<span class="title">a</span>&gt;</span></div><div class="line"></div><div class="line">    <span class="tag">&lt;/<span class="title">body</span>&gt;</span></div><div class="line"></div><div class="line"><span class="tag">&lt;/<span class="title">html</span>&gt;</span></div></pre></td></tr></table></figure>

<p> 页面的功能是在session中放置一个计数器，第一次访问该页面，这个计数器的值初始化为1，以后每一次访问这个页面计数器都加1。计数器的值会被打印到页面。另外，为了比较简单地模拟，笔者禁用了客户端（采用firefox3.0）的cookie，转而改用URL重写方式，因为直接复制链接要比伪造cookie方便多了。</p>
<pre><code>下面，打开firefox访问该页面，我们看到了计数器的值为1：
</code></pre><p><img class="floatnone" src="/images/session3.png"><br>     然后点击index链接来刷新计数器，注意不要刷新当前页，因为我们没用采用cookie的方式，只能在url后面带上jsessionid，而此时地址栏里的url是无法带上jsessionid的。如图四，我把计数器刷新到了20。<br><img class="floatnone" src="/images/session4.png"><br>下面是最关键的，复制firefox地址栏里的地址（笔者看到的是<a href="http://localhost:8080/sessio" target="_blank" rel="external">http://localhost:8080/sessio</a></p>
<p>n/index.jsp;jsessionid=1380D9F60BCE9C30C3A7CBF59454D0A5），然后打开另一个浏览器，此处不必将其cookie禁用。这里我打开了苹果的safari3浏览器，然后将地址粘贴到其地址栏里，回车后如下图：<br><img class="floatnone" src="/images/session5.png"><br>很奇怪吧，计数器直接到了21。这个例子笔者是在同一台计算机上做的，不过即使换用两台来做，其结果也是一样的。此时如果交替点击两个浏览器里的index链接你会发现他们其实操纵的是同一个计数器。其实不必惊讶，此处safari盗用了firefox和tomcat之间的维持会话的钥匙，即jsessionid，这属于session hijack的一种。在tomcat看来，safari交给了它一个jsessionid，由于HTTP协议的无状态性，它无法得知这个jsessionid是从firefox那里“劫持”来的，它依然会去查找对应的session，并执行相关计算。而此时firefox也无法得知自己的保持会话已经被“劫持”。</p>
<h3 id="谢谢！">谢谢！</h3>
<p>有问题请留言。T_T  I am teacher Chale.  T_T</p>

      
    </div>
    <section id='after_content_widget'><div class="widget" id="widget_after_content_wumiiRelatedItems>">
<script type="text/javascript" id="wumiiRelatedItems"></script>
</div><div class="widget" id="widget_after_content_post_footer_info>">
<div class="panel panel-success">
    <div class="panel-heading" align="center">希望本站内容对您有点用处,有什么疑问或建议请在后面留言评论</div>
    <div align="center" class="panel-body">若无特别注明，本站内容均属原创,转载请注明作者(<a href="">Chale Cao</a>)和出处 <a href="http://haomou.net">皓眸IT</a> ，请勿用于任何商业用途</div>
    <div class="panel-body">本文链接: <a href="/2014/08/07/2014_session/">关于SESSION的理解</a></div>
</div></div></section>
    
    
        <footer id="post-meta">
        <div class="categories hm-article-w hm-article-w-h" itemscope="" itemtype="http://data-vocabulary.org/Breadcrumb" style="display:inline">归类<br/><span class="breadcrumb fa fa-folder"><li><a href="/categories/WEB相关/" itemprop="url"><span itemprop="title" >WEB相关</span></a></li></span></div>    &nbsp;&nbsp; <span class="tags hm-article-w hm-article-w-h1">标签<br/> <a href="/tags/session/" class="label label-primary" itemprop="url"><span itemprop="title">session</span></a></span>    &nbsp;&nbsp; <span class="time">最近更新:<time title="2014-08-07 12:17:32"datetime="2014-08-07 12:17:32"> Aug 7 2014</time></span>    &nbsp;&nbsp; <span class="comment-link">
<a href="http://haomou.net/2014/08/07/2014_session/#comments" class="ds-thread-count comment-link" data-thread-key="2014_session" data-count-type="comments">暂无评论</a></span>
        </footer>
    
    <div class="clearfix"></div>
  </div>
</div>
</article>


    <section id='after_post_widget'><div class="widget" id="widget_after_post_post_pageNav>">
<ul class="pager">
  
  <li class="previous"><a href="/2014/08/09/2014_ionic_api_css/" title="ionic中文详解CSS组件">&larr; ionic中文详解CSS组件</a></li>
  
  
  <li class="next"><a href="/2014/08/07/2014_ionic/" title="ionic框架配置">ionic框架配置 &rarr;</a></li>
  
</ul></div></section>    
	<div id="comments"><!-- Duoshuo Comment BEGIN -->

<div class="ds-thread"  data-thread-key="2014_session"  data-url="http://haomou.net/2014/08/07/2014_session/" data-title="关于SESSION的理解"></div>
<!-- Duoshuo Comment END -->

</div></div><!--wapper-->
       </div><!-- ID main-col END -->
       <aside id="sidebar" class="alignright col-sx-6 col-sm-4 col-md-3 col-lg-3">
<div id="widget_search" class="widget hm-left-widget" style="clear:both">
  <div class="panel-heading">搜索</div>  <form action="//google.com/search" method="get" accept-charset="utf-8">
  <div class="input-group">
    <input class="form-control" id="searchbox" type="search" name="q" results="0" placeholder="搜索">
    <span class="input-group-btn">
      <button class="btn btn-default" type="submit">Go!</button>
    </span>
    <input type="hidden" name="q" value="site:haomou.net">
  </div>
</form>
</div>

<div id="widget_recent_posts" class="widget hm-left-widget" style="clear:both">
  <div class="panel-heading">最近文章</div>  <div data-src='recent_posts' class='ajax_widgets'>正在加载...</div></div>

<div id="widget_recent_comments" class="widget hm-left-widget" style="clear:both">
  <div class="panel-heading">最近评论</div>  

<div class="list-group-item ds-recent-comments" data-num-items="6" data-show-avatars="1" data-show-time="1" data-show-title="1" data-show-admin="1" data-excerpt-length="50"></div>



</div>

</aside>
       <div class="clearfix"></div>
     </div><!-- row END -->
  </div>
  <footer id="footer" class="container">
  <div class="panel panel-info">
  <section id='footer_widget'></section>  <div class="panel-footer">
  <div id="site-info">
    <span class='author'>
  
  &copy; 2014 Chale Cao
  
    &nbsp;&nbsp;</span>
  <a href='http://www.miibeian.gov.cn/'>苏ICP备13018740号-6</a></span>
  <span id='analytics-51la'></span><span id='analytics-google'></span><span id='analytics-cnzz'>
<script type="text/javascript">var cnzz_protocol = (("https:" == document.location.protocol) ? " https://" : " http://");document.write(unescape("%3Cspan id='cnzz_stat_icon_5849006'%3E%3C/span%3E%3Cscript src='" + cnzz_protocol + "s17.cnzz.com/stat.php%3Fid%3D5849006%26show%3Dpic' type='text/javascript'%3E%3C/script%3E"));</script>
</span><span id='analytics-baidu'></span>  </div>
  <div id="copyright">Blog powered by <a href='http://www.haomou.net/'  title="本站由hexo V2.8.2 生成"><strong>hexo</strong></a> Theme <strong><a href='http://www.haomou.net/'>Chale V1.0</a></strong><span class="pull-right"> 更新时间: <em>2014-08-07 12:17:32</em></span></div>
</div>
<div class="clearfix"></div>
  </div>
  </footer>
  
        <script src="http://cdn.bootcss.com/jquery/1.10.2/jquery.min.js"></script>        
        <script src="http://cdn.bootcss.com/twitter-bootstrap/3.1.0/js/bootstrap.min.js"></script>        
                
        <script src="http://cdn.bootcss.com/prettify/r298/prettify.min.js"></script>    <script type="text/javascript">
   var lang=["bsh", "c", "cc", "cpp", "cs", "csh", "cyc", "cv", "htm", "html",
    "java", "js", "m", "mxml", "perl", "pl", "pm", "py", "rb", "sh",
    "xhtml", "xml", "xsl"];
   var pretty_base='';
   $('script').each(function(){
	var c = $(this).attr('src');
	if (!c)
	    return;
	if (c.match(/(\/)?prettify(\.min)?\.js/i))
	{
	    var index = c.lastIndexOf('/');
	    if (index != -1)
		pretty_base = c.substr(0,index + 1);
	    return false;
	}
   })
   $('pre code').each(function(){
	var c = $(this).attr('class')
	if (!c)
	    return;
	c = c.match(/\s?(lang\-\w+)/i);
	if (c && lang.indexOf(c[1]) == -1)
	{
	    lang.push(c[1]);
	    $.getScript(pretty_base + c[1] + '.min.js');
	}
   })

    $(window).load(function(){
       $("pre").addClass("prettyprint");
       prettyPrint();
    })
</script>    
            <script type="text/javascript">
var duoshuoQuery = {short_name:"haomou"};
_js2load.push({src:'http://static.duoshuo.com/embed.js',charset:'UTF-8'});
</script>
    
            <!--wumii_relatedItems-->

<script type="text/javascript">
    var wumiiPermaLink = "http://haomou.net/2014/08/07/2014_session/";
    var wumiiTitle = "关于SESSION的理解";
    var wumiiTags = "session";
    var wumiiCategories = ["WEB相关"];
    var wumiiSitePrefix = "http://haomou.net";
    var wumiiParams = "&num=5&mode=3&pf=JAVASCRIPT";
    _js2load.push({src:'http://widget.wumii.cn/ext/relatedItemsWidget'});
</script>
<a href="http://www.wumii.com/widget/relatedItems" style="border:0;">
<img src="http://static.wumii.cn/images/pixel.png" alt="无觅关联推荐，快速提升流量" style="border:0;padding:0;margin:0;" />
</a>
    
        <script src="http://cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.min.js"></script>    <script type="text/javascript">
(function($){
  $('.entry').each(function(i){
    $(this).find('img').each(function(){
      var alt = this.alt;

      $(this).wrap('<a href="' + this.src + '" title="' + alt + '" class="fancybox" rel="fancybox' + i + '" />').wrap('<div class="img_block"></div>');
     
      if(alt){$(this).after('<span class="caption">' + alt + '</span>')};
    });
  });

  $('.fancybox').fancybox();
})(jQuery);
</script>    
        <script src="http://cdn.bootcss.com/mathjax/2.3/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>    <script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    tex2jax: {
      skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code'],
      inlineMath: [ ['$','$'], ["\\(","\\)"] ],
      processEscapes: true
    }
  });
  MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
      all[i].SourceElement().parentNode.className += ' has-jax';
    }
  });
</script>
    
<script src="/js/nprogress.js" type="text/javascript"></script>

<script src="/js/chenall.js" type="text/javascript"></script>


  </body>
</html>
