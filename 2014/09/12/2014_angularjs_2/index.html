<!DOCTYPE HTML>
<html><head>
<meta http-equiv="Cache-Control" content="max-age=7200" />

<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="wumiiVerification" content="1747c9bc-e905-45aa-88ac-f13f2b210015" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<title>AngularJS笔记-详细使用 | 皓眸IT</title>
<meta name="author" content="Chale Cao">

<meta name="description" content="指令用处AngularJS这个框架真的比较神奇，就像一杯酒，你用的越久，越喜欢用这个框架。之前我是觉得用Angular做一些复杂的效果不好做，好多都是用jQuery来辅助实现的。今天我这里要详细总结的是Angular的使用方法，包括数据绑定，过滤器，自定义模块及服务，指令等。其中通过指令可以自定义html标签，并解析成自己需要的内容。注意本文中“{”表示的是“{”，“|”表示的是“|”，转义后显示有点问题。">


<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

<meta property="og:title" content="AngularJS笔记-详细使用"/>
<meta property="og:site_name" content="皓眸IT"/>

<!--[if IE]><style>.testIE.IE{display:inline;}</style><![endif]-->
<!--[if lte IE 7]><link rel="stylesheet" href="/css/ie7.css" type="text/css">
<![endif]-->
<!--[if (lt IE 9)&(gt IE 7)]><style>.testIE.IE8{display:inline;}</style><![endif]-->
<!--[if gt IE 8]><style>.testIE.IE9{display:inline;}</style><![endif]-->


<link href="/favicon.png" rel="icon">
<link rel="alternate" href="/atom.xml" title="皓眸IT Feed" type="application/atom+xml">

<link rel="stylesheet" href="http://cdn.bootcss.com/twitter-bootstrap/3.1.0/css/bootstrap.min.css" type="text/css">
<link rel="stylesheet" href="http://libs.baidu.com/fontawesome/4.0.3/css/font-awesome.min.css" type="text/css">
<link rel="stylesheet" href="http://cdn.bootcss.com/prettify/r298/prettify.min.css" type="text/css">
<link rel="stylesheet" href="http://cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.min.css" type="text/css">

<link rel="stylesheet" href="/css/style.css" type="text/css">

<link rel="stylesheet" href="/css/nprogress.css" type="text/css">

<!--[if lt IE 9]>
   <style>article,aside,dialog,footer,header,section,footer,nav,figure,menu{display:block}</style>
   <script src="http://cdn.staticfile.org/html5shiv/r29/html5.min.js"></script>
   <script src="http://cdn.bootcss.com/respond.js/1.4.2/respond.min.js"></script>
<link href="http://cdn.bootcss.com/respond.js/1.4.2/respond-proxy.html" id="respond-proxy" rel="respond-proxy" />
<link href="/js/respond.proxy.gif" id="respond-redirect" rel="respond-redirect" />
<script src="/js/respond.proxy.js"></script>
   <script src="http://cdn.bootcss.com/selectivizr/1.0.2/selectivizr-min.js"></script>
<![endif]-->
<script type="text/javascript">var site = {BASE_URI: '/'};var _js2load = [];</script>

</head>
<body>
  
  <header id="header" class="hm-menu-left-container"><nav id="main-nav" class="navbar navbar-default hm-navbar-menu-left  " role="navigation">
    <div class="hm-navbar-header">
    <a href="http://haomou.net" ><img class="hm-logo" src="/images/haomou.png" title="皓眸IT" width="64" height="64" /></a>
    <br/>|<br/><span class="fa fa-tint hm-black shine_blue" ></span><br/>|<br/><span class="fa fa-heart hm-black shine_red" ></span><br/>|<br/>
        <i class="fa fa-bars fa-2x hm-black hm-menu shine_blue" ></i><br/><div class="hm-line"></div>
    </div>
    <div class="collapse navbar-collapse">
      <h1 style="color:black">皓眸IT</h1>
      <ul class="nav navbar-nav hm-left-nav">
  
        <li item='2014/09/12/2014_angularjs_2/' class='active'><a href="/" title="首页">首页</a></li>      
      <li class='dropdown'>
        <a class='dropdown-toggle' data-toggle='dropdown' href='#'>关于我<b class='caret'></b></a>
        <ul class='dropdown-menu'>
    
          <li><a href="http://home.ustc.edu.cn/~chh1990/chero/chero.html" title="个人主页">个人主页</a></li>    
        </ul>
      </li>
    
      <li class='dropdown'>
        <a class='dropdown-toggle' data-toggle='dropdown' href='#'>创业项目<b class='caret'></b></a>
        <ul class='dropdown-menu'>
    
          <li><a href="http://pictcake.cn" title="照片蛋糕">照片蛋糕</a></li>    
        </ul>
      </li>
    
      </ul>

        
        <div id="widget_category" class="widget hm-left-widget">
            <div class="panel-heading">分类：</div>            <div data-src='category' class='ajax_widgets'>正在加载...</div>
        </div>
        
        <div id="widget_tagcloud" class="widget hm-left-widget">
            <div class="panel-heading">标签云：</div>            <div data-src='tagcloud' class='ajax_widgets'>正在加载...</div>        </div>
        


      <ul class="nav navbar-nav navbar-right">
      
        <li><a href="/atom.xml">RSS</a></li>
      
      
      
      
      
        <li><a href="https://github.com/chalecao">github</a></li>
      
      </ul>
    </div>
</nav>
<div class="clearfix"></div></header>
  <div style="" id="headflash" class="headflash hm_container"><embed pluginspage="http://www.macromedia.com/go/getflashplayer" type="application/x-shockwave-flash" src="/images/bck.swf" width="100%" height="313" style="undefined" id="headflash_f" name="headflash_f" bgcolor="#000" quality="high" allowscriptaccess="false" wmode="transparent" allowfullscreen="false"></div>
  <div id='content' class=" container">
     <div class="page-header-wrapper">
      <!--[if lt IE 9]><div class="alert alert-warning alert-dismissable"><button type="button" class="close" data-dismiss="alert" aria-hidden="true">&times;</button><strong>提示:</strong>您的浏览器版本太低了,建议升级到 <strong><a href="http://windows.microsoft.com/zh-cn/internet-explorer/download-ie" title="IE9">IE9</a></strong> 以上,本站使用<a href="https://www.google.com/intl/zh-CN/chrome/">Chrome浏览器</a>可以获得最好的显示效果.</div><![endif]-->
      <div class="page-header"><h1>皓眸IT <small>写清楚，说明白</small></h1></div>
     </div>
     <div class="row">
       <div id="main-col" class="alignleft col-sx-12 col-sm-8 col-md-9 col-lg-9">
      <section id='header_widget'></section>
          <div id="wrapper"><article class="hm-article">
<div id="post" class="post well">
  <div class="post-content">
    <header class="well-sm">
      <i class="fa icon fa-5x pull-left hm-article-w"></i>
      <h1 class="title">AngularJS笔记-详细使用</h1>
      
        <span class="hm-article-w hm-article-w-h0">发表于<br/><time datetime="2014-09-12T18:40:49.000Z"> <a href="/2014/09/12/2014_angularjs_2/">Sep 12 2014</a></time></span>      
    </header>
    
    <section id='before_content_widget'></section>
    <div class="entry"  data-spy="scroll" data-target="#toc" >
      
        <h3 id="指令用处">指令用处</h3>
<p>AngularJS这个框架真的比较神奇，就像一杯酒，你用的越久，越喜欢用这个框架。之前我是觉得用Angular做一些复杂的效果不好做，好多都是用jQuery来辅助实现的。今天我这里要详细总结的是Angular的使用方法，包括数据绑定，过滤器，自定义模块及服务，指令等。其中通过指令可以自定义html标签，并解析成自己需要的内容。注意本文中“{”表示的是“{”，“|”表示的是“|”，转义后显示有点问题。<br><a id="more"></a><br><img class="floatnone" src="/images/angular1.png"><br><br></p>
<p>转载请注明出处：<a href="http://www.haomou.net/2014/09/12/2014_angularjs_2/" target="_blank" rel="external">http://www.haomou.net/2014/09/12/2014_angularjs_2/</a></p>
<h3 id="AngularJS">AngularJS</h3>
<p>AngularJS 是 Google 开源出来的一套 js 工具。下面简称其为 ng 。这里只说它是“工具”，没说它是完整的“框架”，是因为它并不是定位于去完成一套框架要做的事。更重要的，是它给我们揭示了一种新的应用组织与开发方式。</p>
<p>ng 最让我称奇的，是它的数据双向绑定。其实想想，我们一直在提数据与表现的分离，但是这里的“双向绑定”从某方面来说，是把数据与表现完全绑定在一起——数据变化，表现也变化。反之，表现变化了，内在的数据也变化。有过开发经验的人能体会到这种机制对于前端应用来说，是很有必要的，能带来维护上的巨大优势。当然，这里的绑定与提倡的分离并不是矛盾的。</p>
<p>ng 可以和 jQuery 集成工作，事实上，如果没有 jQuery ， ng 自己也做了一个轻量级的 jQuery ，主要实现了元素操作部分的 API 。</p>
<p>关于 ng 的几点：</p>
<p>1.对 IE 方面，它兼容 IE8 及以上的版本。<br>2.与 jQuery 集成工作，它的一些对象与 jQuery 相关对象表现是一致的。<br>3.使用 ng 时不要冒然去改变相关 DOM 的结构。</p>
<h3 id="一个例子">一个例子</h3>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div></pre></td><td class="code"><pre><div class="line"><span class="doctype">&lt;!DOCTYPE html&gt;</span></div><div class="line">   <span class="tag">&lt;<span class="title">html</span>&gt;</span></div><div class="line">   <span class="tag">&lt;<span class="title">head</span>&gt;</span></div><div class="line">   <span class="tag">&lt;<span class="title">meta</span> <span class="attribute">charset</span>=<span class="value">"utf-8"</span> /&gt;</span></div><div class="line">   </div><div class="line">   <span class="tag">&lt;<span class="title">title</span>&gt;</span>试验<span class="tag">&lt;/<span class="title">title</span>&gt;</span></div><div class="line">  </div><div class="line">   <span class="tag">&lt;<span class="title">script</span> <span class="attribute">type</span>=<span class="value">"text/javascript"</span> <span class="attribute">src</span>=<span class="value">"jquery-1.8.3.js"</span>&gt;</span><span class="javascript"></span><span class="tag">&lt;/<span class="title">script</span>&gt;</span></div><div class="line">   <span class="tag">&lt;<span class="title">script</span> <span class="attribute">type</span>=<span class="value">"text/javascript"</span> <span class="attribute">src</span>=<span class="value">"angular.js"</span>&gt;</span><span class="javascript"></span><span class="tag">&lt;/<span class="title">script</span>&gt;</span></div><div class="line">  </div><div class="line">   <span class="tag">&lt;/<span class="title">head</span>&gt;</span></div><div class="line">   <span class="tag">&lt;<span class="title">body</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="title">div</span> <span class="attribute">ng-controller</span>=<span class="value">"BoxCtrl"</span>&gt;</span></div><div class="line">       <span class="tag">&lt;<span class="title">div</span> <span class="attribute">style</span>=<span class="value">"width: 100px; height: 100px; background-color: red;"</span></span></div><div class="line">            <span class="attribute">ng-click</span>=<span class="value">"click()"</span>&gt;<span class="tag">&lt;/<span class="title">div</span>&gt;</span></div><div class="line">       <span class="tag">&lt;<span class="title">p</span>&gt;</span>\{\{ w }} x \{\{ h }}<span class="tag">&lt;/<span class="title">p</span>&gt;</span></div><div class="line">       <span class="tag">&lt;<span class="title">p</span>&gt;</span>W: <span class="tag">&lt;<span class="title">input</span> <span class="attribute">type</span>=<span class="value">"text"</span> <span class="attribute">ng-model</span>=<span class="value">"w"</span> /&gt;</span><span class="tag">&lt;/<span class="title">p</span>&gt;</span></div><div class="line">       <span class="tag">&lt;<span class="title">p</span>&gt;</span>H: <span class="tag">&lt;<span class="title">input</span> <span class="attribute">type</span>=<span class="value">"text"</span> <span class="attribute">ng-model</span>=<span class="value">"h"</span> /&gt;</span><span class="tag">&lt;/<span class="title">p</span>&gt;</span></div><div class="line">     <span class="tag">&lt;/<span class="title">div</span>&gt;</span></div><div class="line">   </div><div class="line">   </div><div class="line">   <span class="tag">&lt;<span class="title">script</span> <span class="attribute">type</span>=<span class="value">"text/javascript"</span> <span class="attribute">charset</span>=<span class="value">"utf-8"</span>&gt;</span><span class="javascript"></span></div><div class="line">   </div><div class="line">   </div><div class="line">   <span class="keyword">var</span> BoxCtrl = <span class="function"><span class="keyword">function</span><span class="params">($scope, $element)</span></span>{</div><div class="line">   </div><div class="line">     <span class="comment">//$element 就是一个 jQuery 对象</span></div><div class="line">     <span class="keyword">var</span> e = $element.children().eq(<span class="number">0</span>);</div><div class="line">     $scope.w = e.width();</div><div class="line">     $scope.h = e.height();</div><div class="line">   </div><div class="line">     $scope.click = <span class="function"><span class="keyword">function</span><span class="params">()</span></span>{</div><div class="line">       $scope.w = <span class="built_in">parseInt</span>($scope.w) + <span class="number">10</span>;</div><div class="line">       $scope.h = <span class="built_in">parseInt</span>($scope.h) + <span class="number">10</span>;</div><div class="line">     }</div><div class="line">   </div><div class="line">     $scope.$watch(<span class="string">'w'</span>,</div><div class="line">       <span class="function"><span class="keyword">function</span><span class="params">(to, from)</span></span>{</div><div class="line">         e.width(to);</div><div class="line">       }</div><div class="line">     );</div><div class="line">   </div><div class="line">     $scope.$watch(<span class="string">'h'</span>,</div><div class="line">       <span class="function"><span class="keyword">function</span><span class="params">(to, from)</span></span>{</div><div class="line">         e.height(to);</div><div class="line">       }</div><div class="line">     );</div><div class="line">  }</div><div class="line">   </div><div class="line">   angular.bootstrap(<span class="built_in">document</span>.documentElement);</div><div class="line">   <span class="tag">&lt;/<span class="title">script</span>&gt;</span></div><div class="line">   <span class="tag">&lt;/<span class="title">body</span>&gt;</span></div><div class="line">   <span class="tag">&lt;/<span class="title">html</span>&gt;</span></div></pre></td></tr></table></figure>

<p>你可以看到一个可被控制大小的红色方块。其中：<br>angular.bootstrap(document.documentElement);是Angular开始作用的入口，开始驱动整个页面。还有另外一种定义Angular入口的方式：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">&lt;body ng-app&gt;</div><div class="line"><span class="keyword">...</span></div><div class="line">&lt;/body&gt;</div></pre></td></tr></table></figure>

<p>一个angular应用是跑起来的“入口”，有两方式：</p>
<p>（1）在元素上添加ng-app指令（暂时无需关心什么意思）；ng-app可以有属性值（ng-app=”app”），这样的话就需要咱们去写一个名为app的module了，后续详解。</p>
<p>（2）不去指定ng-app，通过JS代码执行：angular.bootstrap(element, [‘模块名’…])，一样也是可以启动的</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line"><span class="doctype">&lt;!DOCTYPE html&gt;</span></div><div class="line">   <span class="tag">&lt;<span class="title">html</span> <span class="attribute">ng-app</span>=<span class="value">"MyApp"</span>&gt;</span></div><div class="line">   <span class="tag">&lt;<span class="title">head</span>&gt;</span></div><div class="line">   <span class="tag">&lt;<span class="title">meta</span> <span class="attribute">charset</span>=<span class="value">"utf-8"</span> /&gt;</span></div><div class="line">   </div><div class="line">   <span class="tag">&lt;<span class="title">title</span>&gt;</span>数据正向绑定<span class="tag">&lt;/<span class="title">title</span>&gt;</span></div><div class="line">   </div><div class="line">   <span class="tag">&lt;<span class="title">script</span> <span class="attribute">type</span>=<span class="value">"text/javascript"</span> <span class="attribute">src</span>=<span class="value">"jquery-1.8.3.js"</span>&gt;</span><span class="javascript"></span><span class="tag">&lt;/<span class="title">script</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="title">script</span> <span class="attribute">type</span>=<span class="value">"text/javascript"</span> <span class="attribute">src</span>=<span class="value">"angular.js"</span>&gt;</span><span class="javascript"></span><span class="tag">&lt;/<span class="title">script</span>&gt;</span></div><div class="line"></div><div class="line">  <span class="tag">&lt;/<span class="title">head</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="title">body</span>&gt;</span></div><div class="line">  </div><div class="line">  <span class="tag">&lt;<span class="title">div</span> <span class="attribute">ng-controller</span>=<span class="value">"TestCtrl"</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="title">input</span> <span class="attribute">type</span>=<span class="value">"text"</span> <span class="attribute">value</span>=<span class="value">""</span> <span class="attribute">id</span>=<span class="value">"a"</span> /&gt;</span></div><div class="line">  <span class="tag">&lt;/<span class="title">div</span>&gt;</span></div><div class="line">  </div><div class="line">  </div><div class="line">  <span class="tag">&lt;<span class="title">script</span> <span class="attribute">type</span>=<span class="value">"text/javascript"</span>&gt;</span><span class="javascript"></span></div><div class="line">  <span class="keyword">var</span> TestCtrl = <span class="function"><span class="keyword">function</span><span class="params">()</span></span>{</div><div class="line">    <span class="built_in">console</span>.log(<span class="string">'ok'</span>);</div><div class="line">  }</div><div class="line">  </div><div class="line">  <span class="comment">//angular.bootstrap(document.documentElement);</span></div><div class="line">  angular.module(<span class="string">'MyApp'</span>, [], <span class="function"><span class="keyword">function</span><span class="params">()</span></span>{<span class="built_in">console</span>.log(<span class="string">'here'</span>)});</div><div class="line">  <span class="tag">&lt;/<span class="title">script</span>&gt;</span></div><div class="line">  </div><div class="line">  <span class="tag">&lt;/<span class="title">body</span>&gt;</span></div><div class="line">  <span class="tag">&lt;/<span class="title">html</span>&gt;</span></div></pre></td></tr></table></figure>

<p>这里说的一个 App 就是 ng 概念中的一个 Module 。上面的例子中使用的全局函数作为控制器函数。对于 Controller 来说， 如果不想使用全局函数，也可以在 app 中定义：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> app = angular.module(<span class="string">'MyApp'</span>, [], <span class="function"><span class="keyword">function</span><span class="params">()</span></span>{<span class="built_in">console</span>.log(<span class="string">'here'</span>)});</div><div class="line">  app.controller(<span class="string">'TestCtrl'</span>,</div><div class="line">    <span class="function"><span class="keyword">function</span><span class="params">($scope)</span></span>{</div><div class="line">      <span class="built_in">console</span>.log(<span class="string">'ok'</span>);</div><div class="line">    }</div><div class="line">  );</div></pre></td></tr></table></figure>

<p>上面我们使用 ng-app 来指明要使用的 App ，这样的话可以把显式的初始化工作省了。一般完整的过程是：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="reserved">var</span> app = angular.<span class="built_in">module</span>(<span class="string">'Demo'</span>, [], angular.noop);</div><div class="line">angular.bootstrap(<span class="built_in">document</span>, [<span class="string">'Demo'</span>]);</div></pre></td></tr></table></figure>

<p>使用 angular.bootstrap 来显示地做初始化工具，参数指明了根节点，装载的模块（可以是多个模块）。</p>
<h3 id="依赖注入">依赖注入</h3>
<p>injector ，学过java的同学对这个都不陌生。用过spring框架，都知道这个神奇的依赖注入。通过简单的xml文件配置，轻松实现数据层与后台业务逻辑层的分离，实现软件的松耦合。Angular中也是这个逻辑，比如上面的例子：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> BoxCtrl = <span class="function"><span class="keyword">function</span><span class="params">(<span class="variable">$scope</span>, <span class="variable">$element</span>)</span></span>{}</div></pre></td></tr></table></figure>

<p>在这个函数定义中，注意那两个参数： \$scope ， \$element ，这是两个很有意思的东西。总的来说，它们是参数，这没什么可说的。但又不仅仅是参数——你换个名字代码就不能正常运行了。</p>
<p>事实上，这两个参数，除了完成“参数”的本身任务之外，还作为一种语法糖完成了“依赖声明”的任务。本来这个函数定义，完整的写法应该写成：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> BoxCtrl = [<span class="string">'$scope'</span>, <span class="string">'$element'</span>, <span class="function"><span class="keyword">function</span><span class="params">(s, e)</span></span>{}];</div></pre></td></tr></table></figure>

<p>这样就很明显，表示有一个函数，它依赖于两个东西，然后这两个东西会依次作为参数传入。</p>
<p>简单起见，就写成了一个函数定义原本的样子，然后在定义参数的名字上作文章，来起到依赖声明的作用。</p>
<p>在处理时，通过函数对象的 toString() 方法可以知道这个函数定义代码的字符串表现形式，然后就知道它的参数是 \$scope 和 \$element 。通过名字判断出这是两个外部依赖，然后就去获取资源，最后把资源作为参数，调用定义的函数。</p>
<p>所以，参数的名字是不能随便写的，这里也充分利用了 js 的特点来尽量做到“反省”了。</p>
<p>在 Python 中受限于函数名的命名规则，写出来不太好看。不过也得利于反省机制，做到这点也很容易：</p>
<h3 id="作用域">作用域</h3>
<p>这里提到的“作用域”的概念，是一个在范围上与 DOM 结构一致，数据上相对于某个 $scope 对象的属性的概念。我们还是从 HTML 代码上来入手：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="title">div</span> <span class="attribute">ng-controller</span>=<span class="value">"BoxCtrl"</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="title">div</span> <span class="attribute">style</span>=<span class="value">"width: 100px; height: 100px; background-color: red;"</span></span></div><div class="line">         <span class="attribute">ng-click</span>=<span class="value">"click()"</span>&gt;</div><div class="line">    <span class="tag">&lt;/<span class="title">div</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="title">p</span>&gt;</span>\{\{ w }} x \{\{ h }}<span class="tag">&lt;/<span class="title">p</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="title">p</span>&gt;</span>W: <span class="tag">&lt;<span class="title">input</span> <span class="attribute">type</span>=<span class="value">"text"</span> <span class="attribute">ng-model</span>=<span class="value">"w"</span> /&gt;</span><span class="tag">&lt;/<span class="title">p</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="title">p</span>&gt;</span>H: <span class="tag">&lt;<span class="title">input</span> <span class="attribute">type</span>=<span class="value">"text"</span> <span class="attribute">ng-model</span>=<span class="value">"h"</span> /&gt;</span><span class="tag">&lt;/<span class="title">p</span>&gt;</span></div><div class="line">  <span class="tag">&lt;/<span class="title">div</span>&gt;</span></div></pre></td></tr></table></figure>

<p>上面的代码中，我们给一个 div 元素指定了一个 BoxCtrl ，那么， div 元素之内，就是 BoxCtrl 这个函数运行时， \$scope 这个注入资源的控制范围。在代码中我们看到的 click() ， w ， h 这些东西，它们本来的位置对应于 \$scope.click ， \$scope.w ， \$scope.h 。</p>
<p>我们在后面的 js 代码中，也可以看到我们就是在操作这些变量。依赖于 ng 的数据绑定机制，操作变量的结果直接在页面上表现出来了。</p>
<h3 id="数据绑定与模板">数据绑定与模板</h3>
<h4 id="数据到模板">数据到模板</h4>
<figure class="highlight {html}"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&lt;p&gt;<span class="command">\{</span><span class="command">\{</span> w <span class="special">}</span><span class="special">}</span> x <span class="command">\{</span><span class="command">\{</span> h <span class="special">}</span><span class="special">}</span>&lt;/p&gt;</div></pre></td></tr></table></figure>

<p>其中，使用{{ }}这个标记，就可以直接引用，并绑定一个作用域内的变量。在实现上，ng 自动创建了一个 watcher 。效果就是，不管因为什么，如果作用域的变量发生了改变，我们随时可以让相应的页面表现也随之改变。</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="title">p</span> <span class="attribute">id</span>=<span class="value">"test"</span> <span class="attribute">ng-controller</span>=<span class="value">"TestCtrl"</span>&gt;</span>\{\{ a }}<span class="tag">&lt;/<span class="title">p</span>&gt;</span></div><div class="line">  </div><div class="line">  <span class="tag">&lt;<span class="title">script</span> <span class="attribute">type</span>=<span class="value">"text/javascript"</span>&gt;</span><span class="javascript"></span></div><div class="line">  <span class="keyword">var</span> TestCtrl = <span class="function"><span class="keyword">function</span><span class="params">($scope)</span></span>{</div><div class="line">    $scope.a = <span class="string">'123'</span>;</div><div class="line">  }</div><div class="line">  angular.bootstrap(<span class="built_in">document</span>.documentElement);</div></pre></td></tr></table></figure>

<p>上面的例子在页面载入之后，我们可以在页面上看到 123 。这时，我们可以打开一个终端控制器，输入</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="variable">$(</span><span class="string">'#test'</span>).scope().a = <span class="string">'12345'</span>;</div><div class="line"><span class="variable">$(</span><span class="string">'#test'</span>).scope().<span class="variable">$digest</span>();</div></pre></td></tr></table></figure>

<p>上面的代码执行之后，就可以看到页面变化了。<br>对于使用 ng 进行的事件绑定，在处理函数中就不需要去关心 \$digest() 的调用了。因为 ng 会自己处理。源码中，对于 ng 的事件绑定，真正的处理函数不是指定名字的函数，而是经过 \$apply() 包装过的一个函数。这个 \$apply() 做的一件事，就是调用根作用域 \$rootScope 的 \$digest() ，这样整个世界就清净了：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="title">p</span> <span class="attribute">id</span>=<span class="value">"test"</span> <span class="attribute">ng-controller</span>=<span class="value">"TestCtrl"</span> <span class="attribute">ng-click</span>=<span class="value">"click()"</span>&gt;</span>\{\{ a }}<span class="tag">&lt;/<span class="title">p</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="title">script</span> <span class="attribute">type</span>=<span class="value">"text/javascript"</span> <span class="attribute">charset</span>=<span class="value">"utf-8"</span>&gt;</span><span class="javascript"></span></div><div class="line">  <span class="keyword">var</span> TestCtrl = <span class="function"><span class="keyword">function</span><span class="params">($scope)</span></span>{</div><div class="line">    $scope.a = <span class="string">'123'</span>;</div><div class="line">  </div><div class="line">    $scope.click = <span class="function"><span class="keyword">function</span><span class="params">()</span></span>{</div><div class="line">      $scope.a = <span class="string">'456'</span>;</div><div class="line">    }</div><div class="line">  }</div><div class="line">  angular.bootstrap(<span class="built_in">document</span>.documentElement);</div></pre></td></tr></table></figure>

<p>那个 click 函数的定义，绑定时变成了类似于：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span><span class="params">()</span></span>{</div><div class="line">    <span class="variable">$scope</span>.<span class="variable">$apply</span>(</div><div class="line">      <span class="function"><span class="keyword">function</span><span class="params">()</span></span>{</div><div class="line">        <span class="variable">$scope</span>.click();</div><div class="line">      }</div><div class="line">    )</div><div class="line">  }</div></pre></td></tr></table></figure>

<p>这里的 \$scope.\$apply() 中做的一件事：\$rootScope.\$digest();</p>
<h4 id="模板到数据">模板到数据</h4>
<p>模板到数据的绑定，主要是通过 ng-model 来完成的：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="title">input</span> <span class="attribute">type</span>=<span class="value">"text"</span> <span class="attribute">id</span>=<span class="value">"test"</span> <span class="attribute">ng-controller</span>=<span class="value">"TestCtrl"</span> <span class="attribute">ng-model</span>=<span class="value">"a"</span> /&gt;</span></div><div class="line">  </div><div class="line">  <span class="tag">&lt;<span class="title">script</span> <span class="attribute">type</span>=<span class="value">"text/javascript"</span> <span class="attribute">charset</span>=<span class="value">"utf-8"</span>&gt;</span><span class="javascript"></span></div><div class="line">  <span class="keyword">var</span> TestCtrl = <span class="function"><span class="keyword">function</span><span class="params">($scope)</span></span>{</div><div class="line">    $scope.a = <span class="string">'123'</span>;</div><div class="line">  }</div></pre></td></tr></table></figure>

<p>这时修改 input 中的值，然后再在控制终端中使用：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$('<span class="comment">#test').scope().a</span></div></pre></td></tr></table></figure>

<p>查看，发现变量 a 的值已经更改了。<br>实际上， ng-model 是把两个方向的绑定都做了。它不光显示出变量的值，也把显示上的数值变化反映给了变量。这个在实现上就简单多了，只是绑定 change 事件，然后做一些赋值操作即可。不过 ng 里，还要区分对待不同的控件。</p>
<h3 id="模版数据模板综合">模版数据模板综合</h3>
<p>现在要考虑的是一种在现实中很普遍的一个需求。比如就是我们可以输入数值，来控制一个矩形的长度。在这里，数据与表现的关系是：</p>
<p>1.长度数值保存在变量中<br>2.变量显示于某个 input 中<br>3.变量的值即是矩形的长度<br>4.input 中的值变化时，变量也要变化<br>5.input 中的值变化时，矩形的长度也要变化</p>
<p>当然，要实现目的在这里可能就不止一种方案了。按照以前的做法，很自然地会想法，绑定 input 的 change 事件，然后去做一些事就好了。但是，我们前面提到过 ng-model 这个东西，利用它就可以在不手工处理 change 的条件下完成数据的展现需求，在此基础之上，我们还需要做的一点，就是把变化后的数据应用到矩形的长度之上。</p>
<p>最开始，我们面对的应该是这样一个东西：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="title">div</span> <span class="attribute">ng-controller</span>=<span class="value">"TestCtrl"</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="title">div</span> <span class="attribute">style</span>=<span class="value">"width: 100px; height: 10px; background-color: red"</span>&gt;</span><span class="tag">&lt;/<span class="title">div</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="title">input</span> <span class="attribute">type</span>=<span class="value">"text"</span> <span class="attribute">name</span>=<span class="value">"width"</span> <span class="attribute">ng-model</span>=<span class="value">"width"</span> /&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="title">div</span>&gt;</span></div><div class="line"></div><div class="line"><span class="tag">&lt;<span class="title">script</span> <span class="attribute">type</span>=<span class="value">"text/javascript"</span> <span class="attribute">charset</span>=<span class="value">"utf-8"</span>&gt;</span><span class="javascript"></span></div><div class="line"><span class="keyword">var</span> TestCtrl = <span class="function"><span class="keyword">function</span><span class="params">($scope)</span></span>{</div><div class="line">  $scope.width = <span class="number">100</span>;</div><div class="line">}</div><div class="line">angular.bootstrap(<span class="built_in">document</span>.documentElement);</div><div class="line"><span class="tag">&lt;/<span class="title">script</span>&gt;</span></div></pre></td></tr></table></figure>

<p>我们从响应数据变化，但又不使用 change 事件的角度来看，可以这样处理宽度变化：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> TestCtrl = <span class="function"><span class="keyword">function</span><span class="params">(<span class="variable">$scope</span>, <span class="variable">$element</span>)</span></span>{</div><div class="line">  <span class="variable">$scope</span>.width = <span class="number">100</span>;</div><div class="line">  <span class="variable">$scope</span>.<span class="variable">$watch</span>(<span class="string">'width'</span>,</div><div class="line">    <span class="function"><span class="keyword">function</span><span class="params">(to, from)</span></span>{</div><div class="line">      <span class="variable">$element</span>.children(<span class="string">':first'</span>).width(to);</div><div class="line">    }</div><div class="line">  );</div><div class="line">}</div></pre></td></tr></table></figure>

<p>使用 $watch() 来绑定数据变化。</p>
<p>当然，这种样式的问题，有更直接有效的手段， ng 的数据绑定总是让人惊异：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="title">div</span> <span class="attribute">ng-controller</span>=<span class="value">"TestCtrl"</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="title">div</span> <span class="attribute">style</span>=<span class="value">"width: 10px; height: 10px; background-color: red"</span> <span class="attribute">ng-style</span>=<span class="value">"style"</span>&gt;</span></div><div class="line">  <span class="tag">&lt;/<span class="title">div</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="title">input</span> <span class="attribute">type</span>=<span class="value">"text"</span> <span class="attribute">name</span>=<span class="value">"width"</span> <span class="attribute">ng-model</span>=<span class="value">"style.width"</span> /&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="title">div</span>&gt;</span></div><div class="line"></div><div class="line"></div><div class="line"><span class="tag">&lt;<span class="title">script</span> <span class="attribute">type</span>=<span class="value">"text/javascript"</span> <span class="attribute">charset</span>=<span class="value">"utf-8"</span>&gt;</span><span class="javascript"></span></div><div class="line"><span class="keyword">var</span> TestCtrl = <span class="function"><span class="keyword">function</span><span class="params">($scope)</span></span>{</div><div class="line">  $scope.style = {width: <span class="number">100</span> + <span class="string">'px'</span>};</div><div class="line">}</div><div class="line">angular.bootstrap(<span class="built_in">document</span>.documentElement);</div><div class="line"><span class="tag">&lt;/<span class="title">script</span>&gt;</span></div></pre></td></tr></table></figure>

<h3 id="模板">模板</h3>
<p>前面讲了数据绑定之后，现在可以单独讲讲模板了。</p>
<p>作为一套能称之谓“模板”的系统，除了能干一些模板的常规的事之外（好吧，即使是常规的逻辑判断现在它也做不了的），配合作用域 \$scope 和 ng 的数据双向绑定机制， ng 的模板系统就变得比较神奇了。<br>定义模板的内容现在有三种方式：</p>
<ol>
<li>在需要的地方直接写字符串</li>
<li>外部文件</li>
<li>使用 script 标签定义的“内部文件”<br>第一种不需要多说。第二种和第三种都可以和 ng-include 一起工作，来引入一段模板。</li>
</ol>
<p>直接引入同域的外部文件作为模板的一部分：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">&lt;<span class="operator">div</span> ng-<span class="built_in">include</span> src=<span class="string">"'tpl.html'"</span>&gt;</div><div class="line"> &lt;/<span class="operator">div</span>&gt;</div><div class="line"> </div><div class="line"> &lt;<span class="operator">div</span> ng-<span class="built_in">include</span>=<span class="string">"'tpl.html'"</span>&gt;</div><div class="line"> &lt;/<span class="operator">div</span>&gt;</div></pre></td></tr></table></figure>

<p>注意， src 中的字符串会作为表达式处理（可以是 $scope 中的变量），所以，直接写名字的话需要使用引号。</p>
<p>引入 script 定义的“内部文件”：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="title">script</span> <span class="attribute">type</span>=<span class="value">"text/ng-template"</span> <span class="attribute">id</span>=<span class="value">"tpl"</span>&gt;</span><span class="javascript"></span></div><div class="line"> here, \{\{ <span class="number">1</span> + <span class="number">1</span> }}</div><div class="line"> <span class="tag">&lt;/<span class="title">script</span>&gt;</span></div><div class="line"> </div><div class="line"> <span class="tag">&lt;<span class="title">div</span> <span class="attribute">ng-include</span> <span class="attribute">src</span>=<span class="value">"'tpl'"</span>&gt;</span><span class="tag">&lt;/<span class="title">div</span>&gt;</span></div></pre></td></tr></table></figure>

<p>配合变量使用：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="title">script</span> <span class="attribute">type</span>=<span class="value">"text/ng-template"</span> <span class="attribute">id</span>=<span class="value">"tpl"</span>&gt;</span><span class="javascript"></span></div><div class="line"> here, \{\{ <span class="number">1</span> + <span class="number">1</span> }}</div><div class="line"> <span class="tag">&lt;/<span class="title">script</span>&gt;</span></div><div class="line"> </div><div class="line"> <span class="tag">&lt;<span class="title">a</span> <span class="attribute">ng-click</span>=<span class="value">"v='tpl'"</span>&gt;</span>Load<span class="tag">&lt;/<span class="title">a</span>&gt;</span></div><div class="line"> <span class="tag">&lt;<span class="title">div</span> <span class="attribute">ng-include</span> <span class="attribute">src</span>=<span class="value">"v"</span>&gt;</span><span class="tag">&lt;/<span class="title">div</span>&gt;</span></div></pre></td></tr></table></figure>

<h3 id="内容渲染控制">内容渲染控制</h3>
<h4 id="ng-repeat">ng-repeat</h4>
<p>这算是唯一的一个控制标签么……，它的使用方法：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="title">div</span> <span class="attribute">ng-controller</span>=<span class="value">"TestCtrl"</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="title">ul</span> <span class="attribute">ng-repeat</span>=<span class="value">"member in obj_list"</span>&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="title">li</span>&gt;</span>\{\{ member }}<span class="tag">&lt;/<span class="title">li</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="title">ul</span>&gt;</span></div><div class="line">  <span class="tag">&lt;/<span class="title">div</span>&gt;</span></div><div class="line">  </div><div class="line">  </div><div class="line">  var TestCtrl = function($scope){</div><div class="line">    $scope.obj_list = [1,2,3,4];</div><div class="line">  }</div></pre></td></tr></table></figure>

<p>除此之外，它还提供了几个变量可供使用：</p>
<ol>
<li>\$index 当前索引</li>
<li>\$first 是否为头元素</li>
<li>\$middle 是否为非头非尾元素</li>
<li>\$last 是否为尾元素</li>
</ol>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">&lt;div ng-controller=<span class="string">"TestCtrl"</span>&gt;</div><div class="line">    &lt;ul ng-repeat=<span class="string">"member in obj_list"</span>&gt;</div><div class="line">      &lt;li&gt;\{\{ <span class="variable">$index</span> }}, \{\{ member.name }}&lt;/li&gt;</div><div class="line">    &lt;/ul&gt;</div><div class="line">  &lt;/div&gt;</div><div class="line">  </div><div class="line">  <span class="keyword">var</span> TestCtrl = <span class="function"><span class="keyword">function</span><span class="params">(<span class="variable">$scope</span>)</span></span>{</div><div class="line">    <span class="variable">$scope</span>.obj_list = [{name: <span class="string">'A'</span>}, {name: <span class="string">'B'</span>}, {name: <span class="string">'C'</span>}];</div><div class="line">  }</div></pre></td></tr></table></figure>

<h4 id="赋值_ng-init">赋值 ng-init</h4>
<p>这个指令可以在模板中直接赋值，它作用于 angular.bootstrap 之前，并且，定义的变量与 \$scope 作用域无关。</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="title">div</span> <span class="attribute">ng-controller</span>=<span class="value">"TestCtrl"</span> <span class="attribute">ng-init</span>=<span class="value">"a=[1,2,3,4];"</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="title">ul</span> <span class="attribute">ng-repeat</span>=<span class="value">"member in a"</span>&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="title">li</span>&gt;</span>\{\{ member }}<span class="tag">&lt;/<span class="title">li</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="title">ul</span>&gt;</span></div><div class="line">  <span class="tag">&lt;/<span class="title">div</span>&gt;</span></div></pre></td></tr></table></figure>

<h3 id="节点控制">节点控制</h3>
<h4 id="样式_ng-style">样式 ng-style</h4>
<p>可以使用一个结构直接表示当前节点的样式：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">&lt;<span class="keyword">div</span> ng-style=<span class="string">"{width: 100 + 'px', height: 100 + 'px', backgroundColor: 'red'}"</span>&gt;</div><div class="line">  &lt;/<span class="keyword">div</span>&gt;</div></pre></td></tr></table></figure>

<p>同样地，绑定一个变量的话，威力大了</p>
<h4 id="类_ng-class">类 ng-class</h4>
<p>就是直接地设置当前节点的类，同样，配合数据绑定作用就大了：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">&lt;<span class="keyword">div</span> ng-controller=<span class="string">"TestCtrl"</span> ng-<span class="type">class</span>=<span class="string">"cls"</span>&gt;</div><div class="line">  &lt;/<span class="keyword">div</span>&gt;</div></pre></td></tr></table></figure>

<p>ng-class-even 和 ng-class-odd 是和 ng-repeat 配合使用的：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="title">ul</span> <span class="attribute">ng-init</span>=<span class="value">"l=[1,2,3,4]"</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="title">li</span> <span class="attribute">ng-class-odd</span>=<span class="value">"'odd'"</span> <span class="attribute">ng-class-even</span>=<span class="value">"'even'"</span> <span class="attribute">ng-repeat</span>=<span class="value">"m in l"</span>&gt;</span>\{\{ m }}<span class="tag">&lt;/<span class="title">li</span>&gt;</span></div><div class="line">  <span class="tag">&lt;/<span class="title">ul</span>&gt;</span></div></pre></td></tr></table></figure>

<p>注意里面给的还是表示式，别少了引号。</p>
<h4 id="显示和隐藏_ng-show_ng-hide_ng-switch">显示和隐藏 ng-show ng-hide ng-switch</h4>
<p>前两个是控制 display 的指令：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">&lt;<span class="keyword">div</span> ng-show=<span class="string">"true"</span>&gt;<span class="number">1</span>&lt;/<span class="keyword">div</span>&gt;</div><div class="line">&lt;<span class="keyword">div</span> ng-show=<span class="string">"false"</span>&gt;<span class="number">2</span>&lt;/<span class="keyword">div</span>&gt;</div><div class="line">&lt;<span class="keyword">div</span> ng-hide=<span class="string">"true"</span>&gt;<span class="number">3</span>&lt;/<span class="keyword">div</span>&gt;</div><div class="line">&lt;<span class="keyword">div</span> ng-hide=<span class="string">"false"</span>&gt;<span class="number">4</span>&lt;/<span class="keyword">div</span>&gt;</div></pre></td></tr></table></figure>

<p>后一个 ng-switch 是根据一个值来决定哪个节点显示，其它节点移除：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="title">div</span> <span class="attribute">ng-init</span>=<span class="value">"a=2"</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="title">ul</span> <span class="attribute">ng-switch</span> <span class="attribute">on</span>=<span class="value">"a"</span>&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="title">li</span> <span class="attribute">ng-switch-when</span>=<span class="value">"1"</span>&gt;</span>1<span class="tag">&lt;/<span class="title">li</span>&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="title">li</span> <span class="attribute">ng-switch-when</span>=<span class="value">"2"</span>&gt;</span>2<span class="tag">&lt;/<span class="title">li</span>&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="title">li</span> <span class="attribute">ng-switch-default</span>&gt;</span>other<span class="tag">&lt;/<span class="title">li</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="title">ul</span>&gt;</span></div><div class="line">  <span class="tag">&lt;/<span class="title">div</span>&gt;</span></div></pre></td></tr></table></figure>

<h4 id="其它属性控制">其它属性控制</h4>
<p>ng-src 控制 src 属性：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&lt;img ng-src=<span class="string">"\{\{ 'h' + 'ead.png' }}"</span> /&gt;</div></pre></td></tr></table></figure>

<p>ng-href 控制 href 属性：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&lt;a ng-href=<span class="string">"\{\{ '#' + '123' }}"</span>&gt;here&lt;/a&gt;</div></pre></td></tr></table></figure>

<p>总的来说：</p>
<ol>
<li>ng-src src属性</li>
<li>ng-href href属性</li>
<li>ng-checked 选中状态</li>
<li>ng-selected 被选择状态</li>
<li>ng-disabled 禁用状态</li>
<li>ng-multiple 多选状态</li>
<li>ng-readonly 只读状态<br>注意： 上面的这些只是单向绑定，即只是从数据到展示，不能反作用于数据。要双向绑定，还是要使用 ng-model </li>
</ol>
<h3 id="事件绑定">事件绑定</h3>
<p>事件绑定是模板指令中很好用的一部分。我们可以把相关事件的处理函数直接写在 DOM 中，这样做的最大好处就是可以从 DOM 结构上看出业务处理的形式，你知道当你点击这个节点时哪个函数被执行了。</p>
<p>ng-change<br>ng-click<br>ng-blur<br>ng-dblclick<br>ng-mousedown<br>ng-mouseenter<br>ng-mouseleave<br>ng-mousemove<br>ng-mouseover<br>ng-mouseup<br>ng-submit<br>对于事件对象本身，在函数调用时可以直接使用 $event 进行传递：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="title">p</span> <span class="attribute">ng-click</span>=<span class="value">"click($event)"</span>&gt;</span>点击<span class="tag">&lt;/<span class="title">p</span>&gt;</span></div><div class="line"> <span class="tag">&lt;<span class="title">p</span> <span class="attribute">ng-click</span>=<span class="value">"click($event.target)"</span>&gt;</span>点击<span class="tag">&lt;/<span class="title">p</span>&gt;</span></div></pre></td></tr></table></figure>

<h3 id="表单控件">表单控件</h3>
<p>表单控件类的模板指令，最大的作用是它预定义了需要绑定的数据的格式。这样，就可以对于既定的数据进行既定的处理。</p>
<h4 id="form">form</h4>
<p>form 是核心的一个控件。 ng 对 form 这个标签作了包装。事实上， ng 自己的指令是叫 ng-form 的，区别在于， form 标签不能嵌套，而使用 ng-form 指令就可以做嵌套的表单了。</p>
<p>form 的行为中依赖它里面的各个输入控制的状态的，在这里，我们主要关心的是 form 自己的一些方法和属性。从 ng 的角度来说， form 标签，是一个模板指令，也创建了一个 FormController 的实例。这个实例就提供了相应的属性和方法。同时，它里面的控件也是一个 NgModelController 实例。</p>
<p>很重要的一点， form 的相关方法要生效，必须为 form 标签指定 name 和 ng-controller ，并且每个控件都要绑定一个变量。 form 和控件的名字，即是 $scope 中的相关实例的引用变量名。</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">&lt;form name=<span class="string">"test_form"</span> ng-controller=<span class="string">"TestCtrl"</span>&gt;</div><div class="line">    &lt;input type=<span class="string">"text"</span> name=<span class="string">"a"</span> required ng-model=<span class="string">"a"</span>  /&gt;</div><div class="line">    &lt;span ng-click=<span class="string">"see()"</span>&gt;\{\{ test_form.<span class="variable">$valid</span> }}&lt;/span&gt;</div><div class="line">  &lt;/form&gt;</div><div class="line">  </div><div class="line">  <span class="keyword">var</span> TestCtrl = <span class="function"><span class="keyword">function</span><span class="params">(<span class="variable">$scope</span>)</span></span>{</div><div class="line">  </div><div class="line">    <span class="variable">$scope</span>.see = <span class="function"><span class="keyword">function</span><span class="params">()</span></span>{</div><div class="line">      console.log(<span class="variable">$scope</span>.test_form);</div><div class="line">      console.log(<span class="variable">$scope</span>.test_form.a);</div><div class="line">    }</div><div class="line">  </div><div class="line">  }</div></pre></td></tr></table></figure>

<p>除去对象的方法与属性， form 这个标签本身有一些动态类可以使用：<br><em>ng-valid</em> 当表单验证通过时的设置<br><em>ng-invalid</em> 当表单验证失败时的设置<br><em>ng-pristine</em> 表单的未被动之前拥有<br><em>ng-dirty</em> 表单被动过之后拥有<br>form 对象的属性有：<br>1.\$pristine 表单是否未被动过</p>
<ol>
<li>\$dirty 表单是否被动过</li>
<li>\$valid 表单是否验证通过<br>4.\$invalid 表单是否验证失败<br>5.\$error 表单的验证错误<br>其中的 $error 对象包含有所有字段的验证信息，及对相关字段的 NgModelController 实例的引用。它的结构是一个对象， key 是失败信息， required ， minlength 之类的， value 是对应的字段实例列表。</li>
</ol>
<p>注意，这里的失败信息是按序列取的一个。比如，如果一个字段既要求 required ，也要求 minlength ，那么当它为空时， $error 中只有 required 的失败信息。只输入一个字符之后， required 条件满足了，才可能有 minlength 这个失败信息。</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">&lt;form name=<span class="string">"test_form"</span> ng-controller=<span class="string">"TestCtrl"</span>&gt;</div><div class="line">  &lt;input type=<span class="string">"text"</span> name=<span class="string">"a"</span> required ng-model=<span class="string">"a"</span>  /&gt;</div><div class="line">  &lt;input type=<span class="string">"text"</span> name=<span class="string">"b"</span> required ng-model=<span class="string">"b"</span> ng-minlength=<span class="string">"2"</span> /&gt;</div><div class="line">  &lt;span ng-click=<span class="string">"see()"</span>&gt;\{\{ test_form.<span class="variable">$error</span> }}&lt;/span&gt;</div><div class="line">&lt;/form&gt;</div><div class="line"></div><div class="line"><span class="keyword">var</span> TestCtrl = <span class="function"><span class="keyword">function</span><span class="params">(<span class="variable">$scope</span>)</span></span>{</div><div class="line">  <span class="variable">$scope</span>.see = <span class="function"><span class="keyword">function</span><span class="params">()</span></span>{</div><div class="line">    console.log(<span class="variable">$scope</span>.test_form.<span class="variable">$error</span>);</div><div class="line">  }</div><div class="line">}</div></pre></td></tr></table></figure>

<h4 id="input">input</h4>
<p>input 是数据的最主要入口。 ng 支持 HTML5 中的相关属性，同时对旧浏览器也做了兼容性处理。最重要的， input 的规则定义，是所属表单的相关行为的参照（比如表单是否验证成功）。</p>
<p>input 控件的相关可用属性为：</p>
<p>1.name 名字<br>2.ng-model 绑定的数据<br>3.required 是否必填<br>4.ng-required 是否必填<br>5.ng-minlength 最小长度<br>6.ng-maxlength 最大长度<br>7.ng-pattern 匹配模式<br>8.ng-change 值变化时的回调</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">&lt;form <span class="variable">name=</span><span class="string">"test_form"</span> <span class="variable">ng-controller=</span><span class="string">"TestCtrl"</span>&gt;</div><div class="line">   &lt;input <span class="variable">type=</span><span class="string">"text"</span> <span class="variable">name=</span><span class="string">"a"</span> <span class="variable">ng-model=</span><span class="string">"a"</span> required <span class="variable">ng-pattern=</span><span class="string">"/abc/"</span> /&gt;</div><div class="line">   &lt;span <span class="variable">ng-click=</span><span class="string">"see()"</span>&gt;\{\{ test_form.$error }}&lt;/span&gt;</div><div class="line"> &lt;/form&gt;</div></pre></td></tr></table></figure>

<p>input 控件，它还有一些扩展，这些扩展有些有自己的属性：</p>
<ol>
<li>input type=”number” 多了 number 错误类型，多了 max ， min 属性。</li>
<li>input type=”url” 多了 url 错误类型。</li>
<li>input type=”email” 多了 email 错误类型。<h4 id="checkbox">checkbox</h4>
它也算是 input 的扩展，不过，它没有验证相关的东西，只有选中与不选中两个值：</li>
</ol>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">&lt;form name=<span class="string">"test_form"</span> ng-controller=<span class="string">"TestCtrl"</span>&gt;</div><div class="line">    &lt;input type=<span class="string">"checkbox"</span> name=<span class="string">"a"</span> ng-model=<span class="string">"a"</span> ng-<span class="keyword">true</span>-value=<span class="string">"AA"</span> ng-<span class="keyword">false</span>-value=<span class="string">"BB"</span> /&gt;</div><div class="line">    &lt;span&gt;\{\{ a }}&lt;/span&gt;</div><div class="line">  &lt;/form&gt;</div><div class="line">  </div><div class="line">  <span class="keyword">var</span> TestCtrl = <span class="function"><span class="keyword">function</span><span class="params">(<span class="variable">$scope</span>)</span></span>{</div><div class="line">    <span class="variable">$scope</span>.a = <span class="string">'AA'</span>;</div><div class="line">  }</div></pre></td></tr></table></figure>

<p>两点：</p>
<p>1.controller 要初始化变量值。<br>2.controller 中的初始化值会关系到控件状态（双向绑定）。</p>
<h4 id="radio,textarea">radio,textarea</h4>
<p>也是 input 的扩展。和 checkbox 一样，但radio只有一个值了：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">&lt;form <span class="variable">name=</span><span class="string">"test_form"</span> <span class="variable">ng-controller=</span><span class="string">"TestCtrl"</span>&gt;</div><div class="line">    &lt;input <span class="variable">type=</span><span class="string">"radio"</span> <span class="variable">name=</span><span class="string">"a"</span> <span class="variable">ng-model=</span><span class="string">"a"</span> <span class="variable">value=</span><span class="string">"AA"</span> /&gt;</div><div class="line">    &lt;input <span class="variable">type=</span><span class="string">"radio"</span> <span class="variable">name=</span><span class="string">"a"</span> <span class="variable">ng-model=</span><span class="string">"a"</span> <span class="variable">value=</span><span class="string">"BB"</span> /&gt;</div><div class="line">    &lt;span&gt;\{\{ a }}&lt;/span&gt;</div><div class="line">  &lt;/form&gt;</div></pre></td></tr></table></figure>

<p>textarea同input</p>
<h4 id="select">select</h4>
<p>这是一个比较牛B的控件。它里面的一个叫做 ng-options 的属性用于数据呈现。</p>
<p>对于给定列表时的使用。</p>
<p>最简单的使用方法， x for x in list ：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="title">form</span> <span class="attribute">name</span>=<span class="value">"test_form"</span> <span class="attribute">ng-controller</span>=<span class="value">"TestCtrl"</span> <span class="attribute">ng-init</span>=<span class="value">"o=[0,1,2,3]; a=o[1];"</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="title">select</span> <span class="attribute">ng-model</span>=<span class="value">"a"</span> <span class="attribute">ng-options</span>=<span class="value">"x for x in o"</span> <span class="attribute">ng-change</span>=<span class="value">"show()"</span>&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="title">option</span> <span class="attribute">value</span>=<span class="value">""</span>&gt;</span>可以加这个空值<span class="tag">&lt;/<span class="title">option</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="title">select</span>&gt;</span></div><div class="line">  <span class="tag">&lt;/<span class="title">form</span>&gt;</span></div><div class="line">  </div><div class="line">  <span class="tag">&lt;<span class="title">script</span> <span class="attribute">type</span>=<span class="value">"text/javascript"</span>&gt;</span><span class="javascript"></span></div><div class="line">  <span class="keyword">var</span> TestCtrl = <span class="function"><span class="keyword">function</span><span class="params">($scope)</span></span>{</div><div class="line">    $scope.show = <span class="function"><span class="keyword">function</span><span class="params">()</span></span>{</div><div class="line">      <span class="built_in">console</span>.log($scope.a);</div><div class="line">    }</div><div class="line">  }</div><div class="line">  </div><div class="line">  angular.bootstrap(<span class="built_in">document</span>.documentElement);</div><div class="line">  <span class="tag">&lt;/<span class="title">script</span>&gt;</span></div></pre></td></tr></table></figure>

<p>在 $scope 中， select 绑定的变量，其值和普通的 value 无关，可以是一个对象：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">&lt;form <span class="variable">name=</span><span class="string">"test_form"</span> <span class="variable">ng-controller=</span><span class="string">"TestCtrl"</span></div><div class="line">       <span class="variable">ng-init=</span><span class="string">"o=[{name: 'AA'}, {name: 'BB'}]; a=o[1];"</span>&gt;</div><div class="line">   &lt;select <span class="variable">ng-model=</span><span class="string">"a"</span> <span class="variable">ng-options=</span><span class="string">"x.name for x in o"</span> <span class="variable">ng-change=</span><span class="string">"show()"</span>&gt;</div><div class="line">   &lt;/select&gt;</div><div class="line"> &lt;/form&gt;</div></pre></td></tr></table></figure>

<p>显示与值分别指定， x.v as x.name for x in o ：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">&lt;form <span class="variable">name=</span><span class="string">"test_form"</span> <span class="variable">ng-controller=</span><span class="string">"TestCtrl"</span></div><div class="line">        <span class="variable">ng-init=</span><span class="string">"o=[{name: 'AA', v: '00'}, {name: 'BB', v: '11'}]; a=o[1].v;"</span>&gt;</div><div class="line">    &lt;select <span class="variable">ng-model=</span><span class="string">"a"</span> <span class="variable">ng-options=</span><span class="string">"x.v as x.name for x in o"</span> <span class="variable">ng-change=</span><span class="string">"show()"</span>&gt;</div><div class="line">    &lt;/select&gt;</div><div class="line">  &lt;/form&gt;</div></pre></td></tr></table></figure>

<p>加入分组的， x.name group by x.g for x in o ：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">&lt;form <span class="variable">name=</span><span class="string">"test_form"</span> <span class="variable">ng-controller=</span><span class="string">"TestCtrl"</span></div><div class="line">        <span class="variable">ng-init=</span><span class="string">"o=[{name: 'AA', g: '00'}, {name: 'BB', g: '11'}, {name: 'CC', g: '00'}]; a=o[1];"</span>&gt;</div><div class="line">    &lt;select <span class="variable">ng-model=</span><span class="string">"a"</span> <span class="variable">ng-options=</span><span class="string">"x.name group by x.g for x in o"</span> <span class="variable">ng-change=</span><span class="string">"show()"</span>&gt;</div><div class="line">    &lt;/select&gt;</div><div class="line">  &lt;/form&gt;</div></pre></td></tr></table></figure>

<p>分组了还分别指定显示与值的， x.v as x.name group by x.g for x in o ：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">&lt;form name=<span class="string">"test_form"</span> ng-controller=<span class="string">"TestCtrl"</span> ng-init=<span class="string">"o=[{name: '</span><span class="transposed_variable">AA'</span>, g: <span class="string">'00'</span>, v: <span class="string">'='</span>}, {name: <span class="string">'BB'</span>, g: <span class="string">'11'</span>, v: <span class="string">'+'</span>}, {name: <span class="string">'CC'</span>, g: <span class="string">'00'</span>, v: <span class="string">'!'</span>}]; a=o<span class="matrix">[<span class="number">1</span>].</span>v;<span class="string">"&gt;</span></div><div class="line">   &lt;select ng-model="a<span class="string">" ng-options="</span><span class="transposed_variable">x.</span>v as <span class="transposed_variable">x.</span>name group by <span class="transposed_variable">x.</span>g <span class="keyword">for</span> x in o<span class="string">" ng-change="</span>show()<span class="string">"&gt;</span></div><div class="line">   &lt;/select&gt;</div><div class="line"> &lt;/form&gt;</div></pre></td></tr></table></figure>

<p>如果参数是对象的话，基本也是一样的，只是把遍历的对象改成 (key, value) ：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line">&lt;form <span class="variable">name=</span><span class="string">"test_form"</span> <span class="variable">ng-controller=</span><span class="string">"TestCtrl"</span> <span class="variable">ng-init=</span><span class="string">"o={a: 0, b: 1}; a=o.a;"</span>&gt;</div><div class="line">    &lt;select <span class="variable">ng-model=</span><span class="string">"a"</span> <span class="variable">ng-options=</span><span class="string">"k for (k, v) in o"</span> <span class="variable">ng-change=</span><span class="string">"show()"</span>&gt;</div><div class="line">    &lt;/select&gt;</div><div class="line">  &lt;/form&gt;</div><div class="line">  </div><div class="line">  &lt;form <span class="variable">name=</span><span class="string">"test_form"</span> <span class="variable">ng-controller=</span><span class="string">"TestCtrl"</span></div><div class="line">        <span class="variable">ng-init=</span><span class="string">"o={a: {name: 'AA', v: '00'}, b: {name: 'BB', v: '11'}}; a=o.a.v;"</span>&gt;</div><div class="line">    &lt;select <span class="variable">ng-model=</span><span class="string">"a"</span> <span class="variable">ng-options=</span><span class="string">"v.v as v.name for (k, v) in o"</span> <span class="variable">ng-change=</span><span class="string">"show()"</span>&gt;</div><div class="line">    &lt;/select&gt;</div><div class="line">  &lt;/form&gt;</div><div class="line">  </div><div class="line">  &lt;form <span class="variable">name=</span><span class="string">"test_form"</span> <span class="variable">ng-controller=</span><span class="string">"TestCtrl"</span></div><div class="line">        <span class="variable">ng-init=</span><span class="string">"o={a: {name: 'AA', v: '00', g: '=='}, b: {name: 'BB', v: '11', g: '=='}}; a=o.a;"</span>&gt;</div><div class="line">    &lt;select <span class="variable">ng-model=</span><span class="string">"a"</span> <span class="variable">ng-options=</span><span class="string">"v.name group by v.g for (k, v) in o"</span> <span class="variable">ng-change=</span><span class="string">"show()"</span>&gt;</div><div class="line">    &lt;/select&gt;</div><div class="line">  &lt;/form&gt;</div><div class="line">  </div><div class="line">  &lt;form <span class="variable">name=</span><span class="string">"test_form"</span> <span class="variable">ng-controller=</span><span class="string">"TestCtrl"</span></div><div class="line">        <span class="variable">ng-init=</span><span class="string">"o={a: {name: 'AA', v: '00', g: '=='}, b: {name: 'BB', v: '11', g: '=='}}; a=o.a.v;"</span>&gt;</div><div class="line">    &lt;select <span class="variable">ng-model=</span><span class="string">"a"</span> <span class="variable">ng-options=</span><span class="string">"v.v as v.name group by v.g for (k, v) in o"</span> <span class="variable">ng-change=</span><span class="string">"show()"</span>&gt;</div><div class="line">    &lt;/select&gt;</div><div class="line">  &lt;/form&gt;</div></pre></td></tr></table></figure>

<h3 id="模板中的过滤器">模板中的过滤器</h3>
<p>这里说的过滤器，是用于对数据的格式化，或者筛选的函数。它们可以直接在模板中通过一种语法使用。对于常用功能来说，是很方便的一种机制。</p>
<p>多个过滤器之间可以直接连续使用。</p>
<h4 id="排序orderBy">排序orderBy</h4>
<p>orderBy是一个排序用的过滤器标签。它可以像 sort 函数那样支持一个排序函数，也可以简单地指定一个属性名进行操作：</p>
<figure class="highlight {bash}"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="title">div</span> <span class="attribute">ng-controller</span>=<span class="value">"TestCtrl"</span>&gt;</span></div><div class="line">  \{\{ data \| orderBy: 'age' }} <span class="tag">&lt;<span class="title">br</span> /&gt;</span></div><div class="line">  \{\{ data \| orderBy: '-age' }} <span class="tag">&lt;<span class="title">br</span> /&gt;</span></div><div class="line">  \{\{ data \| orderBy: '-age' \| limitTo: 2 }} <span class="tag">&lt;<span class="title">br</span> /&gt;</span></div><div class="line">  \{\{ data \| orderBy: ['-age', 'name'] }} <span class="tag">&lt;<span class="title">br</span> /&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="title">div</span>&gt;</span></div><div class="line"></div><div class="line"></div><div class="line"><span class="tag">&lt;<span class="title">script</span> <span class="attribute">type</span>=<span class="value">"text/javascript"</span>&gt;</span><span class="javascript"></span></div><div class="line"><span class="keyword">var</span> TestCtrl = <span class="function"><span class="keyword">function</span><span class="params">($scope)</span></span>{</div><div class="line">  $scope.data = [</div><div class="line">    {name: <span class="string">'B'</span>, age: <span class="number">4</span>},  </div><div class="line">    {name: <span class="string">'A'</span>, age: <span class="number">1</span>},  </div><div class="line">    {name: <span class="string">'D'</span>, age: <span class="number">3</span>},  </div><div class="line">    {name: <span class="string">'C'</span>, age: <span class="number">3</span>},  </div><div class="line">  ];</div><div class="line">}</div><div class="line"></div><div class="line">angular.bootstrap(<span class="built_in">document</span>.documentElement);</div><div class="line"><span class="tag">&lt;/<span class="title">script</span>&gt;</span></div></pre></td></tr></table></figure>

<h4 id="过滤列表_filter">过滤列表 filter</h4>
<p>filter 是一个过滤内容的标签。</p>
<p>如果参数是一个字符串，则列表成员中的任意属性值中有这个字符串，即为满足条件（忽略大小写）：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="title">div</span> <span class="attribute">ng-controller</span>=<span class="value">"TestCtrl"</span>&gt;</span></div><div class="line">  \{\{ data \| filter: 'b' }} <span class="tag">&lt;<span class="title">br</span> /&gt;</span></div><div class="line">  \{\{ data \| filter: '!B' }} <span class="tag">&lt;<span class="title">br</span> /&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="title">div</span>&gt;</span></div><div class="line"></div><div class="line"></div><div class="line"><span class="tag">&lt;<span class="title">script</span> <span class="attribute">type</span>=<span class="value">"text/javascript"</span>&gt;</span><span class="javascript"></span></div><div class="line"><span class="keyword">var</span> TestCtrl = <span class="function"><span class="keyword">function</span><span class="params">($scope)</span></span>{</div><div class="line">  $scope.data = [</div><div class="line">    {name: <span class="string">'B'</span>, age: <span class="number">4</span>},  </div><div class="line">    {name: <span class="string">'A'</span>, age: <span class="number">1</span>},  </div><div class="line">    {name: <span class="string">'D'</span>, age: <span class="number">3</span>},  </div><div class="line">    {name: <span class="string">'C'</span>, age: <span class="number">3</span>},  </div><div class="line">  ];</div><div class="line">}</div><div class="line"></div><div class="line">angular.bootstrap(<span class="built_in">document</span>.documentElement);</div><div class="line"><span class="tag">&lt;/<span class="title">script</span>&gt;</span></div></pre></td></tr></table></figure>

<p>可以使用对象，来指定属性名， $ 表示任意属性：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">\{\{ <span class="typedef"><span class="keyword">data</span> \| filter: <span class="container">{<span class="title">name</span>: '<span class="type">A</span>'}</span> }} </span></div><div class="line">\{\{ <span class="typedef"><span class="keyword">data</span> \| filter: <span class="container">{$: '3'}</span> }}</span></div><div class="line">\{\{ <span class="typedef"><span class="keyword">data</span> \| filter: <span class="container">{$: '!3'}</span> }}</span></div></pre></td></tr></table></figure>

<p>自定义的过滤函数也支持：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="title">div</span> <span class="attribute">ng-controller</span>=<span class="value">"TestCtrl"</span>&gt;</span></div><div class="line">  \{\{ data \| filter: f }} </div><div class="line"><span class="tag">&lt;/<span class="title">div</span>&gt;</span></div><div class="line"></div><div class="line"></div><div class="line"><span class="tag">&lt;<span class="title">script</span> <span class="attribute">type</span>=<span class="value">"text/javascript"</span>&gt;</span><span class="javascript"></span></div><div class="line"><span class="keyword">var</span> TestCtrl = <span class="function"><span class="keyword">function</span><span class="params">($scope)</span></span>{</div><div class="line">  $scope.data = [</div><div class="line">    {name: <span class="string">'B'</span>, age: <span class="number">4</span>},  </div><div class="line">    {name: <span class="string">'A'</span>, age: <span class="number">1</span>},  </div><div class="line">    {name: <span class="string">'D'</span>, age: <span class="number">3</span>},  </div><div class="line">    {name: <span class="string">'C'</span>, age: <span class="number">3</span>},  </div><div class="line">  ];</div><div class="line"></div><div class="line">  $scope.f = <span class="function"><span class="keyword">function</span><span class="params">(e)</span></span>{</div><div class="line">    <span class="keyword">return</span> e.age &gt; <span class="number">2</span>;</div><div class="line">  }</div><div class="line">}</div><div class="line"></div><div class="line">angular.bootstrap(<span class="built_in">document</span>.documentElement);</div><div class="line"><span class="tag">&lt;/<span class="title">script</span>&gt;</span></div></pre></td></tr></table></figure>

<h4 id="其它">其它</h4>
<p>时间戳格式化 date ：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="title">div</span> <span class="attribute">ng-controller</span>=<span class="value">"TestCtrl"</span>&gt;</span></div><div class="line">\{\{ a \| date: 'yyyy-MM-dd HH:mm:ss' }}</div><div class="line"><span class="tag">&lt;/<span class="title">div</span>&gt;</span></div><div class="line"></div><div class="line"><span class="tag">&lt;<span class="title">script</span> <span class="attribute">type</span>=<span class="value">"text/javascript"</span>&gt;</span><span class="javascript"></span></div><div class="line"><span class="keyword">var</span> TestCtrl = <span class="function"><span class="keyword">function</span><span class="params">($scope)</span></span>{</div><div class="line">  $scope.a = ((<span class="keyword">new</span> <span class="built_in">Date</span>().valueOf()));</div><div class="line">}</div><div class="line"></div><div class="line">angular.bootstrap(<span class="built_in">document</span>.documentElement);</div><div class="line"><span class="tag">&lt;/<span class="title">script</span>&gt;</span></div></pre></td></tr></table></figure>

<p>列表截取 limitTo ，支持正负数：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">\<span class="rules">{<span class="rule">\{ [1,2,3,4,5] \| <span class="attribute">limitTo</span>:<span class="value"> <span class="number">2</span> </span></span></span>}}</div><div class="line">\<span class="rules">{<span class="rule">\{ [1,2,3,4,5] \| <span class="attribute">limitTo</span>:<span class="value"> -<span class="number">3</span> </span></span></span>}}</div></pre></td></tr></table></figure>

<p>大小写 lowercase ， uppercase ：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="command">\{</span><span class="command">\{</span> 'abc' <span class="command">\|</span> uppercase <span class="special">}</span><span class="special">}</span></div><div class="line"><span class="command">\{</span><span class="command">\{</span> 'Abc' <span class="command">\|</span> lowercase <span class="special">}</span><span class="special">}</span></div></pre></td></tr></table></figure>

<h4 id="例子：表头排序">例子：表头排序</h4>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="title">div</span> <span class="attribute">ng-controller</span>=<span class="value">"TestCtrl"</span>&gt;</span></div><div class="line">     <span class="tag">&lt;<span class="title">table</span>&gt;</span></div><div class="line">       <span class="tag">&lt;<span class="title">tr</span>&gt;</span></div><div class="line">         <span class="tag">&lt;<span class="title">th</span> <span class="attribute">ng-click</span>=<span class="value">"f='name'; rev=!rev"</span>&gt;</span>名字<span class="tag">&lt;/<span class="title">th</span>&gt;</span></div><div class="line">         <span class="tag">&lt;<span class="title">th</span> <span class="attribute">ng-click</span>=<span class="value">"f='age'; rev=!rev"</span>&gt;</span>年龄<span class="tag">&lt;/<span class="title">th</span>&gt;</span></div><div class="line">       <span class="tag">&lt;/<span class="title">tr</span>&gt;</span></div><div class="line">   </div><div class="line">       <span class="tag">&lt;<span class="title">tr</span> <span class="attribute">ng-repeat</span>=<span class="value">"o in data \| orderBy: f : rev"</span>&gt;</span></div><div class="line">         <span class="tag">&lt;<span class="title">td</span>&gt;</span>\{\{ o.name }}<span class="tag">&lt;/<span class="title">td</span>&gt;</span></div><div class="line">         <span class="tag">&lt;<span class="title">td</span>&gt;</span>\{\{ o.age }}<span class="tag">&lt;/<span class="title">td</span>&gt;</span></div><div class="line">       <span class="tag">&lt;/<span class="title">tr</span>&gt;</span></div><div class="line">     <span class="tag">&lt;/<span class="title">table</span>&gt;</span></div><div class="line">   <span class="tag">&lt;/<span class="title">div</span>&gt;</span></div><div class="line">   </div><div class="line">   <span class="tag">&lt;<span class="title">script</span> <span class="attribute">type</span>=<span class="value">"text/javascript"</span>&gt;</span><span class="javascript"></span></div><div class="line">   <span class="keyword">var</span> TestCtrl = <span class="function"><span class="keyword">function</span><span class="params">($scope)</span></span>{</div><div class="line">     $scope.data = [</div><div class="line">       {name: <span class="string">'B'</span>, age: <span class="number">4</span>},  </div><div class="line">       {name: <span class="string">'A'</span>, age: <span class="number">1</span>},  </div><div class="line">       {name: <span class="string">'D'</span>, age: <span class="number">3</span>},  </div><div class="line">       {name: <span class="string">'C'</span>, age: <span class="number">3</span>},  </div><div class="line">     ];</div><div class="line">   }</div><div class="line">   </div><div class="line">   angular.bootstrap(<span class="built_in">document</span>.documentElement);</div><div class="line">   <span class="tag">&lt;/<span class="title">script</span>&gt;</span></div></pre></td></tr></table></figure>

<h4 id="例子：搜索">例子：搜索</h4>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="title">div</span> <span class="attribute">ng-controller</span>=<span class="value">"TestCtrl"</span> <span class="attribute">ng-init</span>=<span class="value">"s=data[0].name; q=''"</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="title">div</span>&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="title">span</span>&gt;</span>查找：<span class="tag">&lt;/<span class="title">span</span>&gt;</span> <span class="tag">&lt;<span class="title">input</span> <span class="attribute">type</span>=<span class="value">"text"</span> <span class="attribute">ng-model</span>=<span class="value">"q"</span> /&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="title">div</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="title">select</span> <span class="attribute">ng-multiple</span>=<span class="value">"true"</span> <span class="attribute">ng-model</span>=<span class="value">"s"</span></span></div><div class="line">            <span class="attribute">ng-options</span>=<span class="value">"o.name as o.name + '(' + o.age + ')' for o in data \| filter: {name: q} \| orderBy: ['age', 'name'] "</span>&gt;</div><div class="line">    <span class="tag">&lt;/<span class="title">select</span>&gt;</span></div><div class="line">  <span class="tag">&lt;/<span class="title">div</span>&gt;</span></div><div class="line">  </div><div class="line">  <span class="tag">&lt;<span class="title">script</span> <span class="attribute">type</span>=<span class="value">"text/javascript"</span>&gt;</span><span class="javascript"></span></div><div class="line">  <span class="keyword">var</span> TestCtrl = <span class="function"><span class="keyword">function</span><span class="params">($scope)</span></span>{</div><div class="line">    $scope.data = [</div><div class="line">      {name: <span class="string">'B'</span>, age: <span class="number">4</span>},  </div><div class="line">      {name: <span class="string">'A'</span>, age: <span class="number">1</span>},  </div><div class="line">      {name: <span class="string">'D'</span>, age: <span class="number">3</span>},  </div><div class="line">      {name: <span class="string">'C'</span>, age: <span class="number">3</span>},  </div><div class="line">    ];</div><div class="line">  }</div><div class="line">  </div><div class="line">  angular.bootstrap(<span class="built_in">document</span>.documentElement);</div><div class="line">  <span class="tag">&lt;/<span class="title">script</span>&gt;</span></div></pre></td></tr></table></figure>

<h3 id="锚点路由">锚点路由</h3>
<p>准确地说，这应该叫对 hashchange 事件的处理吧。</p>
<p>就是指 URL 中的锚点部分发生变化时，触发预先定义的业务逻辑。比如现在是 /test#/x ，锚点部分的值为 # 后的 /x ，它就对应了一组处理逻辑。当这部分变化时，比如变成了 /test#/t ，这时页面是不会刷新的，但是它可以触发另外一组处理逻辑，来做一些事，也可以让页面发生变化。</p>
<p>这种机制对于复杂的单页面来说，无疑是一种强大的业务切分手段。就算不是复杂的单页面应用，在普通页面上善用这种机制，也可以让业务逻辑更容易控制。</p>
<p>ng 提供了完善的锚点路由功能，虽然目前我觉得相当重要的一个功能还有待完善（后面会说），但目前这功能的几部分内容，已经让我思考了很多种可能性了。</p>
<p>ng 中的锚点路由功能是由几部分 API 共同完成的一整套方案。这其中包括了路由定义，参数定义，业务处理等。</p>
<h4 id="路由定义">路由定义</h4>
<p>要使用锚点路由功能，需要在先定义它。目前，对于定义的方法，我个人只发现在“初始化”阶段可以通过 $routeProvider 这个服务来定义。</p>
<p>在定义一个 app 时可以定义锚点路由：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">&lt;html ng-app=<span class="string">"ngView"</span>&gt;</div><div class="line">    <span class="keyword">...</span> <span class="keyword">...</span></div><div class="line">  </div><div class="line">  &lt;div ng-view&gt;&lt;/div&gt;</div><div class="line">  </div><div class="line">  &lt;script type=<span class="string">"text/javascript"</span>&gt;</div><div class="line">  </div><div class="line">  angular.module(<span class="string">'ngView'</span>, [],</div><div class="line">    <span class="keyword">function</span>($routeProvider){</div><div class="line">      $routeProvider.when(<span class="string">'/test'</span>,</div><div class="line">        {</div><div class="line">          template: <span class="string">'test'</span>,</div><div class="line">        }</div><div class="line">      );</div><div class="line">    }</div><div class="line">  );</div><div class="line">  </div><div class="line">  &lt;/script&gt;</div></pre></td></tr></table></figure>

<p>首先看 ng-view 这个 directive ，它是一个标记“锚点作用区”的指令。目前页面上只能有一个“锚点作用区”。有人已经提了，“多个可命名”的锚点作用区的代码到官方，但是目前官方还没有接受合并，我觉得多个作用区这个功能是很重要的，希望下个发布版中能有。</p>
<p>锚点作用区的功能，就是让锚点路由定义时的那些模板， controller 等，它们产生的 HTML 代码放在作用区内。</p>
<p>比如上面的代码，当你刚打开页面时，页面是空白的。你手动访问 /#/test 就可以看到页面上出现了 ‘test’ 的字样。</p>
<p>在 angular.bootstrap() 时也可以定义：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">angular.bootstrap(document.documentElement, [</div><div class="line">   function($routeProvider){</div><div class="line">     $routeProvider.<span class="keyword">when</span>('/test',</div><div class="line">       {</div><div class="line">         <span class="keyword">template</span>: 'test'</div><div class="line">       }</div><div class="line">     );</div><div class="line">   }</div><div class="line"> ]);</div></pre></td></tr></table></figure>

<h4 id="参数定义">参数定义</h4>
<p>在作路由定义时，可以匹配一个规则，规则中可以定义路径中的某些部分作为参数之用，然后使用 $routeParams 服务获取到指定参数。比如 /#/book/test 中， test 作为参数传入到 controller 中：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="title">div</span> <span class="attribute">ng-view</span>&gt;</span><span class="tag">&lt;/<span class="title">div</span>&gt;</span></div><div class="line"></div><div class="line"></div><div class="line"><span class="tag">&lt;<span class="title">script</span> <span class="attribute">type</span>=<span class="value">"text/javascript"</span>&gt;</span><span class="javascript"></span></div><div class="line"></div><div class="line">angular.module(<span class="string">'ngView'</span>, [],</div><div class="line">  <span class="function"><span class="keyword">function</span><span class="params">($routeProvider)</span></span>{</div><div class="line">    $routeProvider.when(<span class="string">'/book/:title'</span>,</div><div class="line">      {</div><div class="line">        template: <span class="string">'\{\{ title }}'</span>,</div><div class="line">        controller: <span class="function"><span class="keyword">function</span><span class="params">($scope, $routeParams)</span></span>{</div><div class="line">          $scope.title = $routeParams.title;</div><div class="line">        }</div><div class="line">      }</div><div class="line">    );</div><div class="line">  }</div><div class="line">);</div><div class="line"></div><div class="line"><span class="tag">&lt;/<span class="title">script</span>&gt;</span></div></pre></td></tr></table></figure>

<p>访问： /#/book/test</p>
<p>不需要预定义模式，也可以像普通 GET 请求那样获取到相关参数：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">angular.module(<span class="string">'ngView'</span>, [],</div><div class="line">  <span class="function"><span class="keyword">function</span><span class="params">(<span class="variable">$routeProvider</span>)</span></span>{</div><div class="line">    <span class="variable">$routeProvider</span>.when(<span class="string">'/book'</span>,</div><div class="line">      {</div><div class="line">        template: <span class="string">'\{\{ title }}'</span>,</div><div class="line">        controller: <span class="function"><span class="keyword">function</span><span class="params">(<span class="variable">$scope</span>, <span class="variable">$routeParams</span>)</span></span>{</div><div class="line">          <span class="variable">$scope</span>.title = <span class="variable">$routeParams</span>.title;</div><div class="line">        }</div><div class="line">      }</div><div class="line">    );</div><div class="line">  }</div><div class="line">);</div></pre></td></tr></table></figure>

<p>访问： /#/book?title=test</p>
<h4 id="业务处理">业务处理</h4>
<p>简单来说，当一个锚点路由定义被匹配时，会根据模板生成一个 \$scope ，同时相应的一个 controller 就会被触发。最后模板的结果会被填充到 ng-view 中去。</p>
<p>从上面的例子中可以看到，最直接的方式，我们可以在模板中双向绑定数据，而数据的来源，在 controller 中控制。在 controller 中，又可以使用到像 \$scope ， \$routeParams 这些服务。</p>
<p>这里先提一下另外一种与锚点路由相关的服务， \$route 。这个服务里锚点路由在定义时，及匹配过程中的信息。比如我们搞怪一下：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line">angular.module(<span class="string">'ngView'</span>, [],</div><div class="line">  <span class="function"><span class="keyword">function</span><span class="params">(<span class="variable">$routeProvider</span>)</span></span>{</div><div class="line">    <span class="variable">$routeProvider</span>.when(<span class="string">'/a'</span>,</div><div class="line">      {</div><div class="line">        template: <span class="string">'\{\{ title }}'</span>,</div><div class="line">        controller: <span class="function"><span class="keyword">function</span><span class="params">(<span class="variable">$scope</span>)</span></span>{</div><div class="line">          <span class="variable">$scope</span>.title = <span class="string">'a'</span>;</div><div class="line">        }</div><div class="line">      }</div><div class="line">    );</div><div class="line"></div><div class="line">    <span class="variable">$routeProvider</span>.when(<span class="string">'/b'</span>,</div><div class="line">      {</div><div class="line">        template: <span class="string">'\{\{ title }}'</span>,</div><div class="line">        controller: <span class="function"><span class="keyword">function</span><span class="params">(<span class="variable">$scope</span>, <span class="variable">$route</span>)</span></span>{</div><div class="line">          console.log(<span class="variable">$route</span>);</div><div class="line">          <span class="variable">$route</span>.routes[<span class="string">'/a'</span>].controller(<span class="variable">$scope</span>);</div><div class="line">        }</div><div class="line">      }</div><div class="line">    );</div><div class="line">  }</div><div class="line">);</div></pre></td></tr></table></figure>

<p>回到锚点定义的业务处理中来。我们可以以字符串形式写模板，也可以直接引用外部文件作为模板：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">angular.module(<span class="string">'ngView'</span>, [],</div><div class="line">  <span class="function"><span class="keyword">function</span><span class="params">(<span class="variable">$routeProvider</span>)</span></span>{</div><div class="line">    <span class="variable">$routeProvider</span>.when(<span class="string">'/test'</span>,</div><div class="line">      {</div><div class="line">        templateUrl: <span class="string">'tpl.html'</span>,</div><div class="line">        controller: <span class="function"><span class="keyword">function</span><span class="params">(<span class="variable">$scope</span>)</span></span>{</div><div class="line">          <span class="variable">$scope</span>.title = <span class="string">'a'</span>;</div><div class="line">        }</div><div class="line">      }</div><div class="line">    );</div><div class="line">  }</div><div class="line">);</div></pre></td></tr></table></figure>

<p>tpl.html 中的内容是：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="command">\{</span><span class="command">\{</span> title <span class="special">}</span><span class="special">}</span></div></pre></td></tr></table></figure>

<p>这样的话，模板可以预定义，也可以很复杂了。</p>
<p>现在暂时忘了模板吧，因为前面提到的，当前 ng-view 不能有多个的限制，模板的渲染机制局限性还是很大的。不过，反正会触发一个 controller ，那么在函数当中我们可以尽量地干自己喜欢的事：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">angular.module(<span class="string">'ngView'</span>, [],</div><div class="line">  <span class="function"><span class="keyword">function</span><span class="params">(<span class="variable">$routeProvider</span>)</span></span>{</div><div class="line">    <span class="variable">$routeProvider</span>.when(<span class="string">'/test'</span>,</div><div class="line">      {</div><div class="line">        template: <span class="string">'\{\{\}\}'</span>,</div><div class="line">        controller: <span class="function"><span class="keyword">function</span><span class="params">()</span></span>{</div><div class="line">          $(<span class="string">'div'</span>).first().html(<span class="string">'&lt;b&gt;OK&lt;/b&gt;'</span>);</div><div class="line">        }</div><div class="line">      }</div><div class="line">    );</div><div class="line">  }</div><div class="line">);</div></pre></td></tr></table></figure>

<p>那个空的 template 不能省，否则 controller 不会被触发。</p>
<h3 id="定义模板变量标识标签">定义模板变量标识标签</h3>
<p>由于下面涉及动态内容，所以我打算起一个后端服务来做。但是我发现我使用的 Tornado 框架的模板系统，与 ng 的模板系统，都是使用 {{ }} 这对符号来定义模板表达式的，这太悲剧了，不过幸好 ng 已经提供了修改方法：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">angular.bootstrap(document.documentElement,</div><div class="line">  [<span class="function"><span class="keyword">function</span><span class="params">(<span class="variable">$interpolateProvider</span>)</span></span>{</div><div class="line">    <span class="variable">$interpolateProvider</span>.startSymbol(<span class="string">'[['</span>);</div><div class="line">    <span class="variable">$interpolateProvider</span>.endSymbol(<span class="string">']]'</span>);</div><div class="line">  }]);</div></pre></td></tr></table></figure>

<p>使用 $interpolateProvider 服务即可。</p>
<h3 id="AJAX">AJAX</h3>
<p>ng 提供了基本的 AJAX 封装，你直接面对 promise 对象，使用起来还是很方便的。</p>
<h4 id="HTTP请求">HTTP请求</h4>
<p>基本的操作由 $http 服务提供。它的使用很简单，提供一些描述请求的参数，请求就出去了，然后返回一个扩充了 success 方法和 error 方法的 promise 对象（下节介绍），你可以在这个对象中添加需要的回调函数。</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> TestCtrl = <span class="function"><span class="keyword">function</span><span class="params">(<span class="variable">$scope</span>, <span class="variable">$http</span>)</span></span>{</div><div class="line">  <span class="keyword">var</span> p = <span class="variable">$http</span>({</div><div class="line">    method: <span class="string">'GET'</span>,</div><div class="line">    url: <span class="string">'/json'</span></div><div class="line">  });</div><div class="line">  p.success(<span class="function"><span class="keyword">function</span><span class="params">(response, status, headers, config)</span></span>{</div><div class="line">      <span class="variable">$scope</span>.name = response.name;</div><div class="line">  });</div><div class="line">}</div></pre></td></tr></table></figure>

<p>\$http 接受的配置项有：</p>
<p>method 方法<br>url 路径<br>params GET请求的参数<br>data post请求的参数<br>headers 头<br>transformRequest 请求预处理函数<br>transformResponse 响应预处理函数<br>cache 缓存<br>timeout 超时毫秒，超时的请求会被取消<br>withCredentials 跨域安全策略的一个东西<br>其中的 transformRequest 和 transformResponse 及 headers 已经有定义的，如果自定义则会覆盖默认定义：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> $config = <span class="keyword">this</span>.defaults = {</div><div class="line">     <span class="comment">// transform incoming response data</span></div><div class="line">     transformResponse: [<span class="function"><span class="keyword">function</span><span class="params">(data)</span> </span>{</div><div class="line">       <span class="keyword">if</span> (isString(data)) {</div><div class="line">         <span class="comment">// strip json vulnerability protection prefix</span></div><div class="line">         data = data.replace(PROTECTION_PREFIX, <span class="string">''</span>);</div><div class="line">         <span class="keyword">if</span> (JSON_START.test(data) && JSON_END.test(data))</div><div class="line">           data = fromJson(data, <span class="literal">true</span>);</div><div class="line">       }</div><div class="line">       <span class="keyword">return</span> data;</div><div class="line">     }],</div><div class="line">   </div><div class="line">     <span class="comment">// transform outgoing request data</span></div><div class="line">     transformRequest: [<span class="function"><span class="keyword">function</span><span class="params">(d)</span> </span>{</div><div class="line">       <span class="keyword">return</span> isObject(d) && !isFile(d) ? toJson(d) : d;</div><div class="line">     }],</div><div class="line">   </div><div class="line">     <span class="comment">// default headers</span></div><div class="line">     headers: {</div><div class="line">       common: {</div><div class="line">         <span class="string">'Accept'</span>: <span class="string">'application/json, text/plain, */*'</span>,</div><div class="line">         <span class="string">'X-Requested-With'</span>: <span class="string">'XMLHttpRequest'</span></div><div class="line">       },</div><div class="line">       post: {<span class="string">'Content-Type'</span>: <span class="string">'application/json;charset=utf-8'</span>},</div><div class="line">       put:  {<span class="string">'Content-Type'</span>: <span class="string">'application/json;charset=utf-8'</span>}</div><div class="line">     }</div><div class="line">   };</div></pre></td></tr></table></figure>

<p>注意它默认的 POST 方法出去的 Content-Type</p>
<p>对于几个标准的 HTTP 方法，有对应的 shortcut ：</p>
<ol>
<li>\$http.delete(url, config)</li>
<li>\$http.get(url, config)</li>
<li>\$http.head(url, config)</li>
<li>\$http.jsonp(url, config)</li>
<li>\$http.post(url, data, config)</li>
<li>\$http.put(url, data, config)<br>注意其中的 JSONP 方法，在实现上会在页面中添加一个 script 标签，然后放出一个 GET 请求。你自己定义的，匿名回调函数，会被 ng 自已给一个全局变量。在定义请求，作为 GET 参数，你可以使用 JSON_CALLBACK 这个字符串来暂时代替回调函数名，之后 ng 会为你替换成真正的函数名：</li>
</ol>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> p = $http({</div><div class="line">   <span class="keyword">method</span>: '<span class="type">JSONP</span>',</div><div class="line">   url: '/json',</div><div class="line">   params: {callback: '<span class="type">JSON_CALLBACK</span>'}</div><div class="line"> });</div><div class="line"> p.success(function(response, status, headers, config){</div><div class="line">     console.log(response);</div><div class="line">     $scope.name = response.name;</div><div class="line"> });</div></pre></td></tr></table></figure>

<p>$http 有两个属性：</p>
<p>defaults 请求的全局配置<br>pendingRequests 当前的请求队列状态</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="variable">$http.defaults.transformRequest</span> <span class="subst">=</span> function(<span class="built_in">data</span>){console<span class="built_in">.</span><span class="keyword">log</span>(<span class="string">'here'</span>); <span class="keyword">return</span> <span class="built_in">data</span>;}</div><div class="line">console<span class="built_in">.</span><span class="keyword">log</span>(<span class="variable">$http.pendingRequests</span>);</div></pre></td></tr></table></figure>

<h4 id="广义回调管理">广义回调管理</h4>
<p>和其它框架一样， ng 提供了广义的异步回调管理的机制。 \$http 服务是在其之上封装出来的。这个机制就是 ng 的 \$q 服务。</p>
<p>不过 ng 的这套机制总的来说实现得比较简单，按官方的说法，够用了。</p>
<p>使用的方法，基本上是：</p>
<p>通过 \$q 服务得到一个 deferred 实例<br>通过 deferred 实例的 promise 属性得到一个 promise 对象<br>promise 对象负责定义回调函数<br>deferred 实例负责触发回调,</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> TestCtrl = <span class="function"><span class="keyword">function</span><span class="params">($q)</span></span>{</div><div class="line">  <span class="keyword">var</span> defer = $q.defer();</div><div class="line">  <span class="keyword">var</span> promise = defer.promise;</div><div class="line">  promise.then(<span class="function"><span class="keyword">function</span><span class="params">(data)</span></span>{<span class="built_in">console</span>.log(<span class="string">'ok, '</span> + data)},</div><div class="line">               <span class="function"><span class="keyword">function</span><span class="params">(data)</span></span>{<span class="built_in">console</span>.log(<span class="string">'error, '</span> + data)});</div><div class="line">  <span class="comment">//defer.reject('xx');</span></div><div class="line">  defer.resolve(<span class="string">'xx'</span>);</div><div class="line">}</div></pre></td></tr></table></figure>

<p>了解了上面的东西，再分别看 \$q ， deferred ， promise 这三个东西。</p>
<h4 id="\$q">\$q</h4>
<p>\$q 有四个方法：</p>
<p>\$q.all() 合并多个 promise ，得到一个新的 promise<br>\$q.defer() 返回一个 deferred 对象<br>\$q.reject() 包装一个错误，以使回调链能正确处理下去<br>\$q.when() 返回一个 promise 对象<br>\$q.all() 方法适用于并发场景很合适：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> TestCtrl = <span class="function"><span class="keyword">function</span><span class="params">(<span class="variable">$q</span>, <span class="variable">$http</span>)</span></span>{</div><div class="line">  <span class="keyword">var</span> p = <span class="variable">$http</span>.get(<span class="string">'/json'</span>, {params: {a: <span class="number">1</span>}});</div><div class="line">  <span class="keyword">var</span> p2 = <span class="variable">$http</span>.get(<span class="string">'/json'</span>, {params: {a: <span class="number">2</span>}});</div><div class="line">  <span class="keyword">var</span> all = <span class="variable">$q</span>.all([p, p2]);</div><div class="line">  p.success(<span class="function"><span class="keyword">function</span><span class="params">(res)</span></span>{console.log(<span class="string">'here'</span>)});</div><div class="line">  all.then(<span class="function"><span class="keyword">function</span><span class="params">(res)</span></span>{console.log(res[<span class="number">0</span>])});</div><div class="line">}</div></pre></td></tr></table></figure>

<p>\$q.reject() 方法是在你捕捉异常之后，又要把这个异常在回调链中传下去时使用：</p>
<p>要理解这东西，先看看 promise 的链式回调是如何运作的，看下面两段代码的区别：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> defer = $q.defer();</div><div class="line"><span class="keyword">var</span> p = defer.promise;</div><div class="line">p.then(</div><div class="line">  <span class="function"><span class="keyword">function</span><span class="params">(data)</span></span>{<span class="keyword">return</span> <span class="string">'xxx'</span>}</div><div class="line">);</div><div class="line">p.then(</div><div class="line">  <span class="function"><span class="keyword">function</span><span class="params">(data)</span></span>{<span class="built_in">console</span>.log(data)}</div><div class="line">);</div><div class="line">defer.resolve(<span class="string">'123'</span>);</div><div class="line"><span class="keyword">var</span> defer = $q.defer();</div><div class="line"><span class="keyword">var</span> p = defer.promise;</div><div class="line"><span class="keyword">var</span> p2 = p.then(</div><div class="line">  <span class="function"><span class="keyword">function</span><span class="params">(data)</span></span>{<span class="keyword">return</span> <span class="string">'xxx'</span>}</div><div class="line">);</div><div class="line">p2.then(</div><div class="line">  <span class="function"><span class="keyword">function</span><span class="params">(data)</span></span>{<span class="built_in">console</span>.log(data)}</div><div class="line">);</div><div class="line">defer.resolve(<span class="string">'123'</span>);</div></pre></td></tr></table></figure>

<p>从模型上看，前者是“并发”，后者才是“链式”。</p>
<p>而 \$q.reject() 的作用就是触发后链的 error 回调：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> defer = $q.defer();</div><div class="line"><span class="keyword">var</span> p = defer.promise;</div><div class="line">p.then(</div><div class="line">  <span class="function"><span class="keyword">function</span><span class="params">(data)</span></span>{<span class="keyword">return</span> data},</div><div class="line">  <span class="function"><span class="keyword">function</span><span class="params">(data)</span></span>{<span class="keyword">return</span> $q.reject(data)}</div><div class="line">).</div><div class="line">then(</div><div class="line">  <span class="function"><span class="keyword">function</span><span class="params">(data)</span></span>{<span class="built_in">console</span>.log(<span class="string">'ok, '</span> + data)},</div><div class="line">  <span class="function"><span class="keyword">function</span><span class="params">(data)</span></span>{<span class="built_in">console</span>.log(<span class="string">'error, '</span> + data)}</div><div class="line">)</div><div class="line">defer.reject(<span class="string">'123'</span>);</div></pre></td></tr></table></figure>

<p>最后的 \$q.when() 是把数据封装成 promise 对象：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> p = $q.when(<span class="number">0</span>, <span class="function"><span class="keyword">function</span><span class="params">(data)</span></span>{<span class="keyword">return</span> data},</div><div class="line">                   <span class="function"><span class="keyword">function</span><span class="params">(data)</span></span>{<span class="keyword">return</span> data});</div><div class="line">p.then(</div><div class="line">  <span class="function"><span class="keyword">function</span><span class="params">(data)</span></span>{<span class="built_in">console</span>.log(<span class="string">'ok, '</span> + data)},</div><div class="line">  <span class="function"><span class="keyword">function</span><span class="params">(data)</span></span>{<span class="built_in">console</span>.log(<span class="string">'error, '</span> + data)}</div><div class="line">);</div></pre></td></tr></table></figure>

<h4 id="deferred">deferred</h4>
<p>deferred 对象有两个方法一个属性。</p>
<p>promise 属性就是返回一个 promise 对象的。<br>resolve() 成功回调<br>reject() 失败回调</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> defer = $q.defer();</div><div class="line"><span class="keyword">var</span> promise = defer.promise;</div><div class="line">promise.then(<span class="function"><span class="keyword">function</span><span class="params">(data)</span></span>{<span class="built_in">console</span>.log(<span class="string">'ok, '</span> + data)},</div><div class="line">             <span class="function"><span class="keyword">function</span><span class="params">(data)</span></span>{<span class="built_in">console</span>.log(<span class="string">'error, '</span> + data)});</div><div class="line"><span class="comment">//defer.reject('xx');</span></div><div class="line">defer.resolve(<span class="string">'xx'</span>);</div></pre></td></tr></table></figure>

<h4 id="promise">promise</h4>
<p>promise 对象只有 then() 一个方法，注册成功回调函数和失败回调函数，再返回一个 promise 对象，以用于链式调用。</p>
<h3 id="工具函数">工具函数</h3>
<h4 id="上下文绑定">上下文绑定</h4>
<p>angular.bind 是用来进行上下文绑定，参数动态绑定的工具函数。</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> f = angular.bind({a: <span class="string">'xx'</span>},</div><div class="line">  <span class="function"><span class="keyword">function</span><span class="params">()</span></span>{</div><div class="line">    <span class="built_in">console</span>.log(<span class="keyword">this</span>.a);</div><div class="line">  }</div><div class="line">);</div><div class="line">f();</div></pre></td></tr></table></figure>

<p>参数动态绑定：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> f = <span class="function"><span class="keyword">function</span><span class="params">(x)</span><span class="comment">{console.log(x)}</span></span></div><div class="line"><span class="title">angular</span>.<span class="title">bind</span><span class="params">({}, f, <span class="string">'x'</span>)</span><span class="params">()</span>;</div></pre></td></tr></table></figure>

<h4 id="对象处理">对象处理</h4>
<p>对象复制： angular.copy()</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> a = {<span class="string">'x'</span>: <span class="string">'123'</span>};</div><div class="line"><span class="keyword">var</span> b = angular.copy(a);</div><div class="line">a.x = <span class="string">'456'</span>;</div><div class="line"><span class="built_in">console</span>.log(b);</div></pre></td></tr></table></figure>

<p>对象聚合： angular.extend()</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> a = {<span class="string">'x'</span>: <span class="string">'123'</span>};</div><div class="line"><span class="keyword">var</span> b = {<span class="string">'xx'</span>: <span class="string">'456'</span>};</div><div class="line">angular.extend(b, a);</div><div class="line"><span class="built_in">console</span>.log(b);</div></pre></td></tr></table></figure>

<p>空函数： angular.noop()</p>
<p>大小写转换： angular.lowercase() 和 angular.uppercase()</p>
<p>JSON转换： angular.fromJson() 和 angular.toJson()</p>
<p>遍历： angular.forEach() ，支持列表和对象：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> l = {a: <span class="string">'1'</span>, b: <span class="string">'2'</span>};</div><div class="line">angular.forEach(l, <span class="function"><span class="keyword">function</span><span class="params">(v, k)</span></span>{<span class="built_in">console</span>.log(k + <span class="string">': '</span> + v)});</div><div class="line"></div><div class="line"><span class="keyword">var</span> l = [<span class="string">'a'</span>, <span class="string">'b'</span>, <span class="string">'c'</span>];</div><div class="line">angular.forEach(l, <span class="function"><span class="keyword">function</span><span class="params">(v, i, o)</span></span>{<span class="built_in">console</span>.log(v)});</div><div class="line"></div><div class="line"><span class="keyword">var</span> context = {<span class="string">'t'</span>: <span class="string">'xx'</span>};</div><div class="line">angular.forEach(l, <span class="function"><span class="keyword">function</span><span class="params">(v, i, o)</span></span>{<span class="built_in">console</span>.log(<span class="keyword">this</span>.t)}, context);</div></pre></td></tr></table></figure>

<h4 id="类型判定">类型判定</h4>
<p>angular.isArray<br>angular.isDate<br>angular.isDefined<br>angular.isElement<br>angular.isFunction<br>angular.isNumber<br>angular.isObject<br>angular.isString<br>angular.isUndefined</p>
<h3 id="其它服务">其它服务</h3>
<h4 id="日志">日志</h4>
<p>ng 提供 \$log 这个服务用于向终端输出相关信息：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">error()</div><div class="line">info()</div><div class="line">log()</div><div class="line">warn()</div><div class="line">  <span class="keyword">var</span> TestCtrl = <span class="function"><span class="keyword">function</span><span class="params">(<span class="variable">$log</span>)</span></span>{</div><div class="line">    <span class="variable">$log</span>.error(<span class="string">'error'</span>);</div><div class="line">    <span class="variable">$log</span>.info(<span class="string">'info'</span>);</div><div class="line">    <span class="variable">$log</span>.log(<span class="string">'log'</span>);</div><div class="line">    <span class="variable">$log</span>.warn(<span class="string">'warn'</span>);</div><div class="line">  }</div></pre></td></tr></table></figure>

<h4 id="缓存">缓存</h4>
<p>ng 提供了一个简单封装了缓存机制 \$cacheFactory ，可以用来作为数据容器：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> TestCtrl = <span class="function"><span class="keyword">function</span><span class="params">(<span class="variable">$scope</span>, <span class="variable">$cacheFactory</span>)</span></span>{</div><div class="line">  <span class="variable">$scope</span>.cache = <span class="variable">$cacheFactory</span>(<span class="string">'s_'</span> + <span class="variable">$scope</span>.<span class="variable">$id</span>, {capacity: <span class="number">3</span>});</div><div class="line"></div><div class="line">  <span class="variable">$scope</span>.show = <span class="function"><span class="keyword">function</span><span class="params">()</span></span>{</div><div class="line">    console.log(<span class="variable">$scope</span>.cache.get(<span class="string">'a'</span>));</div><div class="line">    console.log(<span class="variable">$scope</span>.cache.info());</div><div class="line">  }</div><div class="line"></div><div class="line">  <span class="variable">$scope</span>.set = <span class="function"><span class="keyword">function</span><span class="params">()</span></span>{</div><div class="line">    <span class="variable">$scope</span>.cache.put((<span class="keyword">new</span> Date()).valueOf(), <span class="string">'ok'</span>);</div><div class="line">  }</div><div class="line">}</div></pre></td></tr></table></figure>

<p>调用时，第一个参数是 id ，第二个参数是配置项，目前支持 capacity 参数，用以设置缓存能容留的最大条目数。超过这个个数，则自动清除较旧的条目。</p>
<p>缓存实例的方法：</p>
<p>info() 获取 id , size 信息<br>put(k, v) 设置新条目<br>get(k) 获取条目<br>remove(k) 删除条目<br>removeAll() 删除所有条目<br>destroy() 删除对本实例的引用<br>\$http 的调用当中，有一个 cache 参数，值为 true 时为自动维护的缓存。值也可以设置为一个 cache 实例。</p>
<h4 id="计时器">计时器</h4>
<p>\$timeout 服务是 ng 对 window.setTimeout() 的封装，它使用 promise 统一了计时器的回调行为：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> TestCtrl = <span class="function"><span class="keyword">function</span><span class="params">($timeout)</span></span>{</div><div class="line">  <span class="keyword">var</span> p = $timeout(<span class="function"><span class="keyword">function</span><span class="params">()</span></span>{<span class="built_in">console</span>.log(<span class="string">'haha'</span>)}, <span class="number">5000</span>);</div><div class="line">  p.then(<span class="function"><span class="keyword">function</span><span class="params">()</span></span>{<span class="built_in">console</span>.log(<span class="string">'x'</span>)});</div><div class="line">  <span class="comment">//$timeout.cancel(p);</span></div><div class="line">}</div></pre></td></tr></table></figure>

<p>使用 \$timeout.cancel() 可以取消计时器。</p>
<h4 id="表达式函数化">表达式函数化</h4>
<p>\$parse 这个服务，为 js 提供了类似于 Python 中 @property 的能力：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> TestCtrl = <span class="function"><span class="keyword">function</span><span class="params">(<span class="variable">$scope</span>, <span class="variable">$parse</span>)</span></span>{</div><div class="line">  <span class="variable">$scope</span>.get_name = <span class="variable">$parse</span>(<span class="string">'name'</span>);</div><div class="line">  <span class="variable">$scope</span>.show = <span class="function"><span class="keyword">function</span><span class="params">()</span></span>{console.log(<span class="variable">$scope</span>.get_name(<span class="variable">$scope</span>))}</div><div class="line">  <span class="variable">$scope</span>.set = <span class="function"><span class="keyword">function</span><span class="params">()</span></span>{<span class="variable">$scope</span>.name = <span class="string">'123'</span>}</div><div class="line">}</div></pre></td></tr></table></figure>

<p>\$parse 返回一个函数，调用这个函数时，可以传两个参数，第一个作用域，第二个是变量集，后者常用于覆盖前者的变量：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">var</span> get_name <span class="subst">=</span> <span class="variable">$parse</span>(<span class="string">'name'</span>);</div><div class="line"><span class="built_in">var</span> r <span class="subst">=</span> get_name({name: <span class="string">'xx'</span>}, {name: <span class="string">'abc'</span>});</div><div class="line">console<span class="built_in">.</span><span class="keyword">log</span>(r);</div></pre></td></tr></table></figure>

<p>\$parse 返回的函数，也提供了相应的 assign 功能，可以为表达式赋值（如果可以的话）：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">var</span> get_name <span class="subst">=</span> <span class="variable">$parse</span>(<span class="string">'name'</span>);</div><div class="line"><span class="built_in">var</span> set_name <span class="subst">=</span> get_name<span class="built_in">.</span>assign;</div><div class="line"><span class="built_in">var</span> r <span class="subst">=</span> get_name({name: <span class="string">'xx'</span>}, {name: <span class="string">'abc'</span>});</div><div class="line">console<span class="built_in">.</span><span class="keyword">log</span>(r);</div><div class="line"></div><div class="line"><span class="built_in">var</span> s <span class="subst">=</span> {}</div><div class="line">set_name(s, <span class="string">'123'</span>);</div><div class="line"><span class="built_in">var</span> r <span class="subst">=</span> get_name(s);</div><div class="line">console<span class="built_in">.</span><span class="keyword">log</span>(r);</div></pre></td></tr></table></figure>

<h4 id="模板单独使用">模板单独使用</h4>
<p>ng 中的模板是很重要，也很强大的一个机制，自然少不了单独运用它的方法。不过，即使是单独使用，也是和 DOM 紧密相关的程度：</p>
<p>定义时必须是有 HTML 标签包裹的，这样才能创建 DOM 节点<br>渲染时必须传入 \$scope<br>之后使用 \$compile 就可以得到一个渲染好的节点对象了。当然， \$compile 还要做其它一些工作，指令处理什么的。</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> TestCtrl = <span class="function"><span class="keyword">function</span><span class="params">(<span class="variable">$scope</span>, <span class="variable">$element</span>,<span class="variable">$compile</span>)</span></span>{</div><div class="line">  <span class="variable">$scope</span>.a = <span class="string">'123'</span>;</div><div class="line">  <span class="variable">$scope</span>.set = <span class="function"><span class="keyword">function</span><span class="params">()</span></span>{</div><div class="line">    <span class="keyword">var</span> tpl = <span class="variable">$compile</span>(<span class="string">'&lt;p&gt;hello \{\{ a }}&lt;/p&gt;'</span>);</div><div class="line">    <span class="keyword">var</span> e = tpl(<span class="variable">$scope</span>);</div><div class="line">    <span class="variable">$element</span>.append(e);</div><div class="line">  }</div><div class="line">}</div></pre></td></tr></table></figure>

<h3 id="自定义模块和服务">自定义模块和服务</h3>
<h4 id="模块和服务的概念与关系">模块和服务的概念与关系</h4>
<p>总的来说，模块是组织业务的一个框框，在一个模块当中定义多个服务。当你引入了一个模块的时候，就可以使用这个模块提供的一种或多种服务了。</p>
<p>比如 AngularJS 本身的一个默认模块叫做 ng ，它提供了 \$http ， \$q 等等服务。</p>
<p>服务只是模块提供的多种机制中的一种，其它的还有命令（ directive ），过滤器（ filter ），及其它配置信息。</p>
<p>然后在额外的 js 文件中有一个附加的模块叫做 ngResource ， 它提供了一个 \$resource 服务。</p>
<p>定义时，我们可以在已有的模块中新定义一个服务，也可以先新定义一个模块，然后在新模块中定义新服务。</p>
<p>使用时，模块是需要显式地的声明依赖（引入）关系的，而服务则可以让 ng 自动地做注入，然后直接使用。</p>
<h4 id="定义模块">定义模块</h4>
<p>定义模块的方法是使用 angular.module 。调用时声明了对其它模块的依赖，并定义了“初始化”函数。</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> my_module = angular.module(<span class="string">'MyModule'</span>, [], <span class="function"><span class="keyword">function</span><span class="params">()</span></span>{</div><div class="line">    <span class="built_in">console</span>.log(<span class="string">'here'</span>);</div><div class="line">});</div></pre></td></tr></table></figure>

<p>这段代码定义了一个叫做 MyModule 的模块， my_module 这个引用可以在接下来做其它的一些事，比如定义服务。</p>
<h4 id="定义服务">定义服务</h4>
<p>服务本身是一个任意的对象。但是 ng 提供服务的过程涉及它的依赖注入机制。在这里呢，就要先介绍一下叫 provider 的东西。</p>
<p>简单来说， provider 是被“注入控制器”使用的一个对象，注入机制通过调用一个 provider 的 \$get() 方法，把得到的东西作为参数进行相关调用（比如把得到的服务作为一个 Controller 的参数）。</p>
<p>在这里“服务”的概念就比较不明确，对使用而言，服务仅指 \$get() 方法返回的东西，但是在整体机制上，服务又要指提供了 \$get() 方法的整个对象。</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//这是一个provider</span></div><div class="line"><span class="keyword">var</span> pp = <span class="function"><span class="keyword">function</span><span class="params">()</span></span>{</div><div class="line">  this.<span class="variable">$get</span> = <span class="function"><span class="keyword">function</span><span class="params">()</span></span>{</div><div class="line">    <span class="keyword">return</span> {<span class="string">'haha'</span>: <span class="string">'123'</span>};</div><div class="line">  }</div><div class="line">}</div><div class="line"></div><div class="line"><span class="comment">//我在模块的初始化过程当中, 定义了一个叫 PP 的服务</span></div><div class="line"><span class="keyword">var</span> app = angular.module(<span class="string">'Demo'</span>, [], <span class="function"><span class="keyword">function</span><span class="params">(<span class="variable">$provide</span>)</span></span>{</div><div class="line">  <span class="variable">$provide</span>.provider(<span class="string">'PP'</span>, pp);</div><div class="line">});</div><div class="line"></div><div class="line"><span class="comment">//PP服务实际上就是 pp 这个 provider 的 $get() 方法返回的东西</span></div><div class="line">app.controller(<span class="string">'TestCtrl'</span>,</div><div class="line">  <span class="function"><span class="keyword">function</span><span class="params">(<span class="variable">$scope</span>, PP)</span></span>{</div><div class="line">    console.log(PP);</div><div class="line">  }</div><div class="line">);</div></pre></td></tr></table></figure>

<p>上面的代码是一种定义服务的方法，当然， ng 还有相关的 shortcut， ng 总有很多 shortcut 。</p>
<p>第一个是 factory 方法，由 \$provide 提供， module 的 factory 是一个引用，作用一样。这个方法直接把一个函数当成是一个对象的 \$get() 方法，这样你就不用显式地定义一个 provider 了：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> app = angular.module(<span class="string">'Demo'</span>, [], <span class="function"><span class="keyword">function</span><span class="params">(<span class="variable">$provide</span>)</span></span>{</div><div class="line">   <span class="variable">$provide</span>.factory(<span class="string">'PP'</span>, <span class="function"><span class="keyword">function</span><span class="params">()</span></span>{</div><div class="line">     <span class="keyword">return</span> {<span class="string">'hello'</span>: <span class="string">'123'</span>};</div><div class="line">   });</div><div class="line"> });</div><div class="line"> app.controller(<span class="string">'TestCtrl'</span>, <span class="function"><span class="keyword">function</span><span class="params">(<span class="variable">$scope</span>, PP)</span></span>{ console.log(PP) });</div></pre></td></tr></table></figure>

<p>在 module 中使用：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> app = angular.module(<span class="string">'Demo'</span>, [], <span class="function"><span class="keyword">function</span><span class="params">()</span></span>{ });</div><div class="line">app.factory(<span class="string">'PP'</span>, <span class="function"><span class="keyword">function</span><span class="params">()</span></span>{<span class="keyword">return</span> {<span class="string">'abc'</span>: <span class="string">'123'</span>}});</div><div class="line">app.controller(<span class="string">'TestCtrl'</span>, <span class="function"><span class="keyword">function</span><span class="params">($scope, PP)</span></span>{ <span class="built_in">console</span>.log(PP) });</div></pre></td></tr></table></figure>

<p>第二个是 service 方法，也是由 \$provide 提供， module 中有对它的同名引用。 service 和 factory 的区别在于，前者是要求提供一个“构造方法”，后者是要求提供 \$get() 方法。意思就是，前者一定是得到一个 object ，后者可以是一个数字或字符串。它们的关系大概是：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> app = angular.module(<span class="string">'Demo'</span>, [], <span class="function"><span class="keyword">function</span><span class="params">()</span></span>{ });</div><div class="line">app.service = <span class="function"><span class="keyword">function</span><span class="params">(name, constructor)</span></span>{</div><div class="line">  app.factory(name, <span class="function"><span class="keyword">function</span><span class="params">()</span></span>{</div><div class="line">    <span class="keyword">return</span> (<span class="keyword">new</span> constructor());</div><div class="line">  });</div><div class="line">}</div></pre></td></tr></table></figure>

<p>这里插一句，js 中 new 的作用，以 new a() 为例，过程相当于：</p>
<p>1.创建一个空对象 obj<br>2.把 obj 绑定到 a 函数的上下文当中（即 a 中的 this 现在指向 obj ）<br>3.执行 a 函数<br>4.返回 obj<br>service 方法的使用就很简单了：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> app = angular.module(<span class="string">'Demo'</span>, [], <span class="function"><span class="keyword">function</span><span class="params">()</span></span>{ });</div><div class="line">app.service(<span class="string">'PP'</span>, <span class="function"><span class="keyword">function</span><span class="params">()</span></span>{</div><div class="line">  <span class="keyword">this</span>.abc = <span class="string">'123'</span>;</div><div class="line">});</div><div class="line">app.controller(<span class="string">'TestCtrl'</span>, <span class="function"><span class="keyword">function</span><span class="params">($scope, PP)</span></span>{ <span class="built_in">console</span>.log(PP) });</div></pre></td></tr></table></figure>

<h4 id="引入模块并使用服务">引入模块并使用服务</h4>
<p>结合上面的“定义模块”和“定义服务”，我们可以方便地组织自己的额外代码：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">angular.module(<span class="string">'MyModule'</span>, [], <span class="function"><span class="keyword">function</span><span class="params">(<span class="variable">$provide</span>)</span></span>{</div><div class="line">  <span class="variable">$provide</span>.factory(<span class="string">'S1'</span>, <span class="function"><span class="keyword">function</span><span class="params">()</span></span>{</div><div class="line">    <span class="keyword">return</span> <span class="string">'I am S1'</span>;</div><div class="line">  });</div><div class="line">  <span class="variable">$provide</span>.factory(<span class="string">'S2'</span>, <span class="function"><span class="keyword">function</span><span class="params">()</span></span>{</div><div class="line">    <span class="keyword">return</span> {see: <span class="function"><span class="keyword">function</span><span class="params">()</span></span>{<span class="keyword">return</span> <span class="string">'I am S2'</span>}}</div><div class="line">  });</div><div class="line">});</div><div class="line"></div><div class="line"><span class="keyword">var</span> app = angular.module(<span class="string">'Demo'</span>, [<span class="string">'MyModule'</span>], angular.noop);</div><div class="line">app.controller(<span class="string">'TestCtrl'</span>, <span class="function"><span class="keyword">function</span><span class="params">(<span class="variable">$scope</span>, S1, S2)</span></span>{</div><div class="line">  console.log(S1)</div><div class="line">  console.log(S2.see())</div><div class="line">});</div></pre></td></tr></table></figure>

<h3 id="附加模块_ngResource">附加模块 ngResource</h3>
<h4 id="使用引入与整体概念">使用引入与整体概念</h4>
<p>ngResource 这个是 ng 官方提供的一个附加模块。附加的意思就是，如果你打算用它，那么你需要引入一个单独的 js 文件，然后在声明“根模块”时注明依赖的 ngResource 模块，接着就可以使用它提供的 \$resource 服务了。完整的过程形如：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="doctype">&lt;!DOCTYPE html&gt;</span></div><div class="line"><span class="tag">&lt;<span class="title">html</span> <span class="attribute">ng-app</span>=<span class="value">"Demo"</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="title">head</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="title">meta</span> <span class="attribute">charset</span>=<span class="value">"utf-8"</span> /&gt;</span></div><div class="line"><span class="tag">&lt;<span class="title">title</span>&gt;</span>AngularJS<span class="tag">&lt;/<span class="title">title</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="title">script</span> <span class="attribute">type</span>=<span class="value">"text/javascript"</span> <span class="attribute">src</span>=<span class="value">"http://ajax.googleapis.com/ajax/libs/angularjs/1.0.3/angular.min.js"</span>&gt;</span><span class="javascript"></span><span class="tag">&lt;/<span class="title">script</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="title">script</span> <span class="attribute">type</span>=<span class="value">"text/javascript"</span> <span class="attribute">src</span>=<span class="value">"http://ajax.googleapis.com/ajax/libs/angularjs/1.0.3/angular-resource.js"</span>&gt;</span><span class="javascript"></span><span class="tag">&lt;/<span class="title">script</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="title">head</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="title">body</span>&gt;</span></div><div class="line"></div><div class="line">  <span class="tag">&lt;<span class="title">div</span> <span class="attribute">ng-controller</span>=<span class="value">"TestCtrl"</span>&gt;</span><span class="tag">&lt;/<span class="title">div</span>&gt;</span></div><div class="line"></div><div class="line"></div><div class="line"><span class="tag">&lt;<span class="title">script</span> <span class="attribute">type</span>=<span class="value">"text/javascript"</span> <span class="attribute">charset</span>=<span class="value">"utf-8"</span>&gt;</span><span class="javascript"></span></div><div class="line"></div><div class="line"><span class="keyword">var</span> app = angular.module(<span class="string">'Demo'</span>, [<span class="string">'ngResource'</span>], angular.noop);</div><div class="line">app.controller(<span class="string">'TestCtrl'</span>, <span class="function"><span class="keyword">function</span><span class="params">($scope, $resource)</span></span>{</div><div class="line">  <span class="built_in">console</span>.log($resource);</div><div class="line">});</div><div class="line"></div><div class="line"><span class="tag">&lt;/<span class="title">script</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="title">body</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="title">html</span>&gt;</span></div></pre></td></tr></table></figure>

<p>\$resource 服务，整体上来说，比较像是使用类似 ORM 的方式来包装了 AJAX 调用。区别就是 ORM 是操作数据库，即拼出 SQL 语句之后，作 execute 方法调用。而 \$resource 的方式是构造出 AJAX 请求，然后发出请求。同时，AJAX 请求是需要回调处理的，这方面， \$resource 的机制可以使你在一些时候省掉回调处理，当然，是否作回调处理在于业务情形及容错需求了。</p>
<p>使用上 \$resource 分成了“类”与“实例”这两个层面。一般地，类的方法调用就是直观的调用形式，通常会返回一个对象，这个对象即为“实例”。</p>
<p>“实例”贯穿整个服务的使用过程。“实例”的数据是填充方式，即因为异步关系，回调函数没有执行时，实例已经存在，只是可能它还没有相关数据，回调执行之后，相关数据被填充到实例对象当中。实例的方法一般就是在类方法名前加一个 \$ ，调用上，根据定义，实例数据可能会做一些自动的参数填充，这点是区别实例与类的调用上的不同。</p>
<p>好吧，上面这些话可能需要在看了接下来的内容之后再回过来理解。</p>
<h4 id="基本定义">基本定义</h4>
<p>就像使用 ORM 一般要先定义 Model 一样，使用 \$resource 需要先定义“资源”，也就是先定义一些 HTTP 请求。</p>
<p>在业务场景上，我们假设为，我们需要操作“书”这个实体，包括创建create，获取详情read，修改update，删除delete，批量获取multi，共五个操作方法。实体属性有：唯一标识id，标题title，作者author。</p>
<p>我们把这些操作定义成 \$resource 的资源：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> app = angular.module('<span class="type">Demo</span>', ['ngResource'], angular.noop);</div><div class="line">app.controller('<span class="type">BookCtrl</span>', function($scope, $resource){</div><div class="line">  <span class="keyword">var</span> actions = {</div><div class="line">    create: {<span class="keyword">method</span>: '<span class="type">POST</span>', params: {_method: 'create'}},</div><div class="line">    read: {<span class="keyword">method</span>: '<span class="type">POST</span>', params: {_method: 'read'}},</div><div class="line">    update: {<span class="keyword">method</span>: '<span class="type">POST</span>', params: {_method: 'update'}},</div><div class="line">    delete: {<span class="keyword">method</span>: '<span class="type">POST</span>', params: {_method: 'delete'}},</div><div class="line">    multi: {<span class="keyword">method</span>: '<span class="type">POST</span>', params: {_method: 'multi'}}</div><div class="line">  }</div><div class="line">  <span class="keyword">var</span> <span class="type">Book</span> = $resource('/book', {}, actions);</div><div class="line">});</div></pre></td></tr></table></figure>

<p>定义是使用使用 \$resource 这个函数就可以了，它接受三个参数：</p>
<p>1.url<br>2.默认的params（这里的 params 即是 GET 请求的参数，POST 的参数单独叫做“postData”）<br>3.方法映射</p>
<p>方法映射是以方法名为 key ，以一个对象为 value ，这个 value 可以有三个成员：</p>
<p>1.method, 请求方法，’GET’, ‘POST’, ‘PUT’, ‘DELETE’ 这些<br>2.params, 默认的 GET 参数<br>3.isArray, 返回的数据是不是一个列表</p>
<h4 id="基本使用">基本使用</h4>
<p>在定义了资源之后，我们看如果使用这些资源，发出请求：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> book = Book.read({id: <span class="string">'123'</span>}, <span class="function"><span class="keyword">function</span><span class="params">(response)</span></span>{</div><div class="line">  <span class="built_in">console</span>.log(response);</div><div class="line">});</div></pre></td></tr></table></figure>

<p>这里我们进行 Book 的“类”方法调用。在方法的使用上，根据官方文档：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="tag">HTTP</span> <span class="tag">GET</span> "<span class="tag">class</span>" <span class="tag">actions</span>: <span class="tag">Resource</span><span class="class">.action</span>(<span class="attr_selector">[parameters]</span>, <span class="attr_selector">[success]</span>, <span class="attr_selector">[error]</span>)</div><div class="line"><span class="tag">non-GET</span> "<span class="tag">class</span>" <span class="tag">actions</span>: <span class="tag">Resource</span><span class="class">.action</span>(<span class="attr_selector">[parameters]</span>, <span class="tag">postData</span>, <span class="attr_selector">[success]</span>, <span class="attr_selector">[error]</span>)</div><div class="line"><span class="tag">non-GET</span> <span class="tag">instance</span> <span class="tag">actions</span>: <span class="tag">instance</span>.$<span class="tag">action</span>(<span class="attr_selector">[parameters]</span>, <span class="attr_selector">[success]</span>, <span class="attr_selector">[error]</span>)</div></pre></td></tr></table></figure>

<p>我们这里是第二种形式，即类方法的非 GET 请求。我们给的参数会作为 postData 传递。如果我们需要 GET 参数，并且还需要一个错误回调，那么：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> book = Book.read({get: <span class="string">'haha'</span>}, {id: <span class="string">'123'</span>},</div><div class="line">  <span class="function"><span class="keyword">function</span><span class="params">(response)</span></span>{</div><div class="line">    <span class="built_in">console</span>.log(response);</div><div class="line">  },</div><div class="line">  <span class="function"><span class="keyword">function</span><span class="params">(error)</span></span>{</div><div class="line">    <span class="built_in">console</span>.log(error);</div><div class="line">  }</div><div class="line">);</div></pre></td></tr></table></figure>

<p>调用之后，我们会立即得到的 book ，它是 Book 类的一个实例。这里所谓的实例，实际上就是先把所有的 action 加一个 \$ 前缀放到一个空对象里，然后把发出的参数填充进去。等请求返回了，把除 action 以外的成员删除掉，再把请求返回的数据填充到这个对象当中。所以，如果我们这样：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> book = Book.read({id: <span class="string">'123'</span>}, <span class="function"><span class="keyword">function</span><span class="params">(response)</span></span>{</div><div class="line">  <span class="built_in">console</span>.log(book);</div><div class="line">});</div><div class="line"><span class="built_in">console</span>.log(book)</div></pre></td></tr></table></figure>

<p>就能看到 book 实例的变化过程了。</p>
<p>现在我们得到一个真实的实例，看一下实例的调用过程：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">//响应的数据是 {<span class="literal">result</span>: <span class="number">0</span>, msg: '', obj: {id: 'xxx'}}</div><div class="line"><span class="keyword">var</span> book = <span class="type">Book</span>.create({title: '测试标题', author: '测试作者'}, function(response){</div><div class="line">  console.log(book);</div><div class="line">});</div></pre></td></tr></table></figure>

<p>可以看到，在请求回调之后， book 这个实例的成员已经被响应内容填充了。但是这里有一个问题，我们返回的数据，并不适合一个 book 实例。格式先不说，它把 title 和 author 这些信息都丢了（因为响应只返回了 id ）。</p>
<p>如果仅仅是格式问题，我们可以通过配置 \$http 服务来解决（ AJAX 请求都要使用 $http 服务的）：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="variable">$http</span>.defaults.transformResponse = <span class="function"><span class="keyword">function</span><span class="params">(data)</span></span>{<span class="keyword">return</span> angular.fromJson(data).obj};</div></pre></td></tr></table></figure>

<p>当然，我们也可以自己来解决一下丢信息的问题：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> p = {title: <span class="string">'测试标题'</span>, author: <span class="string">'测试作者'</span>};</div><div class="line"><span class="keyword">var</span> book = Book.create(p, <span class="function"><span class="keyword">function</span><span class="params">(response)</span></span>{</div><div class="line">  angular.extend(book, p);</div><div class="line">  <span class="built_in">console</span>.log(book);</div><div class="line">});</div></pre></td></tr></table></figure>

<p>不过，始终会有一些不方便了。比较正统的方式应该是调节服务器端的响应，让服务器端也具有和前端一样的实例概念，返回的是完整的实例信息。即使这样，你也还要考虑格式的事。</p>
<p>现在我们得到了一个真实的 book 实例了，带有 id 信息。我们尝试一下实例的方法调用，先回过去头看一下那三种调用形式，对于实例只有第三种形式：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">non-GET <span class="keyword">instance</span> actions: <span class="keyword">instance</span>.<span class="variable">$action</span>([parameters], [success], [<span class="keyword">error</span>])</div></pre></td></tr></table></figure>

<p>首先解决一个疑问，如果一个实例是进行一个 GET 的调用会怎么样？没有任何问题，这当然没有任何问题的，形式和上面一样。</p>
<p>如何实例是做 POST 请求的话，从形式上看，我们无法控制请求的 postData ？是的，所有的 POST 请求，其 postData 都会被实例数据自动填充，形式上我们只能控制 params 。</p>
<p>所以，如果是在做修改调用的话：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">book.$update({title: <span class="string">'新标题'</span>, author: <span class="string">'测试作者'</span>}, <span class="function"><span class="keyword">function</span><span class="params">(response)</span></span>{</div><div class="line">  <span class="built_in">console</span>.log(book);</div><div class="line">});</div></pre></td></tr></table></figure>

<p>这样是没有意义的并且错误的。因为要修改的数据只是作为 GET 参数传递了，而 postData 传递的数据就是当前实例的数据，并没有任何修改。</p>
<p>正确的做法：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">book.title = <span class="string">'新标题'</span></div><div class="line">book.$<span class="keyword">update</span>(<span class="function"><span class="keyword">function</span><span class="params">(response)</span>{</span></div><div class="line">  console.<span class="built_in">log</span>(book);</div><div class="line">});</div></pre></td></tr></table></figure>

<p>显然，这种情况下，回调都可以省了：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">book.title = <span class="string">'新标题'</span></div><div class="line">book.<span class="variable">$update</span>();</div></pre></td></tr></table></figure>

<h4 id="定义和使用时的占位量">定义和使用时的占位量</h4>
<p>两方面。一是在定义时，在其 URL 中可以使用变量引用的形式（类型于定义锚点路由时那样）。第二时定义默认 params ，即 GET 参数时，可以定义为引用 postData 中的某变量。比如我们这样改一下：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> Book = $resource(<span class="string">'/book/:id'</span>, {}, actions);</div><div class="line"><span class="keyword">var</span> book = Book.read({id: <span class="string">'123'</span>}, {}, <span class="function"><span class="keyword">function</span><span class="params">(response)</span></span>{</div><div class="line">  <span class="built_in">console</span>.log(response);</div><div class="line">});</div></pre></td></tr></table></figure>

<p>在 URL 中有一个 :id ，表示对 params 中 id 这个变量的引用。因为 read 是一个 POST 请求，根据调用形式，第一个参数是 params ，第二个参数是 postData 。这样的调用结果就是，我们会发一个 POST 请求到如下地址， postData 为空：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="regexp">/book/</span><span class="number">123</span>?_method=<span class="keyword">read</span></div></pre></td></tr></table></figure>

<p>再看默认的 params 中引用 postData 变量的形式：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> Book = $resource(<span class="string">'/book'</span>, {id: <span class="string">'@id'</span>}, actions);</div><div class="line"><span class="keyword">var</span> book = Book.read({title: <span class="string">'xx'</span>}, {id: <span class="string">'123'</span>}, <span class="function"><span class="keyword">function</span><span class="params">(response)</span></span>{</div><div class="line">  <span class="built_in">console</span>.log(response);</div><div class="line">});</div></pre></td></tr></table></figure>

<p>这样会出一个 POST 请求， postData 内容中有一个 id 数据，访问的 URL 是：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">/book?<span class="variable">_method=</span>read&<span class="variable">id=</span><span class="number">123</span>&<span class="variable">title=</span>xx</div></pre></td></tr></table></figure>

<p>这两个机制也可以联合使用：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> Book = $resource(<span class="string">'/book/:id'</span>, {id: <span class="string">'@id'</span>}, actions);</div><div class="line"><span class="keyword">var</span> book = Book.read({title: <span class="string">'xx'</span>}, {id: <span class="string">'123'</span>}, <span class="function"><span class="keyword">function</span><span class="params">(response)</span></span>{</div><div class="line">  <span class="built_in">console</span>.log(response);</div><div class="line">});</div></pre></td></tr></table></figure>

<p>结果就是出一个 POST 请求， postData 内容中有一个 id 数据，访问的 URL 是：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">/book/<span class="number">123</span>?<span class="variable">_method=</span>read&<span class="variable">title=</span>xx</div></pre></td></tr></table></figure>

<h4 id="实例">实例</h4>
<p>ngResource 要举一个实例是比较麻烦的事。因为它必须要一个后端来支持，这里如果我用 Python 写一个简单的后端，估计要让这个后端跑起来对很多人来说都是问题。所以，我在几套公共服务的 API 中纠结考察了一番，最后使用 www.rememberthemilk.com 的 API 来做了一个简单的，可用的例子。</p>
<p>例子见： <a href="http://zouyesheng.com/demo/ng-resource-demo.html" target="_blank" rel="external">http://zouyesheng.com/demo/ng-resource-demo.html</a> (可以直接下载看源码)</p>
<p>先说一下 API 的情况。这里的请求调用全是跨域的，所以交互上全部是使用了 JSONP 的形式。 API 的使用有使用签名认证机制，嗯， js 中直接算 md5 是可行的，我用了一个现成的库（但是好像不能处理中文吧）。</p>
<p>这个例子中的 LoginCtrl 大家就不用太关心了，参见官方的文档，走完流程拿到 token 完事。与 ngResource 相关的是 MainCtrl 中的东西。</p>
<p>其实从这个例子中就可以看出，目前 ngResource 的机制对于服务端返回的数据的格式是严重依赖的，同时也可以反映出 \$http 对一些场景根本无法应对的局限。所以，我现在的想法是理解 ngResource 的思想，真正需要的人自己使用 jQuery 重新实现一遍也许更好。这应该也花不了多少时间， ngResource 的代码本来不多。</p>
<p>我为什么说 \$http 在一些场景中有局限呢。在这个例子当中，所有的请求都需要带一个签名，签名值是由请求中带的参数根据规则使用 md5 方法计算出的值。我找不到一个 hook 可以让我在请求出去之前修改这个请求（添加上签名）。所以在这个例子当中，我的做法是根据 ngResource 的请求最后会使用 $httpBackend 这个底层服务，在 module 定义时我自己复制官方的相关代码，重新定义 $httpBackend 服务，在需要的地方做我自己的修改：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="attribute">script.src </span>=<span class="string"> sign_url(url);</span></div></pre></td></tr></table></figure>

<p>不错，我就改了这一句，但我不得不复制了 50 行官方源码到我的例子中。</p>
<p>另外一个需要说的是对返回数据的处理。因为 ngResource 会使用返回的数据直接填充实例，所以这个数据格式就很重要。</p>
<p>首先，我们可以使用 \$http.defaults.transformResponse 来统一处理一下返回的数据，但是这并不能解决所有问题，可目前 ngResource 并不提供对每一个 action 的单独的后处理回调函数项。除非你的服务端是经过专门的适应性设计的，否则你用 ngResource 不可能爽。例子中，我为了获取当前列表的结果，我不得不自己去封装结果：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> list_list = <span class="keyword">List</span>.getList(<span class="function"><span class="keyword">function</span><span class="params">()</span></span>{</div><div class="line">  <span class="keyword">var</span> res = list_list[<span class="number">1</span>];</div><div class="line">  <span class="keyword">while</span>(list_list.length &gt; <span class="number">0</span>){list_list.pop()};</div><div class="line">  angular.<span class="keyword">forEach</span>(res.<span class="keyword">list</span>, <span class="function"><span class="keyword">function</span><span class="params">(v)</span></span>{</div><div class="line">    list_list.push(<span class="keyword">new</span> <span class="keyword">List</span>({<span class="keyword">list</span>: v}));</div><div class="line">  });</div><div class="line">  <span class="variable">$scope</span>.list_list = list_list;</div><div class="line">  <span class="variable">$scope</span>.show_add = <span class="keyword">true</span>;</div><div class="line">  <span class="keyword">return</span>;</div><div class="line">});</div></pre></td></tr></table></figure>

<h3 id="AngularJS与其它框架的混用">AngularJS与其它框架的混用</h3>
<p>这个问题似乎很多人都关心，但是事实是，如果了解了 ng 的工作方式，这本来就不是一个问题了。</p>
<p>在我自己使用 ng 的过程当中，一直是混用 jQuery 的，以前还要加上一个 Dojo 。只要了解每种框架的工作方式，在具体的代码中每个框架都做了什么事，那么整体上控制起来就不会有问题。</p>
<p>回到 ng 上来看，首先对于 jQuery 来说，最开始说提到过，在 DOM 操作部分， ng 与 jQuery 是兼容的，如果没有 jQuery ， ng 自己也实现了兼容的部分 API 。</p>
<p>同时，最开始也提到过， ng 的使用最忌讳的一点就是修改 DOM 结构——你应该使用 ng 的模板机制进行数据绑定，以此来控制 DOM 结构，而不是直接操作。换句话来说，在不动 DOM 结构的这个前提之下，你的数据随便怎么改，随便使用哪个框架来控制都是没问题的，到时如有必要使用 \$scope.$digest() 来通知 ng 一下即可。</p>
<p>下面这个例子，我们使用了 jQuery 中的 Deferred ( \$.ajax 就是返回一个 Deferred )，还使用了 ng 的 \$timeout ，当然是在 ng 的结构之下：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div></pre></td><td class="code"><pre><div class="line"><span class="doctype">&lt;!DOCTYPE html&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="title">html</span> <span class="attribute">ng-app</span>=<span class="value">"Demo"</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="title">head</span>&gt;</span></div><div class="line"> <span class="tag">&lt;<span class="title">meta</span> <span class="attribute">charset</span>=<span class="value">"utf-8"</span> /&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="title">title</span>&gt;</span>AngularJS<span class="tag">&lt;/<span class="title">title</span>&gt;</span></div><div class="line">  <span class="tag">&lt;/<span class="title">head</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="title">body</span>&gt;</span></div><div class="line">  </div><div class="line">  <span class="tag">&lt;<span class="title">div</span> <span class="attribute">ng-controller</span>=<span class="value">"TestCtrl"</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="title">span</span> <span class="attribute">ng-click</span>=<span class="value">"go()"</span>&gt;</span>\{\{ a }}<span class="tag">&lt;/<span class="title">span</span>&gt;</span></div><div class="line">  <span class="tag">&lt;/<span class="title">div</span>&gt;</span></div><div class="line">  </div><div class="line">  <span class="tag">&lt;<span class="title">script</span> <span class="attribute">type</span>=<span class="value">"text/javascript"</span></span></div><div class="line">    <span class="attribute">src</span>=<span class="value">"http://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"</span>&gt;<span class="javascript"></span></div><div class="line">  <span class="tag">&lt;/<span class="title">script</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="title">script</span> <span class="attribute">type</span>=<span class="value">"text/javascript"</span></span></div><div class="line">    <span class="attribute">src</span>=<span class="value">"http://ajax.googleapis.com/ajax/libs/angularjs/1.0.3/angular.min.js"</span>&gt;<span class="javascript"></span></div><div class="line">  <span class="tag">&lt;/<span class="title">script</span>&gt;</span></div><div class="line">  </div><div class="line">  <span class="tag">&lt;<span class="title">script</span> <span class="attribute">type</span>=<span class="value">"text/javascript"</span>&gt;</span><span class="javascript"></span></div><div class="line">  <span class="keyword">var</span> app = angular.module(<span class="string">'Demo'</span>, [], angular.noop);</div><div class="line">  app.controller(<span class="string">'TestCtrl'</span>, <span class="function"><span class="keyword">function</span><span class="params">($scope, $timeout)</span></span>{</div><div class="line">    $scope.a = <span class="string">'点击我开始'</span>;</div><div class="line">  </div><div class="line">  <span class="keyword">var</span> defer = $.Deferred();</div><div class="line">    <span class="keyword">var</span> f = <span class="function"><span class="keyword">function</span><span class="params">()</span></span>{</div><div class="line">      <span class="keyword">if</span>($scope.a == <span class="string">''</span>){$scope.a = <span class="string">'已停止'</span>; <span class="keyword">return</span>}</div><div class="line">      defer.done(<span class="function"><span class="keyword">function</span><span class="params">()</span></span>{</div><div class="line">        $scope.a.length &lt; <span class="number">10</span> ? $scope.a += <span class="string">'&gt;'</span> : $scope.a = <span class="string">'&gt;'</span>;</div><div class="line">        $timeout(f, <span class="number">100</span>);</div><div class="line">      });</div><div class="line">    }</div><div class="line">    defer.done(<span class="function"><span class="keyword">function</span><span class="params">()</span></span>{$scope.a = <span class="string">'&gt;'</span>; f()});</div><div class="line">  </div><div class="line">    $scope.go = <span class="function"><span class="keyword">function</span><span class="params">()</span></span>{</div><div class="line">      defer.resolve();</div><div class="line">      $timeout(<span class="function"><span class="keyword">function</span><span class="params">()</span></span>{$scope.a = <span class="string">''</span>}, <span class="number">5000</span>);</div><div class="line">    }</div><div class="line">  });</div><div class="line">  <span class="tag">&lt;/<span class="title">script</span>&gt;</span></div><div class="line">  <span class="tag">&lt;/<span class="title">body</span>&gt;</span></div><div class="line">  <span class="tag">&lt;/<span class="title">html</span>&gt;</span></div></pre></td></tr></table></figure>

<p>再把 Dojo 加进来看与 DOM 结构相关的例子。之前说过，使用 ng 就最好不要手动修改 DOM 结构，但这里说两点：</p>
<p>对于整个页面，你可以只在局部使用 ng ，不使用 ng 的地方你可以随意控制 DOM 。<br>如果 DOM 结构有变动，你可以在 DOM 结构定下来之后再初始化 ng 。</p>
<h3 id="自定义过滤器">自定义过滤器</h3>
<p>先来回顾一下 ng 中的一些概念：</p>
<ol>
<li>module ，代码的组织单元，其它东西都是在定义在具体的模块中的。</li>
<li>app ，业务概念，可能会用到多个模块。</li>
<li>service ，仅在数据层面实现特定业务功能的代码封装。</li>
<li>controller ，与 DOM 结构相关联的东西，即是一种业务封装概念，又体现了项目组织的层级结构。</li>
<li>filter ，改变输入数据的一种机制。</li>
<li>directive ，与 DOM 结构相关联的，特定功能的封装形式。</li>
</ol>
<p>上面的这几个概念基本上就是 ng 的全部。每一部分都可以自由定义，使用时通过各要素的相互配合来实现我们的业务需求。</p>
<p>我们从最开始一致打交道的东西基本上都是 controller 层面的东西。在前面，也介绍了 module 和 service 的自定义。剩下的会介绍 filter 和 directive 的定义。基本上这几部分的定义形式都是一样的，原理上是通过 provider 来做注入形式的声明，在实际操作过程中，又有很多 shortcut 式的声明方式。</p>
<p>过滤器的自定义是最简单的，就是一个函数，接受输入，然后返回结果。在考虑过滤器时，我觉得很重要的一点： 无状态 。</p>
<p>具体来说，过滤器就是一个函数，函数的本质含义就是确定的输入一定得到确定的输出。虽然 filter 是定义在 module 当中的，而且 filter 又是在 controller 的 DOM 范围内使用的，但是，它和具体的 module ， controller ， scope 这些概念都没有关系（虽然在这里你可以使用 js 的闭包机制玩些花样），它仅仅是一个函数，而已。换句话说，它没有任何上下文关联的能力。</p>
<p>过滤器基本的定义方式：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> app = angular.module(<span class="string">'Demo'</span>, [], angular.noop);</div><div class="line">app.filter(<span class="string">'map'</span>, <span class="function"><span class="keyword">function</span><span class="params">()</span></span>{</div><div class="line">  <span class="keyword">var</span> filter = <span class="function"><span class="keyword">function</span><span class="params">(input)</span></span>{</div><div class="line">    <span class="keyword">return</span> input + <span class="string">'...'</span>;</div><div class="line">  };</div><div class="line">  <span class="keyword">return</span> filter;</div><div class="line">});</div></pre></td></tr></table></figure>

<p>上面的代码定义了一个叫做 map 的过滤器。使用时：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&lt;p&gt;示例数据: <span class="command">\{</span><span class="command">\{</span> a<span class="command">\|</span>map <span class="special">}</span><span class="special">}</span>&lt;/p&gt;</div></pre></td></tr></table></figure>

<p>过滤器也可以带参数，多个参数之间使用 : 分割，看一个完整的例子：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line">   <span class="tag">&lt;<span class="title">div</span> <span class="attribute">ng-controller</span>=<span class="value">"TestCtrl"</span>&gt;</span></div><div class="line">   <span class="tag">&lt;<span class="title">p</span>&gt;</span>示例数据: \{\{ a\|map:map_value:'&gt;&gt;':'(no)' }}<span class="tag">&lt;/<span class="title">p</span>&gt;</span></div><div class="line">   <span class="tag">&lt;<span class="title">p</span>&gt;</span>示例数据: \{\{ b\|map:map_value:'&gt;&gt;':'(no)' }}<span class="tag">&lt;/<span class="title">p</span>&gt;</span></div><div class="line">   <span class="tag">&lt;/<span class="title">div</span>&gt;</span></div><div class="line">   </div><div class="line">   </div><div class="line">   <span class="tag">&lt;<span class="title">script</span> <span class="attribute">type</span>=<span class="value">"text/javascript"</span>&gt;</span><span class="javascript"></span></div><div class="line">   </div><div class="line">   <span class="keyword">var</span> app = angular.module(<span class="string">'Demo'</span>, [], angular.noop);</div><div class="line">   app.controller(<span class="string">'TestCtrl'</span>, <span class="function"><span class="keyword">function</span><span class="params">($scope)</span></span>{</div><div class="line">     $scope.map_value = {</div><div class="line">       a: <span class="string">'一'</span>,</div><div class="line"><span class="number">3</span>       b: <span class="string">'二'</span>,</div><div class="line">       c: <span class="string">'三'</span></div><div class="line">     }</div><div class="line">     $scope.a = <span class="string">'a'</span>;</div><div class="line">   });</div><div class="line">   </div><div class="line">   app.filter(<span class="string">'map'</span>, <span class="function"><span class="keyword">function</span><span class="params">()</span></span>{</div><div class="line">     <span class="keyword">var</span> filter = <span class="function"><span class="keyword">function</span><span class="params">(input, map_value, append, default_value)</span></span>{</div><div class="line">       <span class="keyword">var</span> r = map_value[input];</div><div class="line">       <span class="keyword">if</span>(r === <span class="literal">undefined</span>){ <span class="keyword">return</span> default_value + append }</div><div class="line">       <span class="keyword">else</span> { <span class="keyword">return</span> r + append }</div><div class="line">     };</div><div class="line">     <span class="keyword">return</span> filter;</div><div class="line">   });</div><div class="line">   </div><div class="line">   angular.bootstrap(<span class="built_in">document</span>, [<span class="string">'Demo'</span>]);</div><div class="line">   <span class="tag">&lt;/<span class="title">script</span>&gt;</span></div></pre></td></tr></table></figure>

<h3 id="自定义指令directive">自定义指令directive</h3>
<p>这是 ng 最强大的一部分，也是最复杂最让人头疼的部分。</p>
<p>目前我们看到的所谓“模板”系统，只不过是官方实现的几个指令而已。这意味着，通过自定义各种指令，我们不但可以完全定义一套“模板”系统，更可以把 HTML 页面直接打造成为一种 DSL （领域特定语言）。</p>
<h4 id="指令的使用">指令的使用</h4>
<p>使用指令时，它的名字可以有多种形式，把指令放在什么地方也有多种选择。</p>
<p>通常，指令的定义名是形如 ngBind 这样的 “camel cased” 形式。在使用时，它的引用名可以是：</p>
<ol>
<li>ng:bind</li>
<li>ng_bind</li>
<li>ng-bind</li>
<li>x-ng-bind</li>
<li>data-ng-bind<br>你可以根据你自己是否有 “HTML validator” 洁癖来选择。</li>
</ol>
<p>指令可以放在多个地方，它们的作用相同：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="title">span</span> <span class="attribute">my-dir</span>=<span class="value">"exp"</span>&gt;</span><span class="tag">&lt;/<span class="title">span</span>&gt;</span> 作为标签的属性</div><div class="line"><span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"my-dir: exp;"</span>&gt;</span><span class="tag">&lt;/<span class="title">span</span>&gt;</span> 作为标签类属性的值</div><div class="line"><span class="tag">&lt;<span class="title">my-dir</span>&gt;</span><span class="tag">&lt;/<span class="title">my-dir</span>&gt;</span> 作为标签</div><div class="line"><span class="comment">&lt;!-- directive: my-dir exp --&gt;</span> 作为注释</div></pre></td></tr></table></figure>

<p>这些方式可以使用指令定义中的 restrict 属性来控制。</p>
<p>可以看出，指令即可以作为标签使用，也可以作为属性使用。仔细考虑一下，这在类 XML 的结构当中真算得上是一种神奇的机制。</p>
<h4 id="指令的执行过程">指令的执行过程</h4>
<p>ng 中对指令的解析与执行过程是这样的：</p>
<ol>
<li>浏览器得到 HTML 字符串内容，解析得到 DOM 结构。</li>
<li>ng 引入，把 DOM 结构扔给 $compile 函数处理：<br> 找出 DOM 结构中有变量占位符<br> 匹配找出 DOM 中包含的所有指令引用<br> 把指令关联到 DOM<br> 关联到 DOM 的多个指令按权重排列<br> 执行指令中的 compile 函数（改变 DOM 结构，返回 link 函数）<br> 得到的所有 link 函数组成一个列表作为 $compile 函数的返回</li>
<li>执行 link 函数（连接模板的 scope）。</li>
</ol>
<h4 id="基本的自定义方法">基本的自定义方法</h4>
<p>自定义一个指令可以非常非常的复杂，但是其基本的调用形式，同自定义服务大概是相同的：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="title">p</span> <span class="attribute">show</span> <span class="attribute">style</span>=<span class="value">"font-size: 12px;"</span>&gt;</span><span class="tag">&lt;/<span class="title">p</span>&gt;</span></div><div class="line"></div><div class="line"><span class="tag">&lt;<span class="title">script</span> <span class="attribute">type</span>=<span class="value">"text/javascript"</span>&gt;</span><span class="javascript"></span></div><div class="line"></div><div class="line"><span class="keyword">var</span> app = angular.module(<span class="string">'Demo'</span>, [], angular.noop);</div><div class="line"></div><div class="line">app.directive(<span class="string">'show'</span>, <span class="function"><span class="keyword">function</span><span class="params">()</span></span>{</div><div class="line">  <span class="keyword">var</span> func = <span class="function"><span class="keyword">function</span><span class="params">($scope, $element, $attrs)</span></span>{</div><div class="line">    <span class="built_in">console</span>.log($scope);</div><div class="line">    <span class="built_in">console</span>.log($element);</div><div class="line">    <span class="built_in">console</span>.log($attrs);</div><div class="line">  }    </div><div class="line">  <span class="keyword">return</span> func;</div><div class="line">  <span class="comment">//return {compile: function(){return func}}</span></div><div class="line">});</div><div class="line"></div><div class="line">angular.bootstrap(<span class="built_in">document</span>, [<span class="string">'Demo'</span>]);</div><div class="line"><span class="tag">&lt;/<span class="title">script</span>&gt;</span></div></pre></td></tr></table></figure>

<p>如果在 directive 中直接返回一个函数，则这个函数会作为 compile 的返回值，也即是作为 link 函数使用。这里说的 compile 和 link 都是一个指令的组成部分，一个完整的定义应该返回一个对象，这个对象包括了多个属性：</p>
<p>+name<br>+priority<br>+terminal<br>+scope<br>+controller<br>+require<br>+restrict<br>+template<br>+templateUrl<br>+replace<br>+transclude<br>+compile<br>+link<br>上面的每一个属性，都可以单独探讨的。</p>
<p>下面是一个完整的基本的指令定义例子：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div></pre></td><td class="code"><pre><div class="line">&lt;code lines&gt;</div><div class="line"><span class="comment">//失去焦点使用 jQuery 的扩展支持冒泡</span></div><div class="line">app.directive(<span class="string">'ngBlur'</span>, <span class="function"><span class="keyword">function</span><span class="params">(<span class="variable">$parse</span>)</span></span>{</div><div class="line">  <span class="keyword">return</span> <span class="function"><span class="keyword">function</span><span class="params">(<span class="variable">$scope</span>, <span class="variable">$element</span>, <span class="variable">$attr</span>)</span></span>{</div><div class="line">    <span class="keyword">var</span> fn = <span class="variable">$parse</span>(<span class="variable">$attr</span>[<span class="string">'ngBlur'</span>]);</div><div class="line">    <span class="variable">$element</span>.on(<span class="string">'focusout'</span>, <span class="function"><span class="keyword">function</span><span class="params">(event)</span></span>{</div><div class="line">      fn(<span class="variable">$scope</span>, {<span class="variable">$event</span>: event});</div><div class="line">    });</div><div class="line">  }</div><div class="line">});</div><div class="line">&lt;/code&gt;</div><div class="line"></div><div class="line">&lt;div code lines&gt;</div><div class="line"><span class="comment">//失去焦点使用 jQuery 的扩展支持冒泡</span></div><div class="line">app.directive(<span class="string">'ngBlur'</span>, <span class="function"><span class="keyword">function</span><span class="params">(<span class="variable">$parse</span>)</span></span>{</div><div class="line">  <span class="keyword">return</span> <span class="function"><span class="keyword">function</span><span class="params">(<span class="variable">$scope</span>, <span class="variable">$element</span>, <span class="variable">$attr</span>)</span></span>{</div><div class="line">    <span class="keyword">var</span> fn = <span class="variable">$parse</span>(<span class="variable">$attr</span>[<span class="string">'ngBlur'</span>]);</div><div class="line">    <span class="variable">$element</span>.on(<span class="string">'focusout'</span>, <span class="function"><span class="keyword">function</span><span class="params">(event)</span></span>{</div><div class="line">      fn(<span class="variable">$scope</span>, {<span class="variable">$event</span>: event});</div><div class="line">    });</div><div class="line">  }</div><div class="line">});</div><div class="line">&lt;/div&gt;</div><div class="line"> <span class="keyword">var</span> app = angular.module(<span class="string">'Demo'</span>, [], angular.noop);</div><div class="line"> </div><div class="line"> app.directive(<span class="string">'code'</span>, <span class="function"><span class="keyword">function</span><span class="params">()</span></span>{</div><div class="line">   <span class="keyword">var</span> func = <span class="function"><span class="keyword">function</span><span class="params">(<span class="variable">$scope</span>, <span class="variable">$element</span>, <span class="variable">$attrs</span>)</span></span>{</div><div class="line"> </div><div class="line">     <span class="keyword">var</span> html = <span class="variable">$element</span>.text();</div><div class="line">     <span class="keyword">var</span> lines = html.split(<span class="string">'\n'</span>);</div><div class="line"> </div><div class="line">     <span class="comment">//处理首尾空白</span></div><div class="line">     <span class="keyword">if</span>(lines[<span class="number">0</span>] == <span class="string">''</span>){lines = lines.slice(<span class="number">1</span>, lines.length - <span class="number">1</span>)}</div><div class="line">     <span class="keyword">if</span>(lines[lines.length-<span class="number">1</span>] == <span class="string">''</span>){lines = lines.slice(<span class="number">0</span>, lines.length - <span class="number">1</span>)}</div><div class="line"> </div><div class="line">     <span class="variable">$element</span>.<span class="keyword">empty</span>();</div><div class="line"> </div><div class="line">     <span class="comment">//处理外框</span></div><div class="line">     (<span class="function"><span class="keyword">function</span><span class="params">()</span></span>{</div><div class="line">       <span class="variable">$element</span>.css(<span class="string">'clear'</span>, <span class="string">'both'</span>);</div><div class="line">       <span class="variable">$element</span>.css(<span class="string">'display'</span>, <span class="string">'block'</span>);</div><div class="line">       <span class="variable">$element</span>.css(<span class="string">'line-height'</span>, <span class="string">'20px'</span>);</div><div class="line">       <span class="variable">$element</span>.css(<span class="string">'height'</span>, <span class="string">'200px'</span>);</div><div class="line">     })();</div><div class="line"> </div><div class="line">     <span class="comment">//是否显示行号的选项</span></div><div class="line">     <span class="keyword">if</span>(<span class="string">'lines'</span> in <span class="variable">$attrs</span>){</div><div class="line">       <span class="comment">//处理行号</span></div><div class="line">       (<span class="function"><span class="keyword">function</span><span class="params">()</span></span>{</div><div class="line">         <span class="keyword">var</span> div = $(<span class="string">'&lt;div style="width: %spx; background-color: gray; float: left; text-align: right; padding-right: 5px; margin-right: 10px;"&gt;&lt;/div&gt;'</span></div><div class="line">                     .replace(<span class="string">'%s'</span>, String(lines.length).length * <span class="number">10</span>));</div><div class="line">         <span class="keyword">var</span> s = <span class="string">''</span>;</div><div class="line">         angular.<span class="keyword">forEach</span>(lines, <span class="function"><span class="keyword">function</span><span class="params">(_, i)</span></span>{</div><div class="line">           s += <span class="string">'&lt;pre style="margin: 0;"&gt;%s&lt;/pre&gt;\n'</span>.replace(<span class="string">'%s'</span>, i + <span class="number">1</span>);</div><div class="line">         });</div><div class="line">         div.html(s);</div><div class="line">         <span class="variable">$element</span>.append(div);</div><div class="line">       })();</div><div class="line">     }</div><div class="line"> </div><div class="line">     <span class="comment">//处理内容</span></div><div class="line">     (<span class="function"><span class="keyword">function</span><span class="params">()</span></span>{</div><div class="line">       <span class="keyword">var</span> div = $(<span class="string">'&lt;div style="float: left;"&gt;&lt;/div&gt;'</span>);</div><div class="line">       <span class="keyword">var</span> s = <span class="string">''</span>;</div><div class="line">       angular.<span class="keyword">forEach</span>(lines, <span class="function"><span class="keyword">function</span><span class="params">(l)</span></span>{</div><div class="line">         s += <span class="string">'&lt;span style="margin: 0;"&gt;%s&lt;/span&gt;&lt;br /&gt;\n'</span>.replace(<span class="string">'%s'</span>, l.replace(/\s/g, <span class="string">'&lt;span&gt;&nbsp;&lt;/span&gt;'</span>));</div><div class="line">       });</div><div class="line">       div.html(s);</div><div class="line">       <span class="variable">$element</span>.append(div);</div><div class="line">     })();</div><div class="line">   }</div><div class="line"> </div><div class="line">   <span class="keyword">return</span> {link: func,</div><div class="line">           restrict: <span class="string">'AE'</span>}; <span class="comment">//以元素或属性的形式使用命令</span></div><div class="line"> });</div><div class="line"> </div><div class="line"> angular.bootstrap(document, [<span class="string">'Demo'</span>]);</div></pre></td></tr></table></figure>

<p>上面这个自定义的指令，做的事情就是解析节点中的文本内容，然后修改它，再把生成的新内容填充到节点当中去。其间还涉及了节点属性值 lines 的处理。这算是指令中最简单的一种形式。因为它是“一次性使用”，中间没有变量的处理。比如如果节点原来的文本内容是一个变量引用，类似于 {{ code }} ，那上面的代码就不行了。这种情况麻烦得多。后面会讨论。</p>
<h4 id="属性值类型的自定义">属性值类型的自定义</h4>
<p>官方代码中的 ng-show 等算是我说的这种类型。使用时主要是在节点加添加一个属性值以附加额外的功能。看一个简单的例子：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="title">p</span> <span class="attribute">color</span>=<span class="value">"red"</span>&gt;</span>有颜色的文本<span class="tag">&lt;/<span class="title">p</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="title">color</span> <span class="attribute">color</span>=<span class="value">"red"</span>&gt;</span>有颜色的文本<span class="tag">&lt;/<span class="title">color</span>&gt;</span></div><div class="line"></div><div class="line"><span class="tag">&lt;<span class="title">script</span> <span class="attribute">type</span>=<span class="value">"text/javascript"</span>&gt;</span><span class="javascript"></span></div><div class="line"></div><div class="line"><span class="keyword">var</span> app = angular.module(<span class="string">'Demo'</span>, [], angular.noop);</div><div class="line"></div><div class="line">app.directive(<span class="string">'color'</span>, <span class="function"><span class="keyword">function</span><span class="params">()</span></span>{</div><div class="line">  <span class="keyword">var</span> link = <span class="function"><span class="keyword">function</span><span class="params">($scope, $element, $attrs)</span></span>{</div><div class="line">    $element.css(<span class="string">'color'</span>, $attrs.color);</div><div class="line">  }</div><div class="line">  <span class="keyword">return</span> {link: link,</div><div class="line">          restrict: <span class="string">'AE'</span>};</div><div class="line">});</div><div class="line"></div><div class="line">angular.bootstrap(<span class="built_in">document</span>, [<span class="string">'Demo'</span>]);</div><div class="line"><span class="tag">&lt;/<span class="title">script</span>&gt;</span></div></pre></td></tr></table></figure>

<p>我们定义了一个叫 color 的指令，可以指定节点文本的颜色。但是这个例子还无法像 ng-show 那样工作的，这个例子只能渲染一次，然后就无法根据变量来重新改变显示了。要响应变化，我们需要手工使用 scope 的 \$watch 来处理：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="title">div</span> <span class="attribute">ng-controller</span>=<span class="value">"TestCtrl"</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="title">p</span> <span class="attribute">color</span>=<span class="value">"color"</span>&gt;</span>有颜色的文本<span class="tag">&lt;/<span class="title">p</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="title">p</span> <span class="attribute">color</span>=<span class="value">"'blue'"</span>&gt;</span>有颜色的文本<span class="tag">&lt;/<span class="title">p</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="title">div</span>&gt;</span></div><div class="line"></div><div class="line"><span class="tag">&lt;<span class="title">script</span> <span class="attribute">type</span>=<span class="value">"text/javascript"</span>&gt;</span><span class="javascript"></span></div><div class="line"></div><div class="line"><span class="keyword">var</span> app = angular.module(<span class="string">'Demo'</span>, [], angular.noop);</div><div class="line"></div><div class="line">app.directive(<span class="string">'color'</span>, <span class="function"><span class="keyword">function</span><span class="params">()</span></span>{</div><div class="line">  <span class="keyword">var</span> link = <span class="function"><span class="keyword">function</span><span class="params">($scope, $element, $attrs)</span></span>{</div><div class="line">    $scope.$watch($attrs.color, <span class="function"><span class="keyword">function</span><span class="params">(new_v)</span></span>{</div><div class="line">      $element.css(<span class="string">'color'</span>, new_v);</div><div class="line">    });</div><div class="line">  }</div><div class="line">  <span class="keyword">return</span> link;</div><div class="line">});</div><div class="line"></div><div class="line">app.controller(<span class="string">'TestCtrl'</span>, <span class="function"><span class="keyword">function</span><span class="params">($scope)</span></span>{</div><div class="line">  $scope.color = <span class="string">'red'</span>;</div><div class="line">});</div><div class="line"></div><div class="line">angular.bootstrap(<span class="built_in">document</span>, [<span class="string">'Demo'</span>]);</div><div class="line"><span class="tag">&lt;/<span class="title">script</span>&gt;</span></div></pre></td></tr></table></figure>

<h4 id="Compile的细节">Compile的细节</h4>
<p>指令的处理过程，是 ng 的 Compile 过程的一部分，它们也是紧密联系的。继续深入指令的定义方法，首先就要对 Compile 的过程做更细致的了解。</p>
<p>前面说过， ng 对页面的处理过程：</p>
<p>浏览器把 HTML 字符串解析成 DOM 结构。<br>ng 把 DOM 结构给 \$compile ，返回一个 link 函数。<br>传入具体的 scope 调用这个 link 函数。<br>得到处理后的 DOM ，这个 DOM 处理了指令，连接了数据。<br>\$compile 最基本的使用方式：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">var</span> <span class="keyword">link</span> <span class="subst">=</span> <span class="variable">$compile</span>(<span class="string">'&lt;p&gt;\{\{ text }}&lt;/p&gt;'</span>);</div><div class="line"><span class="built_in">var</span> node <span class="subst">=</span> <span class="keyword">link</span>(<span class="variable">$scope</span>);</div><div class="line">console<span class="built_in">.</span><span class="keyword">log</span>(node);</div></pre></td></tr></table></figure>

<p>上面的 \$compile 和 link 调用时都有额外参数来实现其它功能。先看 link 函数，它形如：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span>(<span class="title">scope</span>[, <span class="title">cloneAttachFn</span>]</span></div></pre></td></tr></table></figure>

<p>第二个参数 cloneAttachFn 的作用是，表明是否复制原始节点，及对复制节点需要做的处理，下面这个例子说明了它的作用：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">&lt;div ng-controller=<span class="string">"TestCtrl"</span>&gt;&lt;/div&gt;</div><div class="line">&lt;div id=<span class="string">"a"</span>&gt;A \{\{ text }}&lt;/div&gt;</div><div class="line">&lt;div id=<span class="string">"b"</span>&gt;B &lt;/div&gt;</div><div class="line">app.controller(<span class="string">'TestCtrl'</span>, <span class="function"><span class="keyword">function</span><span class="params">(<span class="variable">$scope</span>, <span class="variable">$compile</span>)</span></span>{</div><div class="line">  <span class="keyword">var</span> link = <span class="variable">$compile</span>($(<span class="string">'#a'</span>));</div><div class="line"></div><div class="line">  <span class="comment">//true参数表示新建一个完全隔离的scope,而不是继承的child scope</span></div><div class="line">  <span class="keyword">var</span> scope = <span class="variable">$scope</span>.<span class="variable">$new</span>(<span class="keyword">true</span>);</div><div class="line">  scope.text = <span class="string">'12345'</span>;</div><div class="line"></div><div class="line">  <span class="comment">//var node = link(scope, function(){});</span></div><div class="line">  <span class="keyword">var</span> node = link(scope);</div><div class="line"></div><div class="line">  $(<span class="string">'#b'</span>).append(node);</div><div class="line">});</div></pre></td></tr></table></figure>

<p>cloneAttachFn 对节点的处理是有限制的，你可以添加 class ，但是不能做与数据绑定有关的其它修改（修改了也无效）：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">app.controller(<span class="string">'TestCtrl'</span>, <span class="function"><span class="keyword">function</span><span class="params">(<span class="variable">$scope</span>, <span class="variable">$compile</span>)</span></span>{</div><div class="line">  <span class="keyword">var</span> link = <span class="variable">$compile</span>($(<span class="string">'#a'</span>));</div><div class="line">  <span class="keyword">var</span> scope = <span class="variable">$scope</span>.<span class="variable">$new</span>(<span class="keyword">true</span>);</div><div class="line">  scope.text = <span class="string">'12345'</span>;</div><div class="line"></div><div class="line">  <span class="keyword">var</span> node = link(scope, <span class="function"><span class="keyword">function</span><span class="params">(clone_element, scope)</span></span>{</div><div class="line">    clone_element.text(clone_element.text() + <span class="string">' ...'</span>); <span class="comment">//无效</span></div><div class="line">    clone_element.text(<span class="string">'\{\{ text2 }}'</span>); <span class="comment">//无效</span></div><div class="line">    clone_element.addClass(<span class="string">'new_class'</span>);</div><div class="line">  });</div><div class="line"></div><div class="line">  $(<span class="string">'#b'</span>).append(node);</div><div class="line">});</div></pre></td></tr></table></figure>

<p>修改无效的原因是，像 {{ text }} 这种所谓的 Interpolate 在 \$compile 中已经被处理过了，生成了相关函数（这里起作用的是 directive 中的一个 postLink 函数），后面执行 link 就是执行了 \$compile 生成的这些函数。当然，如果你的文本没有数据变量的引用，那修改是会有效果的。</p>
<p>前面在说自定义指令时说过， link 函数是由 compile 函数返回的，也就像前面说的，应该把改变 DOM 结构的逻辑放在 compile 函数中做。</p>
<p>\$compile 还有两个额外的参数：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="variable">$compile</span>(element, transclude, maxPriority);</div></pre></td></tr></table></figure>

<p>maxPriority 是指令的权重限制，这个容易理解，后面再说。</p>
<p>transclude 是一个函数，这个函数会传递给 compile 期间找到的 directive 的 compile 函数（编译节点的过程中找到了指令，指令的 compile 函数会接受编译时传递的 transclude 函数作为其参数）。</p>
<p>但是在实际使用中，除我们手工在调用 \$compile 之外，初始化时的根节点 compile 是不会传递这个参数的。</p>
<p>在我们定义指令时，它的 compile 函数是这个样子的：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">function</span> compile(tElement, tAttrs, transclude) { <span class="keyword">...</span> }</div></pre></td></tr></table></figure>

<p>事实上， transclude 的值，就是 directive 所在的 原始 节点，把原始节点重新做了编译之后得到的 link 函数（需要 directive 定义时使用 transclude 选项），后面会专门演示这个过程。所以，官方文档上也把 transclude 函数描述成 link 函数的样子（如果自定义的指令只用在自己手动 $compile 的环境中，那这个函数的形式是可以随意的）：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">{<span class="function"><span class="keyword">function</span>(<span class="title">angular</span>.<span class="title">Scope</span>[, <span class="title">cloneAttachFn</span>]}</span></div></pre></td></tr></table></figure>

<p>所以记住，定义指令时， compile 函数的第三个参数 transclude ，就是一个 link ，装入 scope 执行它你就得到了一个节点。</p>
<h4 id="transclude的细节">transclude的细节</h4>
<p>transclude 有两方面的东西，一个是使用 \$compile 时传入的函数，另一个是定义指令的 compile 函数时接受的一个参数。虽然这里的一出一进本来是相互对应的，但是实际使用中，因为大部分时候不会手动调用 \$compile ，所以，在“默认”情况下，指令接受的 transclude 又会是一个比较特殊的函数。</p>
<p>看一个基本的例子：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> app = angular.module(<span class="string">'Demo'</span>, [], angular.noop);</div><div class="line"></div><div class="line">app.directive(<span class="string">'more'</span>, <span class="function"><span class="keyword">function</span><span class="params">()</span></span>{</div><div class="line">  <span class="keyword">var</span> func = <span class="function"><span class="keyword">function</span><span class="params">(element, attrs, transclude)</span></span>{</div><div class="line">    <span class="keyword">var</span> sum = transclude(<span class="number">1</span>, <span class="number">2</span>);</div><div class="line">    console.log(sum);</div><div class="line">    console.log(element);  </div><div class="line">  }</div><div class="line"></div><div class="line">  <span class="keyword">return</span> {compile: func,</div><div class="line">          restrict: <span class="string">'E'</span>};</div><div class="line">});</div><div class="line"></div><div class="line">app.controller(<span class="string">'TestCtrl'</span>, <span class="function"><span class="keyword">function</span><span class="params">(<span class="variable">$scope</span>, <span class="variable">$compile</span>, <span class="variable">$element</span>)</span></span>{</div><div class="line">  <span class="keyword">var</span> s = <span class="string">'&lt;more&gt;123&lt;/more&gt;'</span>;</div><div class="line">  <span class="keyword">var</span> link = <span class="variable">$compile</span>(s, <span class="function"><span class="keyword">function</span><span class="params">(a, b)</span></span>{<span class="keyword">return</span> a + b});</div><div class="line">  <span class="keyword">var</span> node = link(<span class="variable">$scope</span>);</div><div class="line">  <span class="variable">$element</span>.append(node);</div><div class="line">});</div><div class="line"></div><div class="line">angular.bootstrap(document, [<span class="string">'Demo'</span>]);</div></pre></td></tr></table></figure>

<p>我们定义了一个 more 指令，它的 compile 函数的第三个参数，就是我们手工 \$compile 时传入的。</p>
<p>如果不是手工 \$compile ，而是 ng 初始化时找出的指令，则 transclude 是一个 link 函数（指令定义需要设置 transclude 选项）：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">&lt;div more&gt;<span class="number">123</span>&lt;/div&gt;</div><div class="line">app.directive(<span class="string">'more'</span>, <span class="function"><span class="keyword">function</span><span class="params">(<span class="variable">$rootScope</span>, <span class="variable">$document</span>)</span></span>{</div><div class="line">  <span class="keyword">var</span> func = <span class="function"><span class="keyword">function</span><span class="params">(element, attrs, link)</span></span>{</div><div class="line">    <span class="keyword">var</span> node = link(<span class="variable">$rootScope</span>);</div><div class="line">    node.removeAttr(<span class="string">'more'</span>); <span class="comment">//不去掉就变死循环了</span></div><div class="line">    $(<span class="string">'body'</span>, <span class="variable">$document</span>).append(node);</div><div class="line">  }</div><div class="line"></div><div class="line">  <span class="keyword">return</span> {compile: func,</div><div class="line">          transclude: <span class="string">'element'</span>, <span class="comment">// element是节点没,其它值是节点的内容没</span></div><div class="line">          restrict: <span class="string">'A'</span>};</div><div class="line">});</div></pre></td></tr></table></figure>

<h4 id="把节点内容作为变量处理的类型">把节点内容作为变量处理的类型</h4>
<p>回顾最开始的那个代码显示的例子，那个例子只能处理一次节点内容。如果节点的内容是一个变量的话，需要用另外的思路来考虑。这里我们假设的例子是，定义一个指令 showLenght ，它的作用是在一段文本的开头显示出这段节点文本的长度，节点文本是一个变量。指令使用的形式是：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="title">div</span> <span class="attribute">ng-controller</span>=<span class="value">"TestCtrl"</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="title">div</span> <span class="attribute">show-length</span>&gt;</span>\{\{ text }}<span class="tag">&lt;/<span class="title">div</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="title">button</span> <span class="attribute">ng-click</span>=<span class="value">"text='xx'"</span>&gt;</span>改变<span class="tag">&lt;/<span class="title">button</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="title">div</span>&gt;</span></div></pre></td></tr></table></figure>

<p>从上面的 HTML 代码中，大概清楚 ng 解析它的过程（只看 show-length 那一行）：</p>
<ol>
<li>解析 div 时发现了一个 show-length 的指令。</li>
<li>如果 show-length 指令设置了 transclude 属性，则 div 的节点内容被重新编译，得到的 link 函数作为指令 compile 函数的参数传入。</li>
<li>如果 show-length 指令没有设置 transclude 属性，则继续处理它的子节点（ TextNode ）。</li>
<li>不管是上面的哪种情况，都会继续处理到 {{ text }} 这段文本。</li>
<li>发现 {{ text }} 是一个 Interpolate ，于是自动在此节点中添加了一个指令，这个指令的 link 函数就是为 scope 添加了一个 \$watch ，实现的功能是是当 scope 作 \$digest 的时候，就更新节点文本。</li>
</ol>
<p>与处理 {{ text }} 时添加的指令相同，我们实现 showLength 的思路，也就是：</p>
<ol>
<li>修改原来的 DOM 结构</li>
<li>为 scope 添加 \$watch ，当 \$digest 时修改指定节点的文本，其值为指定节点文本的长度。<br>代码如下：</li>
</ol>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">app.directive(<span class="string">'showLength'</span>, <span class="function"><span class="keyword">function</span><span class="params">(<span class="variable">$rootScope</span>, <span class="variable">$document</span>)</span></span>{</div><div class="line">  <span class="keyword">var</span> func = <span class="function"><span class="keyword">function</span><span class="params">(element, attrs, link)</span></span>{</div><div class="line"></div><div class="line">    <span class="keyword">return</span> <span class="function"><span class="keyword">function</span><span class="params">(scope, ielement, iattrs, controller)</span></span>{</div><div class="line">      <span class="keyword">var</span> node = link(scope);</div><div class="line">      ielement.append(node);</div><div class="line">      <span class="keyword">var</span> lnode = $(<span class="string">'&lt;span&gt;&lt;/span&gt;'</span>);</div><div class="line">      ielement.prepend(lnode);</div><div class="line"></div><div class="line">      scope.<span class="variable">$watch</span>(<span class="function"><span class="keyword">function</span><span class="params">(scope)</span></span>{</div><div class="line">        lnode.text(node.text().length);</div><div class="line">      });</div><div class="line">    };</div><div class="line">  }</div><div class="line"></div><div class="line">  <span class="keyword">return</span> {compile: func,</div><div class="line">          transclude: <span class="keyword">true</span>, <span class="comment">// element是节点没,其它值是节点的内容没</span></div><div class="line">          restrict: <span class="string">'A'</span>};</div><div class="line">});</div></pre></td></tr></table></figure>

<p>上面代码中，因为设置了 transclude 属性，我们在 showLength 的 link 函数（就是 return 的那个函数）中，使用 func 的第三个函数来重塑了原来的文本节点，并放在我们需要的位置上。然后，我们添加自己的节点来显示长度值。最后给当前的 scope 添加 \$watch ，以更新这个长度值。</p>
<h4 id="指令定义时的参数">指令定义时的参数</h4>
<p>指令定义时的参数如下：</p>
<p>name<br>priority<br>terminal<br>scope<br>controller<br>require<br>restrict<br>template<br>templateUrl<br>replace<br>transclude<br>compile<br>link<br>现在我们开始一个一个地吃掉它们……，但是并不是按顺序讲的。</p>
<p><em>priority</em><br>这个值设置指令的权重，默认是 0 。当一个节点中有多个指令存在时，就按着权限从大到小的顺序依次执行它们的 compile 函数。相同权重顺序不定。<br><em>terminal</em><br>是否以当前指令的权重为结束界限。如果这值设置为 true ，则节点中权重小于当前指令的其它指令不会被执行。相同权重的会执行。<br><em>restrict</em><br>指令可以以哪些方式被使用，可以同时定义多种方式。</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">E 元素方式 <span class="tag">&lt;<span class="title">my-directive</span>&gt;</span><span class="tag">&lt;/<span class="title">my-directive</span>&gt;</span></div><div class="line">A 属性方式 <span class="tag">&lt;<span class="title">div</span> <span class="attribute">my-directive</span>=<span class="value">"exp"</span>&gt;</span> <span class="tag">&lt;/<span class="title">div</span>&gt;</span></div><div class="line">C 类方式 <span class="tag">&lt;<span class="title">div</span> <span class="attribute">class</span>=<span class="value">"my-directive: exp;"</span>&gt;</span><span class="tag">&lt;/<span class="title">div</span>&gt;</span></div><div class="line">M 注释方式 <span class="comment">&lt;!-- directive: my-directive exp --&gt;</span></div></pre></td></tr></table></figure>

<p><em>transclude</em><br>前面已经讲过基本的用法了。可以是 ‘element’ 或 true 两种值。<br><em>compile</em><br>基本的定义函数。 function compile(tElement, tAttrs, transclude) { … }<br><em>link</em><br>前面介绍过了。大多数时候我们不需要单独定义它。只有 compile 未定义时 link 才会被尝试。 function link(scope, iElement, iAttrs, controller) { … }<br><em>scope</em><br>scope 的形式。 false 节点的 scope ， true 继承创建一个新的 scope ， {} 不继承创建一个新的隔离 scope 。 {@attr: ‘引用节点属性’, =attr: ‘把节点属性值引用成scope属性值’, &amp;attr: ‘把节点属性值包装成函数’}<br><em>controller</em><br>为指令定义一个 controller ， function controller($scope, $element, $attrs, $transclude) { … }<br><em>name</em><br>指令的 controller 的名字，方便其它指令引用。<br><em>require</em><br>要引用的其它指令 conroller 的名字， ?name 忽略不存在的错误， ^name 在父级查找。<br><em>template</em><br>模板内容。<br><em>templateUrl</em><br>从指定地址获取模板内容。<br><em>replace</em><br>是否使用模板内容替换掉整个节点， true 替换整个节点， false 替换节点内容。</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line">&lt;a b&gt;&lt;/a&gt;</div><div class="line"><span class="keyword">var</span> app = angular.module(<span class="string">'Demo'</span>, [], angular.noop);</div><div class="line"></div><div class="line">app.directive(<span class="string">'a'</span>, <span class="function"><span class="keyword">function</span><span class="params">()</span></span>{</div><div class="line">  <span class="keyword">var</span> func = <span class="function"><span class="keyword">function</span><span class="params">(element, attrs, link)</span></span>{</div><div class="line">    console.log(<span class="string">'a'</span>);</div><div class="line">  }</div><div class="line"></div><div class="line">  <span class="keyword">return</span> {compile: func,</div><div class="line">          priority: <span class="number">1</span>,</div><div class="line">          restrict: <span class="string">'EA'</span>};</div><div class="line">});</div><div class="line"></div><div class="line">app.directive(<span class="string">'b'</span>, <span class="function"><span class="keyword">function</span><span class="params">()</span></span>{</div><div class="line">  <span class="keyword">var</span> func = <span class="function"><span class="keyword">function</span><span class="params">(element, attrs, link)</span></span>{</div><div class="line">    console.log(<span class="string">'b'</span>);</div><div class="line">  }</div><div class="line"></div><div class="line">  <span class="keyword">return</span> {compile: func,</div><div class="line">          priority: <span class="number">2</span>,</div><div class="line">          <span class="comment">//terminal: true,</span></div><div class="line">          restrict: <span class="string">'A'</span>};</div><div class="line">});</div></pre></td></tr></table></figure>

<p>上面几个参数值都是比较简单且容易理想的。</p>
<p>再看 scope 这个参数：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line">&lt;div ng-controller=<span class="string">"TestCtrl"</span>&gt;</div><div class="line">  &lt;div a b&gt;&lt;/div&gt;</div><div class="line">&lt;/div&gt;</div><div class="line"> <span class="keyword">var</span> app = angular.module(<span class="string">'Demo'</span>, [], angular.noop);</div><div class="line"> </div><div class="line"> app.directive(<span class="string">'a'</span>, <span class="function"><span class="keyword">function</span><span class="params">()</span></span>{</div><div class="line">   <span class="keyword">var</span> func = <span class="function"><span class="keyword">function</span><span class="params">(element, attrs, link)</span></span>{</div><div class="line">     <span class="keyword">return</span> <span class="function"><span class="keyword">function</span><span class="params">(scope)</span></span>{</div><div class="line">       console.log(scope);</div><div class="line">     }</div><div class="line">   }</div><div class="line"> </div><div class="line">   <span class="keyword">return</span> {compile: func,</div><div class="line">           scope: <span class="keyword">true</span>,</div><div class="line">           restrict: <span class="string">'A'</span>};</div><div class="line"> });</div><div class="line"> </div><div class="line"> app.directive(<span class="string">'b'</span>, <span class="function"><span class="keyword">function</span><span class="params">()</span></span>{</div><div class="line">   <span class="keyword">var</span> func = <span class="function"><span class="keyword">function</span><span class="params">(element, attrs, link)</span></span>{</div><div class="line">     <span class="keyword">return</span> <span class="function"><span class="keyword">function</span><span class="params">(scope)</span></span>{</div><div class="line">       console.log(scope);</div><div class="line">     }</div><div class="line">   }</div><div class="line"> </div><div class="line">   <span class="keyword">return</span> {compile: func,</div><div class="line">           restrict: <span class="string">'A'</span>};</div><div class="line"> });</div><div class="line"> </div><div class="line"> app.controller(<span class="string">'TestCtrl'</span>, <span class="function"><span class="keyword">function</span><span class="params">(<span class="variable">$scope</span>)</span></span>{</div><div class="line">   <span class="variable">$scope</span>.a = <span class="string">'123'</span>;</div><div class="line">   console.log(<span class="variable">$scope</span>);</div><div class="line"> });</div></pre></td></tr></table></figure>

<p>对于 scope ：</p>
<p>默认为 false ， link 函数接受的 scope 为节点所在的 scope 。<br>为 true 时，则 link 函数中第一个参数（还有 controller 参数中的 \$scope ）， scope 是节点所在的 scope 的 child scope ，并且如果节点中有多个指令，则只要其中一个指令是 true 的设置，其它所有指令都会受影响。<br>这个参数还有其它取值。当其为 {} 时，则 link 接受一个完全隔离（isolate）的 scope ，于 true 的区别就是不会继承其它 scope 的属性。但是这时，这个 scope 的属性却可以有很灵活的定义方式：</p>
<p>@attr 引用节点的属性。</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">&lt;div ng-controller=<span class="string">"TestCtrl"</span>&gt;</div><div class="line">  &lt;div a abc=<span class="string">"here"</span> xx=<span class="string">"\{\{ a }}"</span> c=<span class="string">"ccc"</span>&gt;&lt;/div&gt;</div><div class="line">&lt;/div&gt;</div><div class="line"><span class="keyword">var</span> app = angular.module(<span class="string">'Demo'</span>, [], angular.noop);</div><div class="line"></div><div class="line">app.directive(<span class="string">'a'</span>, <span class="function"><span class="keyword">function</span><span class="params">()</span></span>{</div><div class="line">  <span class="keyword">var</span> func = <span class="function"><span class="keyword">function</span><span class="params">(element, attrs, link)</span></span>{</div><div class="line">    <span class="keyword">return</span> <span class="function"><span class="keyword">function</span><span class="params">(scope)</span></span>{</div><div class="line">      console.log(scope);</div><div class="line">    }</div><div class="line">  }</div><div class="line"></div><div class="line">  <span class="keyword">return</span> {compile: func,</div><div class="line">          scope: {a: <span class="string">'@abc'</span>, b: <span class="string">'@xx'</span>, c: <span class="string">'@'</span>},</div><div class="line">          restrict: <span class="string">'A'</span>};</div><div class="line">});</div><div class="line"></div><div class="line">app.controller(<span class="string">'TestCtrl'</span>, <span class="function"><span class="keyword">function</span><span class="params">(<span class="variable">$scope</span>)</span></span>{</div><div class="line">  <span class="variable">$scope</span>.a = <span class="string">'123'</span>;</div><div class="line">});</div></pre></td></tr></table></figure>

<p>@abc 引用 div 节点的 abc 属性。<br>@xx 引用 div 节点的 xx 属性，而 xx 属性又是一个变量绑定，于是 scope 中 b 属性值就和 TestCtrl 的 a 变量绑定在一起了。<br>@ 没有写 attr name ，则默认取自己的值，这里是取 div 的 c 属性。<br>=attr 相似，只是它把节点的属性值当成节点 scope 的属性名来使用，作用相当于上面例子中的 @xx ：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">&lt;div ng-controller=<span class="string">"TestCtrl"</span>&gt;</div><div class="line">  &lt;div a abc=<span class="string">"here"</span>&gt;&lt;/div&gt;</div><div class="line">&lt;/div&gt;</div><div class="line"><span class="keyword">var</span> app = angular.module(<span class="string">'Demo'</span>, [], angular.noop);</div><div class="line"></div><div class="line">app.directive(<span class="string">'a'</span>, <span class="function"><span class="keyword">function</span><span class="params">()</span></span>{</div><div class="line">  <span class="keyword">var</span> func = <span class="function"><span class="keyword">function</span><span class="params">(element, attrs, link)</span></span>{</div><div class="line">    <span class="keyword">return</span> <span class="function"><span class="keyword">function</span><span class="params">(scope)</span></span>{</div><div class="line">      console.log(scope);</div><div class="line">    }</div><div class="line">  }</div><div class="line"></div><div class="line">  <span class="keyword">return</span> {compile: func,</div><div class="line">          scope: {a: <span class="string">'=abc'</span>},</div><div class="line">          restrict: <span class="string">'A'</span>};</div><div class="line">});</div><div class="line"></div><div class="line">app.controller(<span class="string">'TestCtrl'</span>, <span class="function"><span class="keyword">function</span><span class="params">(<span class="variable">$scope</span>)</span></span>{</div><div class="line">  <span class="variable">$scope</span>.here = <span class="string">'123'</span>;</div><div class="line">});</div></pre></td></tr></table></figure>

<p>&amp;attr 是包装一个函数出来，这个函数以节点所在的 scope 为上下文。来看一个很爽的例子：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line">&lt;div ng-controller=<span class="string">"TestCtrl"</span>&gt;</div><div class="line">  &lt;div a abc=<span class="string">"here = here + 1"</span> ng-click=<span class="string">"show(here)"</span>&gt;这里&lt;/div&gt;</div><div class="line">  &lt;div&gt;\{\{ <span class="keyword">here</span> }}&lt;/div&gt;</div><div class="line">&lt;/div&gt;</div><div class="line"> <span class="keyword">var</span> app = angular.module(<span class="string">'Demo'</span>, [], angular.noop);</div><div class="line"> </div><div class="line"> app.directive(<span class="string">'a'</span>, <span class="function"><span class="keyword">function</span><span class="params">()</span></span>{</div><div class="line">   <span class="keyword">var</span> func = <span class="function"><span class="keyword">function</span><span class="params">(element, attrs, link)</span></span>{</div><div class="line">     <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> <span class="title">llink</span><span class="params">(scope)</span></span>{</div><div class="line">       console.log(scope);</div><div class="line">       scope.a();</div><div class="line">       scope.b();</div><div class="line"> </div><div class="line">       scope.show = <span class="function"><span class="keyword">function</span><span class="params">(here)</span></span>{</div><div class="line">         console.log(<span class="string">'Inner, '</span> + <span class="keyword">here</span>);</div><div class="line">         scope.a({<span class="keyword">here</span>: <span class="number">5</span>});</div><div class="line">       }</div><div class="line">     }</div><div class="line">   }</div><div class="line"> </div><div class="line">   <span class="keyword">return</span> {compile: func,</div><div class="line">           scope: {a: <span class="string">'&abc'</span>, b: <span class="string">'&ngClick'</span>},</div><div class="line">           restrict: <span class="string">'A'</span>};</div><div class="line"> });</div><div class="line"> </div><div class="line"> app.controller(<span class="string">'TestCtrl'</span>, <span class="function"><span class="keyword">function</span><span class="params">($scope)</span></span>{</div><div class="line">   $scope.<span class="keyword">here</span> = <span class="number">123</span>;</div><div class="line">   console.log($scope);</div><div class="line"></div><div class="line">   $scope.show = <span class="function"><span class="keyword">function</span><span class="params">(here)</span></span>{</div><div class="line">     console.log(<span class="keyword">here</span>);</div><div class="line">   }</div><div class="line"> });</div></pre></td></tr></table></figure>

<p>scope.a 是 &amp;abc ，即：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">scope.a = <span class="function"><span class="keyword">function</span><span class="params">()</span></span>{<span class="keyword">here</span> = <span class="keyword">here</span> + <span class="number">1</span>}</div></pre></td></tr></table></figure>

<p>只是其中的 here 是 TestCtrl 的。</p>
<p>scope.b 是 &amp;ngClick ，即：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">scope.b = <span class="function"><span class="keyword">function</span><span class="params">()</span></span>{show(<span class="keyword">here</span>)}</div></pre></td></tr></table></figure>

<p>这里的 show() 和 here 都是 TestCtrl 的，于是上面的代码最开始会在终端输出一个 124 。</p>
<p>当点击“这里”时，这时执行的 show(here) 就是 llink 中定义的那个函数了，与 TestCtrl 无关。但是，其间的 scope.a({here:5}) ，因为 a 执行时是 TestCtrl 的上下文，于是向 a 传递的一个对象，里面的所有属性 TestCtrl 就全收下了，接着执行 here=here+1 ，于是我们会在屏幕上看到 6 。</p>
<p>这里是一个上下文交错的环境，通过 \&amp; 这种机制，让指令的 scope 与节点的 scope 发生了互动。真是鬼斧神工的设计。而实现它，只用了几行代码：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">case</span> <span class="string">'&'</span>: {</div><div class="line">  parentGet = <span class="variable">$parse</span>(attrs[attrName]);</div><div class="line">  scope[scopeName] = <span class="function"><span class="keyword">function</span><span class="params">(locals)</span> </span>{</div><div class="line">    <span class="keyword">return</span> parentGet(parentScope, locals);</div><div class="line">  }</div><div class="line">  <span class="keyword">break</span>;</div><div class="line">}</div></pre></td></tr></table></figure>

<p>再看 controller 这个参数。这个参数的作用是提供一个 controller 的构造函数，它会在 compile 函数之后， link 函数之前被执行。</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line">&lt;a&gt;haha&lt;/a&gt;</div><div class="line"> <span class="keyword">var</span> app = angular.module(<span class="string">'Demo'</span>, [], angular.noop);</div><div class="line"> </div><div class="line"> app.directive(<span class="string">'a'</span>, <span class="function"><span class="keyword">function</span><span class="params">()</span></span>{</div><div class="line">   <span class="keyword">var</span> func = <span class="function"><span class="keyword">function</span><span class="params">()</span></span>{</div><div class="line">     console.log(<span class="string">'compile'</span>);</div><div class="line">     <span class="keyword">return</span> <span class="function"><span class="keyword">function</span><span class="params">()</span></span>{</div><div class="line">       console.log(<span class="string">'link'</span>);</div><div class="line">     }</div><div class="line">   }</div><div class="line"> </div><div class="line">   <span class="keyword">var</span> controller = <span class="function"><span class="keyword">function</span><span class="params">(<span class="variable">$scope</span>, <span class="variable">$element</span>, <span class="variable">$attrs</span>, <span class="variable">$transclude</span>)</span></span>{</div><div class="line">     console.log(<span class="string">'controller'</span>);</div><div class="line">     console.log(<span class="variable">$scope</span>);</div><div class="line"> </div><div class="line">     <span class="keyword">var</span> node = <span class="variable">$transclude</span>(<span class="function"><span class="keyword">function</span><span class="params">(clone_element, scope)</span></span>{</div><div class="line">       console.log(clone_element);</div><div class="line">       console.log(<span class="string">'--'</span>);</div><div class="line">       console.log(scope);</div><div class="line">     });</div><div class="line">     console.log(node);</div><div class="line">   }</div><div class="line"> </div><div class="line">   <span class="keyword">return</span> {compile: func,</div><div class="line">           controller: controller,</div><div class="line">           transclude: <span class="keyword">true</span>,</div><div class="line">           restrict: <span class="string">'E'</span>}</div><div class="line"> });</div></pre></td></tr></table></figure>

<p>controller 的最后一个参数， \$transclude ，是一个只接受 cloneAttachFn 作为参数的一个函数。</p>
<p>按官方的说法，这个机制的设计目的是为了让各个指令之间可以互相通信。参考普通节点的处理方式，这里也是处理指令 scope 的合适位置。</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line"> &lt;a b&gt;kk&lt;/a&gt;</div><div class="line">  <span class="keyword">var</span> app = angular.module(<span class="string">'Demo'</span>, [], angular.noop);</div><div class="line">  </div><div class="line">  app.directive(<span class="string">'a'</span>, <span class="function"><span class="keyword">function</span><span class="params">()</span></span>{</div><div class="line">    <span class="keyword">var</span> func = <span class="function"><span class="keyword">function</span><span class="params">()</span></span>{</div><div class="line">    }</div><div class="line">  </div><div class="line">    <span class="keyword">var</span> controller = <span class="function"><span class="keyword">function</span><span class="params">(<span class="variable">$scope</span>, <span class="variable">$element</span>, <span class="variable">$attrs</span>, <span class="variable">$transclude</span>)</span></span>{</div><div class="line">      console.log(<span class="string">'a'</span>);</div><div class="line">      this.a = <span class="string">'xx'</span>;</div><div class="line">    }</div><div class="line">  </div><div class="line">    <span class="keyword">return</span> {compile: func,</div><div class="line">          name: <span class="string">'not_a'</span>,</div><div class="line">           controller: controller,</div><div class="line">            restrict: <span class="string">'E'</span>}</div><div class="line">  });</div><div class="line">  </div><div class="line">app.directive(<span class="string">'b'</span>, <span class="function"><span class="keyword">function</span><span class="params">()</span></span>{</div><div class="line">    <span class="keyword">var</span> func = <span class="function"><span class="keyword">function</span><span class="params">()</span></span>{</div><div class="line">      <span class="keyword">return</span> <span class="function"><span class="keyword">function</span><span class="params">(<span class="variable">$scope</span>, <span class="variable">$element</span>, <span class="variable">$attrs</span>, <span class="variable">$controller</span>)</span></span>{</div><div class="line">        console.log(<span class="variable">$controller</span>);</div><div class="line">      }</div><div class="line">    }</div><div class="line">  </div><div class="line">    <span class="keyword">var</span> controller = <span class="function"><span class="keyword">function</span><span class="params">(<span class="variable">$scope</span>, <span class="variable">$element</span>, <span class="variable">$attrs</span>, <span class="variable">$transclude</span>)</span></span>{</div><div class="line">      console.log(<span class="string">'b'</span>);</div><div class="line">    }</div><div class="line">  </div><div class="line">    <span class="keyword">return</span> {compile: func,</div><div class="line">            controller: controller,</div><div class="line">           <span class="keyword">require</span>: <span class="string">'not_a'</span>,</div><div class="line">           restrict: <span class="string">'EA'</span>}</div><div class="line">  });</div></pre></td></tr></table></figure>

<p>name 参数在这里可以用以为 controller 重起一个名字，以方便在 require 参数中引用。</p>
<p>require 参数可以带两种前缀（可以同时使用）：</p>
<ol>
<li>\? ，如果指定的 controller 不存在，则忽略错误。即：</li>
</ol>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">require</span>: <span class="string">'?not_b'</span></div></pre></td></tr></table></figure>

<p>如果名为 not_b 的 controller 不存在时，不会直接抛出错误， link 函数中对应的 $controller 为 undefined 。</p>
<ol>
<li>\^ ，同时在父级节点中寻找指定的 controller ，把上面的例子小改一下：</li>
</ol>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="title">a</span>&gt;</span><span class="tag">&lt;<span class="title">b</span>&gt;</span>kk<span class="tag">&lt;/<span class="title">b</span>&gt;</span><span class="tag">&lt;/<span class="title">a</span>&gt;</span></div></pre></td></tr></table></figure>

<p>把 a 的 require 改成（否则就找不到 not_a 这个 controller ）：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">require</span>: <span class="string">'?^not_a'</span></div></pre></td></tr></table></figure>

<p>还剩下几个模板参数：</p>
<p><em>template</em> 模板内容，这个内容会根据 replace 参数的设置替换节点或只替换节点内容。<br><em>templateUrl</em> 模板内容，获取方式是异步请求。<br><em>replace</em> 设置如何处理模板内容。为 true 时为替换掉指令节点，否则只替换到节点内容。</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line">&lt;div ng-controller=<span class="string">"TestCtrl"</span>&gt;</div><div class="line">  &lt;h1 a&gt;原始内容&lt;/h1&gt;</div><div class="line">&lt;/div&gt;</div><div class="line"><span class="keyword">var</span> app = angular.module(<span class="string">'Demo'</span>, [], angular.noop);</div><div class="line"></div><div class="line">app.directive(<span class="string">'a'</span>, <span class="function"><span class="keyword">function</span><span class="params">()</span></span>{</div><div class="line">  <span class="keyword">var</span> func = <span class="function"><span class="keyword">function</span><span class="params">()</span></span>{</div><div class="line">  }</div><div class="line"></div><div class="line">  <span class="keyword">return</span> {compile: func,</div><div class="line">          template: <span class="string">'&lt;p&gt;标题 \{\{ name }} &lt;button ng-click="name=\'hahaha\'"&gt;修改&lt;/button&gt;&lt;/p&gt;'</span>,</div><div class="line">          <span class="comment">//replace: true,</span></div><div class="line">          <span class="comment">//controller: function($scope){$scope.name = 'xxx'},</span></div><div class="line">          <span class="comment">//scope: {},</span></div><div class="line">          scope: <span class="keyword">true</span> ,</div><div class="line">          controller: <span class="function"><span class="keyword">function</span><span class="params">(<span class="variable">$scope</span>)</span></span>{console.log(<span class="variable">$scope</span>)},</div><div class="line">          restrict: <span class="string">'A'</span>}</div><div class="line">});</div><div class="line"></div><div class="line">app.controller(<span class="string">'TestCtrl'</span>, <span class="function"><span class="keyword">function</span><span class="params">(<span class="variable">$scope</span>)</span></span>{</div><div class="line">  <span class="variable">$scope</span>.name = <span class="string">'123'</span>;</div><div class="line">  console.log(<span class="variable">$scope</span>);</div><div class="line">});</div></pre></td></tr></table></figure>

<p>template 中可以包括变量引用的表达式，其 scope 遵寻 scope 参数的作用（可能受继承关系影响）。</p>
<p>templateUrl 是异步请求模板内容，并且是获取到内容之后才开始执行指令的 compile 函数。</p>
<p>最后说一个 compile 这个参数。它除了可以返回一个函数用为 link 函数之外，还可以返回一个对象，这个对象能包括两个成员，一个 pre ，一个 post 。实际上， link 函数是由两部分组成，所谓的 preLink 和 postLink 。区别在于执行顺序，特别是在指令层级嵌套的结构之下， postLink 是在所有的子级指令 link 完成之后才最后执行的。 compile 如果只返回一个函数，则这个函数被作为 postLink 使用：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line">&lt;a&gt;&lt;b&gt;&lt;/b&gt;&lt;/a&gt;</div><div class="line"> <span class="keyword">var</span> app = angular.module(<span class="string">'Demo'</span>, [], angular.noop);</div><div class="line"> </div><div class="line"> app.directive(<span class="string">'a'</span>, <span class="function"><span class="keyword">function</span><span class="params">()</span></span>{</div><div class="line">   <span class="keyword">var</span> func = <span class="function"><span class="keyword">function</span><span class="params">()</span></span>{</div><div class="line">     console.log(<span class="string">'a compile'</span>);</div><div class="line">     <span class="keyword">return</span> {</div><div class="line">       pre: <span class="function"><span class="keyword">function</span><span class="params">()</span></span>{console.log(<span class="string">'a link pre'</span>)},</div><div class="line">       post: <span class="function"><span class="keyword">function</span><span class="params">()</span></span>{console.log(<span class="string">'a link post'</span>)},</div><div class="line">     }</div><div class="line">   }</div><div class="line"> </div><div class="line">   <span class="keyword">return</span> {compile: func,</div><div class="line">           restrict: <span class="string">'E'</span>}</div><div class="line"> });</div><div class="line"> </div><div class="line"> app.directive(<span class="string">'b'</span>, <span class="function"><span class="keyword">function</span><span class="params">()</span></span>{</div><div class="line">   <span class="keyword">var</span> func = <span class="function"><span class="keyword">function</span><span class="params">()</span></span>{</div><div class="line">     console.log(<span class="string">'b compile'</span>);</div><div class="line">     <span class="keyword">return</span> {</div><div class="line">       pre: <span class="function"><span class="keyword">function</span><span class="params">()</span></span>{console.log(<span class="string">'b link pre'</span>)},</div><div class="line">       post: <span class="function"><span class="keyword">function</span><span class="params">()</span></span>{console.log(<span class="string">'b link post'</span>)},</div><div class="line">     }</div><div class="line">   }</div><div class="line"> </div><div class="line">   <span class="keyword">return</span> {compile: func,</div><div class="line">           restrict: <span class="string">'E'</span>}</div><div class="line"> });</div></pre></td></tr></table></figure>

<h4 id="Attributes的细节">Attributes的细节</h4>
<p>节点属性被包装之后会传给 compile 和 link 函数。从这个操作中，我们可以得到节点的引用，可以操作节点属性，也可以为节点属性注册侦听事件。</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">&lt;test a=<span class="string">"1"</span> b c=<span class="string">"xxx"</span>&gt;&lt;/test&gt;</div><div class="line"><span class="keyword">var</span> app = angular.module(<span class="string">'Demo'</span>, [], angular.noop);</div><div class="line"></div><div class="line">app.directive(<span class="string">'test'</span>, <span class="function"><span class="keyword">function</span><span class="params">()</span></span>{</div><div class="line">  <span class="keyword">var</span> func = <span class="function"><span class="keyword">function</span><span class="params">(<span class="variable">$element</span>, <span class="variable">$attrs</span>)</span></span>{</div><div class="line">    console.log(<span class="variable">$attrs</span>);</div><div class="line">  }</div><div class="line"></div><div class="line">  <span class="keyword">return</span> {compile: func,</div><div class="line">          restrict: <span class="string">'E'</span>}</div></pre></td></tr></table></figure>

<p>整个 Attributes 对象是比较简单的，它的成员包括了：</p>
<ol>
<li>\$\$element 属性所在的节点。</li>
<li>\$attr 所有的属性值（类型是对象）。</li>
<li>\$normalize 一个名字标准化的工具函数，可以把 ng-click 变成 ngClick 。</li>
<li>\$observe 为属性注册侦听器的函数。</li>
<li>\$set 设置对象属性，及节点属性的工具。</li>
</ol>
<p>除了上面这些成员，对象的成员还包括所有属性的名字。</p>
<p>先看 \$observe 的使用，基本上相当于 \$scope 中的 \$watch ：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line">&lt;div ng-controller=<span class="string">"TestCtrl"</span>&gt;</div><div class="line">  &lt;test a=<span class="string">"\{\{ a }}"</span> b c=<span class="string">"xxx"</span>&gt;&lt;/test&gt;</div><div class="line">  &lt;button ng-click=<span class="string">"a=a+1"</span>&gt;修改&lt;/button&gt;</div><div class="line">&lt;/div&gt;</div><div class="line"><span class="keyword">var</span> app = angular.module(<span class="string">'Demo'</span>, [], angular.noop);</div><div class="line"></div><div class="line">app.directive(<span class="string">'test'</span>, <span class="function"><span class="keyword">function</span><span class="params">()</span></span>{</div><div class="line">  <span class="keyword">var</span> func = <span class="function"><span class="keyword">function</span><span class="params">(<span class="variable">$element</span>, <span class="variable">$attrs</span>)</span></span>{</div><div class="line">    console.log(<span class="variable">$attrs</span>);</div><div class="line"></div><div class="line">    <span class="variable">$attrs</span>.<span class="variable">$observe</span>(<span class="string">'a'</span>, <span class="function"><span class="keyword">function</span><span class="params">(new_v)</span></span>{</div><div class="line">      console.log(new_v);</div><div class="line">    });</div><div class="line">  }</div><div class="line"></div><div class="line">  <span class="keyword">return</span> {compile: func,</div><div class="line">          restrict: <span class="string">'E'</span>}</div><div class="line">});</div><div class="line"></div><div class="line">app.controller(<span class="string">'TestCtrl'</span>, <span class="function"><span class="keyword">function</span><span class="params">(<span class="variable">$scope</span>)</span></span>{</div><div class="line">  <span class="variable">$scope</span>.a = <span class="number">123</span>;</div><div class="line">});</div></pre></td></tr></table></figure>

<p>\$set 方法的定义是： function(key, value, writeAttr, attrName) { … } 。</p>
<ol>
<li>key 对象的成员名。</li>
<li>value 需要设置的值。</li>
<li>writeAttr 是否同时修改 DOM 节点的属性（注意区别“节点”与“对象”），默认为 true 。</li>
<li>attrName 实际的属性名，与“标准化”之后的属性名有区别。</li>
</ol>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">&lt;div ng-controller=<span class="string">"TestCtrl"</span>&gt;</div><div class="line">  &lt;test a=<span class="string">"1"</span> ys-a=<span class="string">"123"</span> ng-click=<span class="string">"show(1)"</span>&gt;这里&lt;/test&gt;</div><div class="line">&lt;/div&gt;</div><div class="line"><span class="keyword">var</span> app = angular.module(<span class="string">'Demo'</span>, [], angular.noop);</div><div class="line"></div><div class="line">app.directive(<span class="string">'test'</span>, <span class="function"><span class="keyword">function</span><span class="params">()</span></span>{</div><div class="line">  <span class="keyword">var</span> func = <span class="function"><span class="keyword">function</span><span class="params">(<span class="variable">$element</span>, <span class="variable">$attrs</span>)</span></span>{</div><div class="line">    <span class="variable">$attrs</span>.<span class="variable">$set</span>(<span class="string">'b'</span>, <span class="string">'ooo'</span>);</div><div class="line">    <span class="variable">$attrs</span>.<span class="variable">$set</span>(<span class="string">'a-b'</span>, <span class="string">'11'</span>);</div><div class="line">    <span class="variable">$attrs</span>.<span class="variable">$set</span>(<span class="string">'c-d'</span>, <span class="string">'11'</span>, <span class="keyword">true</span>, <span class="string">'c_d'</span>);</div><div class="line">    console.log(<span class="variable">$attrs</span>);</div><div class="line">  }</div><div class="line"></div><div class="line">  <span class="keyword">return</span> {compile: func,</div><div class="line">          restrict: <span class="string">'E'</span>}</div><div class="line">});</div><div class="line"></div><div class="line">app.controller(<span class="string">'TestCtrl'</span>, <span class="function"><span class="keyword">function</span><span class="params">(<span class="variable">$scope</span>)</span></span>{</div><div class="line">  <span class="variable">$scope</span>.show = <span class="function"><span class="keyword">function</span><span class="params">(v)</span></span>{console.log(v);}</div><div class="line">});</div></pre></td></tr></table></figure>

<p>从例子中可以看到，原始的节点属性值对，放到对象中之后，名字一定是“标准化”之后的。但是手动 \$set 的新属性，不会自动做标准化处理。</p>
<h4 id="预定义的_NgModelController">预定义的 NgModelController</h4>
<p>在前面讲 conroller 参数的时候，提到过可以为指令定义一个 conroller 。官方的实现中，有很多已定义的指令，这些指令当中，有两个已定义的 conroller ，它们是 NgModelController 和 FormController ，对应 ng-model 和 form 这两个指令（可以参照前面的“表单控件”一章）。</p>
<p>在使用中，除了可以通过 \$scope 来取得它们的引用之外，也可以在自定义指令中通过 require 参数直接引用，这样就可以在 link 函数中使用 controller 去实现一些功能。</p>
<p>先看 NgModelController 。这东西的作用有两个，一是控制 ViewValue 与 ModelValue 之间的转换关系（你可以实现看到的是一个值，但是存到变量里变成了另外一个值），二是与 FormController 配合做数据校验的相关逻辑。</p>
<p>先看两个应该是最有用的属性：</p>
<p><em>\$formatters</em> 是一个由函数组成的列表，串行执行，作用是把变量值变成显示的值。<br><em>\$parsers</em> 与上面的方向相反，把显示的值变成变量值。<br>假设我们在变量中要保存一个列表的类型，但是显示的东西只能是字符串，所以这两者之间需要一个转换：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line">&lt;div ng-controller=<span class="string">"TestCtrl"</span>&gt;</div><div class="line">    &lt;input type=<span class="string">"text"</span> ng-model=<span class="string">"a"</span> test /&gt;</div><div class="line">    &lt;button ng-click=<span class="string">"show(a)"</span>&gt;查看&lt;/button&gt;</div><div class="line">  &lt;/div&gt;</div><div class="line">   <span class="keyword">var</span> app = angular.module(<span class="string">'Demo'</span>, [], angular.noop);</div><div class="line">   </div><div class="line">   app.directive(<span class="string">'test'</span>, <span class="function"><span class="keyword">function</span><span class="params">()</span></span>{</div><div class="line">     <span class="keyword">var</span> link = <span class="function"><span class="keyword">function</span><span class="params">(<span class="variable">$scope</span>, <span class="variable">$element</span>, <span class="variable">$attrs</span>, <span class="variable">$ctrl</span>)</span></span>{</div><div class="line">   </div><div class="line">       <span class="variable">$ctrl</span>.<span class="variable">$formatters</span>.push(<span class="function"><span class="keyword">function</span><span class="params">(value)</span></span>{</div><div class="line">         <span class="keyword">return</span> value.join(<span class="string">','</span>);</div><div class="line">       });</div><div class="line">   </div><div class="line">       <span class="variable">$ctrl</span>.<span class="variable">$parsers</span>.push(<span class="function"><span class="keyword">function</span><span class="params">(value)</span></span>{</div><div class="line">         <span class="keyword">return</span> value.split(<span class="string">','</span>);</div><div class="line">       });</div><div class="line">     }</div><div class="line">   </div><div class="line">     <span class="keyword">return</span> {compile: <span class="function"><span class="keyword">function</span><span class="params">()</span></span>{<span class="keyword">return</span> link},</div><div class="line">             <span class="keyword">require</span>: <span class="string">'ngModel'</span>,</div><div class="line">             restrict: <span class="string">'A'</span>}</div><div class="line">   });</div><div class="line">   </div><div class="line">   app.controller(<span class="string">'TestCtrl'</span>, <span class="function"><span class="keyword">function</span><span class="params">(<span class="variable">$scope</span>)</span></span>{</div><div class="line">     <span class="variable">$scope</span>.a = [];</div><div class="line">     <span class="comment">//$scope.a = [1,2,3];</span></div><div class="line">     <span class="variable">$scope</span>.show = <span class="function"><span class="keyword">function</span><span class="params">(v)</span></span>{</div><div class="line">       console.log(v);</div><div class="line">     }</div><div class="line">   });</div></pre></td></tr></table></figure>

<p>上面在定义 test 这个指令， require 参数指定了 ngModel 。同时因为 DOM 结构， ng-model 是存在的。于是， link 函数中就可以获取到一个 NgModelController 的实例，即代码中的 \$ctrl 。</p>
<p>我们添加了需要的过滤函数：</p>
<ol>
<li>从变量( ModelValue )到显示值( ViewValue )的过程， \$formatters 属性，把一个列表变成一个字符串。</li>
<li>从显示值到变量的过程， \$parsers 属性，把一个字符串变成一个列表。<br>对于显示值和变量，还有其它的 API ，这里就不细说了。</li>
</ol>
<p>另一部分，是关于数据校验的，放到下一章同 FormController 一起讨论。</p>
<h4 id="预定义的_FormController">预定义的 FormController</h4>
<p>前面的“表单控制”那章，实际上讲的就是 FormController ，只是那里是从 scope 中获取到的引用。现在从指令定义的角度，来更清楚地了解 FormController 及 NgModelController 是如何配合工作的。</p>
<p>先说一下， form 和 ngForm 是官方定义的两个指令，但是它们其实是同一个东西。前者只允许以标签形式使用，而后者允许 EAC 的形式。DOM 结构中， form 标签不能嵌套，但是 ng 的指令没有这个限制。不管是 form 还是 ngForm ，它们的 controller 都被命名成了 form 。 所以 require 这个参数不要写错了。</p>
<p>FormController 的几个成员是很好理解的：</p>
<ol>
<li>\$pristine 表单是否被动过</li>
<li>\$dirty 表单是否没被动过</li>
<li>\$valid 表单是否检验通过</li>
<li>\$invalid 表单是否检验未通过</li>
<li>\$error 表单中的错误</li>
<li>\$setDirty() 直接设置 $dirty 及 $pristine</li>
</ol>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line">&lt;div ng-controller=<span class="string">"TestCtrl"</span>&gt;</div><div class="line">    &lt;div ng-form test&gt;</div><div class="line">      &lt;input ng-model=<span class="string">"a"</span> type=<span class="string">"email"</span> /&gt;</div><div class="line">      &lt;button ng-click=<span class="string">"do()"</span>&gt;查看&lt;/button&gt;</div><div class="line">    &lt;/div&gt;</div><div class="line">  &lt;/div&gt;</div><div class="line">  <span class="keyword">var</span> app = angular.module(<span class="string">'Demo'</span>, [], angular.noop);</div><div class="line">  </div><div class="line">  app.directive(<span class="string">'test'</span>, <span class="function"><span class="keyword">function</span><span class="params">()</span></span>{</div><div class="line">    <span class="keyword">var</span> link = <span class="function"><span class="keyword">function</span><span class="params">(<span class="variable">$scope</span>, <span class="variable">$element</span>, <span class="variable">$attrs</span>, <span class="variable">$ctrl</span>)</span></span>{</div><div class="line">      <span class="variable">$scope</span>.<span class="keyword">do</span> = <span class="function"><span class="keyword">function</span><span class="params">()</span></span>{</div><div class="line">        <span class="comment">//$ctrl.$setDirty();</span></div><div class="line">        console.log(<span class="variable">$ctrl</span>.<span class="variable">$pristine</span>); <span class="comment">//form是否没被动过</span></div><div class="line">        console.log(<span class="variable">$ctrl</span>.<span class="variable">$dirty</span>); <span class="comment">//form是否被动过</span></div><div class="line">        console.log(<span class="variable">$ctrl</span>.<span class="variable">$valid</span>); <span class="comment">//form是否被检验通过</span></div><div class="line">        console.log(<span class="variable">$ctrl</span>.<span class="variable">$invalid</span>); <span class="comment">//form是否有错误</span></div><div class="line">        console.log(<span class="variable">$ctrl</span>.<span class="variable">$error</span>); <span class="comment">//form中有错误的字段</span></div><div class="line">      }</div><div class="line">    }</div><div class="line">  </div><div class="line">    <span class="keyword">return</span> {compile: <span class="function"><span class="keyword">function</span><span class="params">()</span></span>{<span class="keyword">return</span> link},</div><div class="line">            <span class="keyword">require</span>: <span class="string">'form'</span>,</div><div class="line">            restrict: <span class="string">'A'</span>}</div><div class="line">  });</div><div class="line">  </div><div class="line">  app.controller(<span class="string">'TestCtrl'</span>, <span class="function"><span class="keyword">function</span><span class="params">(<span class="variable">$scope</span>)</span></span>{</div><div class="line">  });</div></pre></td></tr></table></figure>

<p>\$error 这个属性，是一个对象， key 是错误名， value 部分是一个列表，其成员是对应的 NgModelController 的实例。</p>
<p>FormController 可以自由增减它包含的那些，类似于 NgModelController 的实例。在 DOM 结构上，有 ng-model 的 input 节点的 NgMoelController 会被自动添加。</p>
<ol>
<li>\$addControl() 添加一个 conroller</li>
<li>\$removeControl() 删除一个 controller<br>这两个手动使用机会应该不会很多。被添加的实例也可以手动实现所有的 NgModelController 的方法</li>
</ol>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div></pre></td><td class="code"><pre><div class="line">&lt;div ng-controller=<span class="string">"TestCtrl"</span>&gt;</div><div class="line">    &lt;bb /&gt;</div><div class="line">    &lt;div ng-form test&gt;</div><div class="line">      &lt;input ng-model=<span class="string">"a"</span> type=<span class="string">"email"</span> /&gt;</div><div class="line">      &lt;button ng-click=<span class="string">"add()"</span>&gt;添加&lt;/button&gt;</div><div class="line">    &lt;/div&gt;</div><div class="line">  &lt;/div&gt;</div><div class="line">   <span class="keyword">var</span> app = angular.module(<span class="string">'Demo'</span>, [], angular.noop);</div><div class="line">   </div><div class="line">   app.directive(<span class="string">'test'</span>, <span class="function"><span class="keyword">function</span><span class="params">()</span></span>{</div><div class="line">     <span class="keyword">var</span> link = <span class="function"><span class="keyword">function</span><span class="params">(<span class="variable">$scope</span>, <span class="variable">$element</span>, <span class="variable">$attrs</span>, <span class="variable">$ctrl</span>)</span></span>{</div><div class="line">       <span class="variable">$scope</span>.add = <span class="function"><span class="keyword">function</span><span class="params">()</span></span>{</div><div class="line">         <span class="variable">$ctrl</span>.<span class="variable">$addControl</span>(<span class="variable">$scope</span>.bb);</div><div class="line">         console.log(<span class="variable">$ctrl</span>);</div><div class="line">       }</div><div class="line">     }</div><div class="line">   </div><div class="line">     <span class="keyword">return</span> {compile: <span class="function"><span class="keyword">function</span><span class="params">()</span></span>{<span class="keyword">return</span> link},</div><div class="line">             <span class="keyword">require</span>: <span class="string">'form'</span>,</div><div class="line">             restrict: <span class="string">'A'</span>}</div><div class="line">   });</div><div class="line">   </div><div class="line">   app.directive(<span class="string">'bb'</span>, <span class="function"><span class="keyword">function</span><span class="params">()</span></span>{</div><div class="line">     <span class="keyword">var</span> controller = <span class="function"><span class="keyword">function</span><span class="params">(<span class="variable">$scope</span>, <span class="variable">$element</span>, <span class="variable">$attrs</span>, <span class="variable">$transclude</span>)</span></span>{</div><div class="line">       <span class="variable">$scope</span>.bb = this;</div><div class="line">       this.<span class="variable">$name</span> = <span class="string">'bb'</span>;</div><div class="line">     }</div><div class="line">   </div><div class="line">     <span class="keyword">return</span> {compile: angular.noop,</div><div class="line">             restrict: <span class="string">'E'</span>,</div><div class="line">             controller: controller}</div><div class="line">   });</div><div class="line">   </div><div class="line">   app.controller(<span class="string">'TestCtrl'</span>, <span class="function"><span class="keyword">function</span><span class="params">(<span class="variable">$scope</span>)</span></span>{</div><div class="line">   });</div></pre></td></tr></table></figure>

<p>整合 FormController 和 NgModelController 就很容易扩展各种类型的字段:</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div></pre></td><td class="code"><pre><div class="line">&lt;div ng-controller=<span class="string">"TestCtrl"</span>&gt;</div><div class="line">   &lt;form name=<span class="string">"f"</span>&gt;</div><div class="line">     &lt;input type=<span class="string">"my"</span> ng-model=<span class="string">"a"</span> /&gt;</div><div class="line">     &lt;button ng-click=<span class="string">"show()"</span>&gt;查看&lt;/button&gt;</div><div class="line">   &lt;/form&gt;</div><div class="line"> &lt;/div&gt;</div><div class="line">  <span class="keyword">var</span> app = angular.module(<span class="string">'Demo'</span>, [], angular.noop);</div><div class="line">  </div><div class="line">  app.directive(<span class="string">'input'</span>, <span class="function"><span class="keyword">function</span><span class="params">()</span></span>{</div><div class="line">    <span class="keyword">var</span> link = <span class="function"><span class="keyword">function</span><span class="params">(<span class="variable">$scope</span>, <span class="variable">$element</span>, <span class="variable">$attrs</span>, <span class="variable">$ctrl</span>)</span></span>{</div><div class="line">      console.log(<span class="variable">$attrs</span>.type);</div><div class="line">      <span class="keyword">var</span> validator = <span class="function"><span class="keyword">function</span><span class="params">(v)</span></span>{</div><div class="line">        <span class="keyword">if</span>(v == <span class="string">'123'</span>){</div><div class="line">          <span class="variable">$ctrl</span>.<span class="variable">$setValidity</span>(<span class="string">'my'</span>, <span class="keyword">true</span>);</div><div class="line">          <span class="keyword">return</span> v;</div><div class="line">        } <span class="keyword">else</span> {</div><div class="line">          <span class="variable">$ctrl</span>.<span class="variable">$setValidity</span>(<span class="string">'my'</span>, <span class="keyword">false</span>);</div><div class="line">          <span class="keyword">return</span> undefined;</div><div class="line">        }</div><div class="line">      }</div><div class="line">  </div><div class="line">      <span class="variable">$ctrl</span>.<span class="variable">$formatters</span>.push(validator);</div><div class="line">      <span class="variable">$ctrl</span>.<span class="variable">$parsers</span>.push(validator);</div><div class="line">    }</div><div class="line">  </div><div class="line">    <span class="keyword">return</span> {compile: <span class="function"><span class="keyword">function</span><span class="params">()</span></span>{<span class="keyword">return</span> link},</div><div class="line">            <span class="keyword">require</span>: <span class="string">'ngModel'</span>,</div><div class="line">            restrict: <span class="string">'E'</span>}</div><div class="line">  });</div><div class="line">  </div><div class="line">  app.controller(<span class="string">'TestCtrl'</span>, <span class="function"><span class="keyword">function</span><span class="params">(<span class="variable">$scope</span>)</span></span>{</div><div class="line">      <span class="variable">$scope</span>.show = <span class="function"><span class="keyword">function</span><span class="params">()</span></span>{</div><div class="line">        console.log(<span class="variable">$scope</span>.f);</div><div class="line">      }</div><div class="line">  });</div></pre></td></tr></table></figure>

<p>虽然官方原来定义了几种 type ，但这不妨碍我们继续扩展新的类型。如果新的 type 参数值不在官方的定义列表里，那会按 text 类型先做处理，这其实什么影响都没有。剩下的，就是写我们自己的验证逻辑就行了。</p>
<p>上面的代码是参见官方的做法，使用格式化的过程，同时在里面做有效性检查。</p>
<h4 id="示例：文本框">示例：文本框</h4>
<p>这个例子与官网上的那个例子相似。最终是要显示一个文本框，这个文本框由标题和内容两部分组成。而且标题和内容则是引用 controller 中的变量值。</p>
<p>HTML 部分的代码：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="title">div</span> <span class="attribute">ng-controller</span>=<span class="value">"TestCtrl"</span>&gt;</span></div><div class="line">   <span class="tag">&lt;<span class="title">ys-block</span> <span class="attribute">title</span>=<span class="value">"title"</span> <span class="attribute">text</span>=<span class="value">"text"</span>&gt;</span><span class="tag">&lt;/<span class="title">ys-block</span>&gt;</span></div><div class="line">   <span class="tag">&lt;<span class="title">p</span>&gt;</span>标题: <span class="tag">&lt;<span class="title">input</span> <span class="attribute">ng-model</span>=<span class="value">"title"</span> /&gt;</span><span class="tag">&lt;/<span class="title">p</span>&gt;</span></div><div class="line">   <span class="tag">&lt;<span class="title">p</span>&gt;</span>内容: <span class="tag">&lt;<span class="title">input</span> <span class="attribute">ng-model</span>=<span class="value">"text"</span> /&gt;</span><span class="tag">&lt;/<span class="title">p</span>&gt;</span></div><div class="line">   <span class="tag">&lt;<span class="title">ys-block</span> <span class="attribute">title</span>=<span class="value">"title"</span> <span class="attribute">text</span>=<span class="value">"text"</span>&gt;</span><span class="tag">&lt;/<span class="title">ys-block</span>&gt;</span></div><div class="line"> <span class="tag">&lt;/<span class="title">div</span>&gt;</span></div></pre></td></tr></table></figure>

<p>从这个期望实现效果的 HTML 代码中，我们可以考虑设计指令的实现方式：</p>
<ol>
<li>这个指令的使用方式是“标签”， 即 restrict 这个参数应该设置为 E 。</li>
<li>节点的属性值是对 controller 变量的引用，那么我们应该在指令的 scope 中使用 = 的方式来指定成员值。</li>
<li>最终的效果显示需要进行 DOM 结构的重构，那直接使用 template 就好了。</li>
<li>自定义的标签在最终效果中是多余的，所有 replace 应该设置为 true 。<br>JS 部分的代码：</li>
</ol>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> app = angular.module(<span class="string">'Demo'</span>, [], angular.noop);</div><div class="line"> </div><div class="line"> app.directive(<span class="string">'ysBlock'</span>, <span class="function"><span class="keyword">function</span><span class="params">()</span></span>{</div><div class="line">   <span class="keyword">return</span> {compile: angular.noop,</div><div class="line">           template: <span class="string">'&lt;div style="width: 200px; border: 1px solid black;"&gt;&lt;h1 style="background-color: gray; color: white; font-size: 22px;"&gt;\{\{ title }}&lt;/h1&gt;&lt;div&gt;\{\{ text }}&lt;/div&gt;&lt;/div&gt;'</span>,</div><div class="line">           replace: <span class="keyword">true</span>,</div><div class="line">           scope: {title: <span class="string">'=title'</span>, text: <span class="string">'=text'</span>},</div><div class="line">           restrict: <span class="string">'E'</span>};</div><div class="line"> });</div><div class="line"> </div><div class="line"> app.controller(<span class="string">'TestCtrl'</span>, <span class="function"><span class="keyword">function</span><span class="params">(<span class="variable">$scope</span>)</span></span>{</div><div class="line">   <span class="variable">$scope</span>.title = <span class="string">'标题在这里'</span>;</div><div class="line">   <span class="variable">$scope</span>.text = <span class="string">'内容在这里'</span>;</div><div class="line"> });</div><div class="line"> </div><div class="line"> angular.bootstrap(document, [<span class="string">'Demo'</span>]);</div></pre></td></tr></table></figure>

<p>可以看到，这种简单的组件式指令，只需要作 DOM 结构的变换即可实现，连 compile 函数都不需要写</p>
<h4 id="示例：模板控制语句_for">示例：模板控制语句 for</h4>
<p>这个示例尝试实现一个重复语句，功能同官方的 ngRepeat ，但是使用方式类似于我们通常编程语言中的 for 语句：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="title">div</span> <span class="attribute">ng-controller</span>=<span class="value">"TestCtrl"</span> <span class="attribute">ng-init</span>=<span class="value">"obj_list=[1,2,3,4]; name='name'"</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="title">ul</span>&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="title">for</span> <span class="attribute">o</span> <span class="attribute">in</span> <span class="attribute">obj_list</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="title">li</span>&gt;</span>\{\{ o }}, \{\{ name }}<span class="tag">&lt;/<span class="title">li</span>&gt;</span></div><div class="line">      <span class="tag">&lt;/<span class="title">for</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="title">ul</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="title">button</span> <span class="attribute">ng-click</span>=<span class="value">"obj_list=[1,2]; name='o?'"</span>&gt;</span>修改<span class="tag">&lt;/<span class="title">button</span>&gt;</span></div><div class="line">  <span class="tag">&lt;/<span class="title">div</span>&gt;</span></div></pre></td></tr></table></figure>

<p>同样，我们从上面的使用方式去考虑这个指令的实现：</p>
<ol>
<li>这是一个完全的控制指令，所以单个节点应该只有它一个指令起作用就好了，于是权重要比较高，并且“到此为止”—— priority 设置为 1000 ， terminal 设置为 true 。</li>
<li>使用时的语法问题。事实上浏览器会把 for 节点补充成一个正确的 HTML 结构，即里面的属性都会变成类似 o=”” 这样。我们通过节点的 outerHTML 属性取到字符串并解析取得需要的信息。</li>
<li>我们把 for 节点之间的内容作为一个模板，并且通过循环多次渲染该模板之后把结果填充到合适的位置。</li>
<li>在处理上面的那个模板时，需要不断地创建新 scope 的，并且 o 这个成员需要单独赋值。</li>
</ol>
<p>注意：这里只是简单实现功能。官方的那个 ngRepeat 比较复杂，是做了专门的算法优化的。当然，这里的实现也可以是简单把 DOM 结构变成使用 ngRepeat 的形式 :)</p>
<p>JS 部分代码：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> app = angular.module(<span class="string">'Demo'</span>, [], angular.noop);</div><div class="line"></div><div class="line">app.directive(<span class="string">'for'</span>, <span class="function"><span class="keyword">function</span><span class="params">(<span class="variable">$compile</span>)</span></span>{</div><div class="line">  <span class="keyword">var</span> compile = <span class="function"><span class="keyword">function</span><span class="params">(<span class="variable">$element</span>, <span class="variable">$attrs</span>, <span class="variable">$link</span>)</span></span>{</div><div class="line">    <span class="keyword">var</span> match = <span class="variable">$element</span>[<span class="number">0</span>].outerHTML.match(<span class="string">'&lt;for (.*?)=.*? in=.*? (.*?)=.*?&gt;'</span>);</div><div class="line">    <span class="keyword">if</span>(!match \|\| match.length != <span class="number">3</span>){<span class="keyword">throw</span> Error(<span class="string">'syntax: &lt;for o in obj_list&gt;'</span>)}</div><div class="line">    <span class="keyword">var</span> iter = match[<span class="number">1</span>];</div><div class="line">    <span class="keyword">var</span> <span class="keyword">list</span> = match[<span class="number">2</span>];</div><div class="line">    <span class="keyword">var</span> tpl = <span class="variable">$compile</span>($.trim(<span class="variable">$element</span>.html()));</div><div class="line">    <span class="variable">$element</span>.<span class="keyword">empty</span>();</div><div class="line"></div><div class="line">    <span class="keyword">var</span> link = <span class="function"><span class="keyword">function</span><span class="params">(<span class="variable">$scope</span>, <span class="variable">$ielement</span>, <span class="variable">$iattrs</span>, <span class="variable">$controller</span>)</span></span>{</div><div class="line"></div><div class="line">    <span class="keyword">var</span> new_node = [];</div><div class="line"></div><div class="line">      <span class="variable">$scope</span>.<span class="variable">$watch</span>(<span class="keyword">list</span>, <span class="function"><span class="keyword">function</span><span class="params">(list)</span></span>{</div><div class="line">        angular.<span class="keyword">forEach</span>(new_node, <span class="function"><span class="keyword">function</span><span class="params">(n)</span></span>{n.remove()});</div><div class="line">        <span class="keyword">var</span> scp, inode;</div><div class="line">        <span class="keyword">for</span>(<span class="keyword">var</span> i = <span class="number">0</span>, ii = <span class="keyword">list</span>.length; i &lt; ii; i++){</div><div class="line">          scp = <span class="variable">$scope</span>.<span class="variable">$new</span>();</div><div class="line">          scp[iter] = <span class="keyword">list</span>[i];</div><div class="line">          inode = tpl(scp, angular.noop);</div><div class="line">          <span class="variable">$ielement</span>.before(inode);</div><div class="line">          new_node.push(inode);</div><div class="line">        }</div><div class="line"></div><div class="line">      });</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="keyword">return</span> link;</div><div class="line">  }</div><div class="line">  <span class="keyword">return</span> {compile: compile,</div><div class="line">          priority: <span class="number">1000</span>,</div><div class="line">          terminal: <span class="keyword">true</span>,</div><div class="line">          restrict: <span class="string">'E'</span>};</div><div class="line">});</div><div class="line"></div><div class="line">app.controller(<span class="string">'TestCtrl'</span>, angular.noop);</div><div class="line">angular.bootstrap(document, [<span class="string">'Demo'</span>]);</div></pre></td></tr></table></figure>

<h4 id="示例：模板控制语句_if/else">示例：模板控制语句 if/else</h4>
<p>这个示例是尝试实现：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="title">div</span> <span class="attribute">ng-controller</span>=<span class="value">"TestCtrl"</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="title">if</span> <span class="attribute">true</span>=<span class="value">"a == 1"</span>&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="title">p</span>&gt;</span>判断为真, \{\{ name }}<span class="tag">&lt;/<span class="title">p</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="title">else</span>&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="title">p</span>&gt;</span>判断为假, \{\{ name }}<span class="tag">&lt;/<span class="title">p</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="title">else</span>&gt;</span></div><div class="line">  <span class="tag">&lt;/<span class="title">if</span>&gt;</span></div><div class="line"></div><div class="line">  <span class="tag">&lt;<span class="title">div</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="title">p</span>&gt;</span>a: <span class="tag">&lt;<span class="title">input</span> <span class="attribute">ng-model</span>=<span class="value">"a"</span> /&gt;</span><span class="tag">&lt;/<span class="title">p</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="title">p</span>&gt;</span>name: <span class="tag">&lt;<span class="title">input</span> <span class="attribute">ng-model</span>=<span class="value">"name"</span> /&gt;</span><span class="tag">&lt;/<span class="title">p</span>&gt;</span></div><div class="line">  <span class="tag">&lt;/<span class="title">div</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="title">div</span>&gt;</span></div></pre></td></tr></table></figure>

<p>考虑实现的思路：</p>
<ol>
<li>else 与 if 是两个指令，它们是父子关系。通过 scope 可以联系起来。至于 scope 是在 link 中处理还是 controller 中处理并不重要。</li>
<li>true 属性的条件判断通过 $parse 服务很容易实现。</li>
<li>如果最终效果要去掉 if 节点，我们可以使用注释节点来“占位”。<br>JS 代码：</li>
</ol>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> app = angular.module(<span class="string">'Demo'</span>, [], angular.noop);</div><div class="line"></div><div class="line">app.directive(<span class="string">'if'</span>, <span class="function"><span class="keyword">function</span><span class="params">(<span class="variable">$parse</span>, <span class="variable">$compile</span>)</span></span>{</div><div class="line">  <span class="keyword">var</span> compile = <span class="function"><span class="keyword">function</span><span class="params">(<span class="variable">$element</span>, <span class="variable">$attrs</span>)</span></span>{</div><div class="line">    <span class="keyword">var</span> cond = <span class="variable">$parse</span>(<span class="variable">$attrs</span>.<span class="keyword">true</span>);</div><div class="line">    </div><div class="line">    <span class="keyword">var</span> link = <span class="function"><span class="keyword">function</span><span class="params">(<span class="variable">$scope</span>, <span class="variable">$ielement</span>, <span class="variable">$iattrs</span>, <span class="variable">$controller</span>)</span></span>{</div><div class="line">      <span class="variable">$scope</span>.if_node = <span class="variable">$compile</span>($.trim(<span class="variable">$ielement</span>.html()))(<span class="variable">$scope</span>, angular.noop);</div><div class="line">      <span class="variable">$ielement</span>.<span class="keyword">empty</span>();</div><div class="line">      <span class="keyword">var</span> mark = $(<span class="string">'&lt;!-- IF/ELSE --&gt;'</span>);</div><div class="line">      <span class="variable">$element</span>.before(mark);</div><div class="line">      <span class="variable">$element</span>.remove();</div><div class="line"></div><div class="line">      <span class="variable">$scope</span>.<span class="variable">$watch</span>(<span class="function"><span class="keyword">function</span><span class="params">(scope)</span></span>{</div><div class="line">        <span class="keyword">if</span>(cond(scope)){</div><div class="line">          mark.after(<span class="variable">$scope</span>.if_node);</div><div class="line">          <span class="variable">$scope</span>.else_node.detach();</div><div class="line">        } <span class="keyword">else</span> {</div><div class="line">          <span class="keyword">if</span>(<span class="variable">$scope</span>.else_node !== undefined){</div><div class="line">            mark.after(<span class="variable">$scope</span>.else_node);</div><div class="line">            <span class="variable">$scope</span>.if_node.detach();</div><div class="line">          }</div><div class="line">        }</div><div class="line">      });</div><div class="line">    }</div><div class="line">    <span class="keyword">return</span> link;</div><div class="line">  }</div><div class="line"></div><div class="line">  <span class="keyword">return</span> {compile: compile,</div><div class="line">          scope: <span class="keyword">true</span>,</div><div class="line">          restrict: <span class="string">'E'</span>}</div><div class="line">});</div><div class="line"></div><div class="line">app.directive(<span class="string">'else'</span>, <span class="function"><span class="keyword">function</span><span class="params">(<span class="variable">$compile</span>)</span></span>{</div><div class="line">  <span class="keyword">var</span> compile = <span class="function"><span class="keyword">function</span><span class="params">(<span class="variable">$element</span>, <span class="variable">$attrs</span>)</span></span>{</div><div class="line">    </div><div class="line">    <span class="keyword">var</span> link = <span class="function"><span class="keyword">function</span><span class="params">(<span class="variable">$scope</span>, <span class="variable">$ielement</span>, <span class="variable">$iattrs</span>, <span class="variable">$controller</span>)</span></span>{</div><div class="line">      <span class="variable">$scope</span>.else_node = <span class="variable">$compile</span>($.trim(<span class="variable">$ielement</span>.html()))(<span class="variable">$scope</span>, angular.noop);</div><div class="line">      <span class="variable">$element</span>.remove();</div><div class="line">    }</div><div class="line">    <span class="keyword">return</span> link;</div><div class="line">  }</div><div class="line"></div><div class="line">  <span class="keyword">return</span> {compile: compile,</div><div class="line">          restrict: <span class="string">'E'</span>}</div><div class="line">});</div><div class="line"></div><div class="line">app.controller(<span class="string">'TestCtrl'</span>, <span class="function"><span class="keyword">function</span><span class="params">(<span class="variable">$scope</span>)</span></span>{</div><div class="line">  <span class="variable">$scope</span>.a = <span class="number">1</span>;</div><div class="line">});</div><div class="line"></div><div class="line">angular.bootstrap(document, [<span class="string">'Demo'</span>]);</div></pre></td></tr></table></figure>


<p>代码中注意一点，就是 if_node 在得到之时，就已经是做了变量绑定的了。错误的思路是，在 $watch 中再去不断地得到新的 if_node 。</p>
<h3 id="谢谢！">谢谢！</h3>
<p>转载请注明出处：<a href="http://www.haomou.net/2014/09/12/2014_angularjs_2/" target="_blank" rel="external">http://www.haomou.net/2014/09/12/2014_angularjs_2/</a></p>
<p>有问题请留言。T_T 请叫我皓眸哥 T_T</p>

      
    </div>
    <section id='after_content_widget'><div class="widget" id="widget_after_content_wumiiRelatedItems>">
<script type="text/javascript" id="wumiiRelatedItems"></script>
</div><div class="widget" id="widget_after_content_post_footer_info>">
<div class="panel panel-success">
    <div class="panel-heading" align="center">希望本站内容对您有点用处,有什么疑问或建议请在后面留言评论</div>
    <div align="center" class="panel-body">若无特别注明，本站内容均属原创,转载请注明作者(<a href="">Chale Cao</a>)和出处 <a href="http://haomou.net">皓眸IT</a> ，请勿用于任何商业用途</div>
    <div class="panel-body">本文链接: <a href="/2014/09/12/2014_angularjs_2/">AngularJS笔记-详细使用</a></div>
</div></div></section>
    
    
        <footer id="post-meta">
        <div class="categories hm-article-w hm-article-w-h" itemscope="" itemtype="http://data-vocabulary.org/Breadcrumb" style="display:inline">归类<br/><span class="breadcrumb fa fa-folder"><li><a href="/categories/AngularJS/" itemprop="url"><span itemprop="title" >AngularJS</span></a></li></span></div>    &nbsp;&nbsp; <span class="tags hm-article-w hm-article-w-h1">标签<br/> <a href="/tags/AngularJS/" class="label label-primary" itemprop="url"><span itemprop="title">AngularJS</span></a><a href="/tags/笔记/" class="label label-success" itemprop="url"><span itemprop="title">笔记</span></a></span>    &nbsp;&nbsp; <span class="time">最近更新:<time title="2014-12-28 19:21:40"datetime="2014-12-28 19:21:40"> Dec 28 2014</time></span>    &nbsp;&nbsp; <span class="comment-link">
<a href="http://haomou.net/2014/09/12/2014_angularjs_2/#comments" class="ds-thread-count comment-link" data-thread-key="2014_angularjs_2" data-count-type="comments">暂无评论</a></span>
        </footer>
    
    <div class="clearfix"></div>
  </div>
</div>
</article>


    <section id='after_post_widget'><div class="widget" id="widget_after_post_post_pageNav>">
<ul class="pager">
  
  <li class="previous"><a href="/2014/09/16/2014_jquery_defered/" title="jquery笔记deferred">&larr; jquery笔记deferred</a></li>
  
  
  <li class="next"><a href="/2014/09/09/2014_nodejs_buffer/" title="NodeJS的buffer使用总结">NodeJS的buffer使用总结 &rarr;</a></li>
  
</ul></div></section>    
	<div id="comments"><!-- Duoshuo Comment BEGIN -->

<div class="ds-thread"  data-thread-key="2014_angularjs_2"  data-url="http://haomou.net/2014/09/12/2014_angularjs_2/" data-title="AngularJS笔记-详细使用"></div>
<!-- Duoshuo Comment END -->

</div></div><!--wapper-->
       </div><!-- ID main-col END -->
       <aside id="sidebar" class="alignright col-sx-6 col-sm-4 col-md-3 col-lg-3">
<div id="widget_myself" class="widget hm-left-widget" style="clear:both">
    <img alt="皓眸GEEK" src="/images/hm.jpg" width="100" height="120"  style="border-radius: 5px;margin-right: 5px;float:left;"/>
<div style="color: #428bca;text-align: center;font-size: 18px;">曹欢欢(chale)</div>2014年毕业于中国科学技术大学，硕士研究生，目前在大武汉知名外企公司上班。<br/>喜欢美貌与智慧并存的女生，而我就是英雄与侠义的化身哈，等你来...吼吼...喜欢就写信给我喽，请叫我皓眸哥(^_^)
<br/>擅长：NodeJS，JAVA，PHP，WebGL，WebRTC，PS ...
<br/><span style="color: #fb6580;">Mail To: </span>chh1990@mail.ustc.edu.cn
<br/><span style="color: #fb6580;">QQ：</span>807991555（chale）
<br/><span style="color: #fb6580;">APP敏捷开发交流群：</span>345413787
<br/><span style="color: #fb6580;">比较讨厌阿里、百度、腾讯、网易、360等技术人员，禁止这些所谓的技术牛人查看本博客所有内容，请自觉离开！</span></div>

<div id="widget_recent_posts" class="widget hm-left-widget" style="clear:both">
  <div class="panel-heading">最近文章</div>  <div data-src='recent_posts' class='ajax_widgets'>正在加载...</div></div>

<div id="widget_search" class="widget hm-left-widget" style="clear:both">
  <div class="panel-heading">一般人我不告诉他？</div>  <div id="haomou_ad">
<a target="_blank" href="http://2.taobao.com/item.htm?id=43864052133&spm=686.1000925.0.0.5J1R6E">
<img src="/images/book.png" title="皓眸IT-我的书" alt="APP敏捷开发王道-我的新书" />
</a>
<br/>
<p style="text-align:center;"><a target="_blank" href="http://2.taobao.com/item.htm?id=43864052133&spm=686.1000925.0.0.5J1R6E">附整套项目代码，只要<b style="color:red;">9.9</b>元</a></p>
<p style="text-align:center;">APP敏捷开发交流群：<b style="color:red;">345413787</b></p>
</div></div>

</aside>
       <div class="clearfix"></div>
     </div><!-- row END -->
  </div>
  <footer id="footer" class="container">
  <div class="panel panel-info">
  <section id='footer_widget'></section>  <div class="panel-footer">
  <div id="site-info">
    <span class='author'>
  
  &copy; 2014-2015 Chale Cao
  
    &nbsp;&nbsp;</span>
  <a href='http://www.miibeian.gov.cn/'>苏ICP备13018740号-6</a></span>
  <span id='analytics-51la'></span><span id='analytics-google'></span><span id='analytics-cnzz'>
<script type="text/javascript">var cnzz_protocol = (("https:" == document.location.protocol) ? " https://" : " http://");document.write(unescape("%3Cspan id='cnzz_stat_icon_5849006'%3E%3C/span%3E%3Cscript src='" + cnzz_protocol + "s17.cnzz.com/stat.php%3Fid%3D5849006%26show%3Dpic' type='text/javascript'%3E%3C/script%3E"));</script>
</span><span id='analytics-baidu'></span>  </div>
  <div id="copyright">Blog powered by <a href='http://www.haomou.net/'  title="本站由hexo V2.8.3 生成"><strong>hexo</strong></a> Theme <strong><a href='http://www.haomou.net/'>Chale V1.0</a></strong><span class="pull-right"> 更新时间: <em>2014-12-28 19:21:40</em></span></div>
</div>
<div class="clearfix"></div>
  </div>
  </footer>
  
        <script src="http://cdn.bootcss.com/jquery/1.10.2/jquery.min.js"></script>        
        <script src="http://cdn.bootcss.com/twitter-bootstrap/3.1.0/js/bootstrap.min.js"></script>        
                
        <script src="http://cdn.bootcss.com/prettify/r298/prettify.min.js"></script>    <script type="text/javascript">
   var lang=["bsh", "c", "cc", "cpp", "cs", "csh", "cyc", "cv", "htm", "html",
    "java", "js", "m", "mxml", "perl", "pl", "pm", "py", "rb", "sh",
    "xhtml", "xml", "xsl"];
   var pretty_base='';
   $('script').each(function(){
	var c = $(this).attr('src');
	if (!c)
	    return;
	if (c.match(/(\/)?prettify(\.min)?\.js/i))
	{
	    var index = c.lastIndexOf('/');
	    if (index != -1)
		pretty_base = c.substr(0,index + 1);
	    return false;
	}
   })
   $('pre code').each(function(){
	var c = $(this).attr('class')
	if (!c)
	    return;
	c = c.match(/\s?(lang\-\w+)/i);
	if (c && lang.indexOf(c[1]) == -1)
	{
	    lang.push(c[1]);
	    $.getScript(pretty_base + c[1] + '.min.js');
	}
   })

    $(window).load(function(){
       $("pre").addClass("prettyprint");
       prettyPrint();
    })
</script>    
            <script type="text/javascript">
var duoshuoQuery = {short_name:"haomou"};
_js2load.push({src:'http://static.duoshuo.com/embed.js',charset:'UTF-8'});
</script>
    
            <!--wumii_relatedItems-->

<script type="text/javascript">
    var wumiiPermaLink = "http://haomou.net/2014/09/12/2014_angularjs_2/";
    var wumiiTitle = "AngularJS笔记-详细使用";
    var wumiiTags = "AngularJS,笔记";
    var wumiiCategories = ["AngularJS"];
    var wumiiSitePrefix = "http://haomou.net";
    var wumiiParams = "&num=5&mode=3&pf=JAVASCRIPT";
    _js2load.push({src:'http://widget.wumii.cn/ext/relatedItemsWidget'});
</script>
<a href="http://www.wumii.com/widget/relatedItems" style="border:0;">
<img src="http://static.wumii.cn/images/pixel.png" alt="无觅关联推荐，快速提升流量" style="border:0;padding:0;margin:0;" />
</a>
    
        <script src="http://cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.min.js"></script>    <script type="text/javascript">
(function($){
  $('.entry').each(function(i){
    $(this).find('img').each(function(){
      var alt = this.alt;

      $(this).wrap('<a href="' + this.src + '" title="' + alt + '" class="fancybox" rel="fancybox' + i + '" />').wrap('<div class="img_block"></div>');
     
      if(alt){$(this).after('<span class="caption">' + alt + '</span>')};
    });
  });

  $('.fancybox').fancybox();
})(jQuery);
</script>    
        <script src="http://cdn.bootcss.com/mathjax/2.3/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>    <script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    tex2jax: {
      skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code'],
      inlineMath: [ ['$','$'], ["\\(","\\)"] ],
      processEscapes: true
    }
  });
  MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
      all[i].SourceElement().parentNode.className += ' has-jax';
    }
  });
</script>
    
<script src="/js/nprogress.js" type="text/javascript"></script>

<script src="/js/chenall.js" type="text/javascript"></script>


  </body>
</html>
